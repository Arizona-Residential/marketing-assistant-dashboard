<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Private AI Marketing Assistant — Rosario</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
    :root{
      --bg:#0b0f12;
      --bg2:#15171a;
      --card:#121a27;
      --muted:#9aa4b2;
      --text:#e8eef7;
      --line:#1d2a3b;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: "SF Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "San Francisco", system-ui, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --panel: rgba(14, 20, 30, .78);
      --glass-opacity: .022;
      --glass-strong-opacity: .045;
      --glass-border-opacity: .16;
      --glass-highlight-opacity: .35;
      --glass: rgba(255,255,255,var(--glass-opacity));
      --glass-strong: rgba(255,255,255,var(--glass-strong-opacity));
      --blur: 18px;
      --glow: 0 24px 60px rgba(0,0,0,.45);
      --bg-spot: rgba(255,170,102,.16);
      --bg-spot2: rgba(255,214,170,.14);
      --bg-ambient: rgba(255,255,255,.04);
      --noise-opacity:.04;
      --blob1: rgba(255,170,102,.20);
      --blob2: rgba(255,214,170,.18);
      --blob3: rgba(214,123,90,.14);
      --bg-sheen: rgba(255,220,180,.08);
      --glass-border: rgba(255,255,255,var(--glass-border-opacity));
      --glass-border-light: rgba(15,23,42,.12);
      --glass-highlight: rgba(255,255,255,var(--glass-highlight-opacity));
      --section-title: 14px;
      --section-text: 12px;
    }
    body.light{
      --bg:#f2ebe3;
      --bg2:#e9ddd1;
      --card:#ffffff;
      --muted:#4a5565;
      --text:#0b1220;
      --line:#cfd7e3;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --panel: rgba(255,255,255,.90);
      --glass-opacity: .22;
      --glass-strong-opacity: .38;
      --glass-border-opacity: .12;
      --glass-highlight-opacity: .65;
      --glass: rgba(255,255,255,var(--glass-opacity));
      --glass-strong: rgba(255,255,255,var(--glass-strong-opacity));
      --bg-spot: rgba(255,170,102,.14);
      --bg-spot2: rgba(255,214,170,.12);
      --bg-ambient: rgba(120,95,70,.06);
      --shadow: 0 12px 30px rgba(15,23,42,.10);
      --glow: 0 20px 50px rgba(15,23,42,.10);
      --noise-opacity:.05;
      --blob1: rgba(255,170,102,.20);
      --blob2: rgba(255,214,170,.18);
      --blob3: rgba(214,123,90,.16);
      --bg-sheen: rgba(255,220,180,.35);
      --glass-border: rgba(15,23,42,var(--glass-border-opacity));
      --glass-highlight: rgba(255,255,255,.65);
    }
    @media (max-width: 720px){
      body{ --blur: 10px; }
      :root{
        --glow: 0 16px 40px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--bg-spot), transparent 55%),
        radial-gradient(900px 500px at 80% -20%, var(--bg-spot2), transparent 55%),
        radial-gradient(700px 500px at 40% 80%, var(--bg-ambient), transparent 60%),
        radial-gradient(900px 700px at 10% 90%, var(--bg-sheen), transparent 65%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color:var(--text);
    }
    body::before{
      content:"";
      position:fixed; inset:-10%;
      background:
        radial-gradient(420px 320px at 18% 12%, var(--blob1), transparent 60%),
        radial-gradient(520px 360px at 78% 18%, var(--blob2), transparent 60%),
        radial-gradient(560px 420px at 30% 80%, var(--blob3), transparent 60%);
      filter: blur(16px);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.6'/%3E%3C/svg%3E");
      opacity: var(--noise-opacity, .04);
      mix-blend-mode: soft-light;
      pointer-events:none;
      z-index:-1;
    }
    body.dragging-active{user-select:none}
    a{color:var(--accent)}
    .wrap{max-width:100%;margin:0;padding:18px}
    html,body{min-height:100%}
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--glass-border);border-radius:var(--radius);
      background:var(--glass-strong);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--glow);
      position:sticky; top:14px; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 80%, #fff 20%), color-mix(in srgb, var(--accent2) 80%, #fff 20%));
      box-shadow: 0 10px 24px rgba(125,211,252,.12);
      display:grid;place-items:center;overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand p{margin:2px 0 0 0;color:var(--muted);font-size:12px}
    .topbar-actions{display:flex;align-items:center;gap:12px}
    .profile{
      display:flex;align-items:center;gap:10px;border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:6px 10px;border-radius:999px;
    }
    .avatar{
      width:28px;height:28px;border-radius:50%;
      background: linear-gradient(135deg, rgba(125,211,252,.4), rgba(167,139,250,.4));
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .profile .meta{font-size:12px;color:var(--muted)}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      cursor:pointer;
      border:1px solid var(--glass-border);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      transition:.2s transform, .2s opacity, .2s border-color, .2s box-shadow;
    }
    button:hover{
      transform:translateY(-1px);
      border-color: rgba(255,255,255,.45);
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    button.primary{
      border-color: rgba(255,255,255,.45);
      background: rgba(255,255,255,.04);
    }
    button.danger{border-color: rgba(251,113,133,.55)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .topbar{position:relative; top:0}
    }
    .card{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:var(--radius);
      box-shadow: var(--glow);
      padding:16px;
      position:relative;
      height:100%;
      overflow:auto;
      min-height:0;
      will-change: transform;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      border-radius:inherit;
      pointer-events:none;
      background: linear-gradient(140deg, var(--glass-highlight), rgba(255,255,255,0) 45%);
      opacity:.6;
    }
    .card::after{
      content:"";
      position:absolute;
      left:14px; right:14px; top:10px;
      height:26px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0));
      opacity:.35;
      pointer-events:none;
    }
    .card h2{font-size:var(--section-title)}
    .card .sub, .card label, .card input, .card select, .card textarea, .card .item, .card .pill, .card .mini{
      font-size:var(--section-text);
    }
    .sections{
      display:grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap:16px;
      grid-auto-rows: 24px;
      grid-auto-flow: row dense;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .sections{grid-template-columns:1fr}
    }
    @media (max-width: 720px){
      .wrap{padding:14px}
      .topbar{flex-direction:column;align-items:flex-start;gap:10px}
      .topbar-actions{width:100%;justify-content:space-between;flex-wrap:wrap}
      .btnrow{justify-content:flex-start}
      .profile{order:2}
      .brand h1{font-size:14px}
      .brand p{font-size:11px}
      .row, .row3, .split{grid-template-columns:1fr}
      .sections{gap:12px}
      .card{padding:14px}
      .drag-handle, .resize-handle{display:none}
      .modal .panel{width:94vw;max-height:90vh}
      body::after{opacity:.025}
    }
    @media (max-width: 480px){
      .topbar{padding:12px}
      button{padding:9px 10px}
      .kpi{grid-template-columns:1fr}
    }
    .section{
      position:relative;
      min-height:0;
    }
    .section.drag-over .card{outline:none}
    .section.drag-placeholder{
      border:1px dashed rgba(255,255,255,.12);
      border-radius:var(--radius);
      min-height:140px;
      background: rgba(255,255,255,.03);
    }
    .drag-handle{display:none}
    .resize-handle{
      position:absolute;
      width:18px;height:18px;
      right:10px;bottom:10px;
      border:1px solid var(--line);
      border-radius:6px;
      background: rgba(9,14,22,.6);
      cursor:se-resize;
      z-index:2;
    }
    .layout-locked .drag-handle,
    .layout-locked .resize-handle{display:none}
    .section.hidden{display:none}
    .modal{
      position:fixed; inset:0;
      background: rgba(4,6,10,.65);
      display:none; align-items:center; justify-content:center;
      z-index:50;
    }
    .modal.open{display:flex}
    .modal .panel{
      width:min(920px, 94vw);
      max-height:86vh;
      overflow:auto;
      border:1px solid var(--glass-border);
      background: var(--glass-strong);
      backdrop-filter: blur(var(--blur));
      border-radius:20px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal .panel h2{margin-top:0}
    .modal .panel{
      width:min(1180px, 96vw);
      max-height:90vh;
      padding:0;
      overflow:hidden;
    }
    .settings-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:sticky;
      top:0;
      z-index:4;
      padding:14px 18px;
      border-bottom:1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(8,12,18,.92), rgba(8,12,18,.82));
      backdrop-filter: blur(calc(var(--blur) + 2px));
    }
    .settings-head .title-wrap .kicker{
      margin:0 0 4px 0;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .settings-head .title-wrap h2{margin:0 0 4px 0}
    .settings-head .title-wrap p{margin:0;color:var(--muted);font-size:12px}
    .settings-tools{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:300px;
      justify-content:flex-end;
    }
    .settings-search{
      width:min(320px, 46vw);
      margin:0;
    }
    .settings-shell{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:14px;
      align-items:start;
      padding:14px;
      height:calc(90vh - 74px);
      overflow:hidden;
    }
    .settings-nav{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      height:100%;
      min-height:0;
      overflow:auto;
    }
    .settings-account{
      border:1px solid var(--glass-border);
      background: var(--glass-strong);
      border-radius:14px;
      padding:10px;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .settings-account .avatar{
      width:36px;
      height:36px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--glass-border);
      flex:0 0 auto;
    }
    .settings-account .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .settings-account .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .settings-account .meta strong{
      font-size:12px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .settings-account .meta span{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .settings-nav .sub{
      margin:4px 4px 6px 4px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .settings-nav a{
      border:1px solid transparent;
      border-radius:12px;
      padding:9px 10px;
      font-size:12px;
      color:var(--muted);
      text-decoration:none;
      display:flex;
      align-items:center;
      gap:8px;
      transition: background .16s ease, border-color .16s ease, color .16s ease;
    }
    .settings-nav a::before{
      content:"";
      width:6px;
      height:6px;
      border-radius:999px;
      border:1px solid var(--glass-border);
      background:transparent;
      flex:0 0 auto;
    }
    .settings-nav a:hover,
    .settings-nav a.active{
      color:var(--text);
      background: rgba(255,255,255,.08);
      border-color: var(--glass-border);
    }
    .settings-nav a.active::before{
      background: color-mix(in srgb, var(--accent) 76%, #fff 24%);
      border-color: color-mix(in srgb, var(--accent) 62%, #fff 38%);
    }
    .settings-main{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      overflow:auto;
      padding-right:2px;
    }
    .settings-main-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    .settings-card{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:16px;
      padding:13px;
      transition: border-color .16s ease, transform .16s ease;
    }
    .settings-card:hover{
      border-color: rgba(255,255,255,.24);
      transform: translateY(-1px);
    }
    .settings-card.full{
      grid-column: 1 / -1;
    }
    .settings-card h3{
      margin:0 0 6px 0;
      font-size:14px;
    }
    .settings-card .sub{
      margin-bottom:10px;
      font-size:12px;
    }
    .settings-grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .settings-shell{
        grid-template-columns:1fr;
        height:auto;
      }
      .settings-nav{
        height:auto;
        overflow:visible;
      }
      .settings-tools{
        min-width:0;
      }
      .settings-search{
        width:180px;
      }
      .settings-main{
        overflow:visible;
      }
      .settings-main-grid{
        grid-template-columns:1fr;
      }
      .settings-card.full{
        grid-column:auto;
      }
    }
    .toggle{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:8px 10px;border-radius:12px;
      font-size:12px;color:var(--muted);
    }
    .toggle input{margin:0}
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .sub{color:var(--muted);font-size:12px;margin:0 0 14px 0;line-height:1.4}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;flex-direction:column;gap:8px;margin-bottom:12px;
    }
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      border:1px solid var(--glass-border);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(var(--blur));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
    }
    .reduce-motion *{
      transition:none !important;
      animation:none !important;
      scroll-behavior:auto !important;
    }
    textarea{min-height:86px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color: rgba(125,211,252,.55)}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      color: var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--muted)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .kpi{
      display:grid;grid-template-columns: repeat(3, 1fr);
      gap:14px;margin-top:12px;
    }
    .kpi + .out{margin-top:14px}
    @media (max-width: 520px){
      .kpi{grid-template-columns:1fr}
      .row, .row3{grid-template-columns:1fr}
    }
    .kpi .box{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:16px;
      padding:14px;
    }
    .kpi .big{font-size:20px;font-weight:800;letter-spacing:.2px}
    .kpi .small{font-size:12px;color:var(--muted);margin-top:2px}
    .split{
      display:grid;grid-template-columns: 1fr 1fr; gap:10px;
    }
    .mono{font-family:var(--mono)}
    .out{
      white-space:pre-wrap;
      border:1px dashed rgba(125,211,252,.35);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:14px;border-radius:16px;
      min-height:120px;
      line-height:1.45;
      font-size:var(--section-text);
    }
    .mini{
      font-size:12px;color:var(--muted);line-height:1.5;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:10px 12px;border-radius:16px;
    }
    .list{
      display:flex;flex-direction:column;gap:12px;margin-top:14px;
    }
    .item{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:16px;
      padding:14px;
    }
    .item .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:12px}
    .tag{
      font-size:12px;
      border:1px solid rgba(167,139,250,.35);
      padding:4px 8px;border-radius:999px;color:rgba(167,139,250,.95)
    }
    .tag2{
      font-size:12px;
      border:1px solid rgba(125,211,252,.35);
      padding:4px 8px;border-radius:999px;color:rgba(125,211,252,.95)
    }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none !important}
    .login{
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:22px;
    }
    .login .panel{
      max-width:520px;width:100%;
      border:1px solid var(--glass-border);
      background: var(--glass-strong);
      backdrop-filter: blur(var(--blur));
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .login-logo{
      width:96px;height:96px;border-radius:999px;
      margin:0 auto 12px auto;
      background: linear-gradient(135deg, rgba(125,211,252,.35), rgba(167,139,250,.35));
      display:grid;place-items:center;overflow:hidden;
      border:1px solid rgba(125,211,252,.3);
    }
    .login-logo img{width:100%;height:100%;object-fit:cover}
    .login h1{margin:0 0 6px 0;font-size:18px}
    .login p{margin:0 0 14px 0;color:var(--muted);font-size:12px;line-height:1.5}
    .notice{
      font-size:12px;color:var(--muted);line-height:1.5;
      border:1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.08);
      padding:10px 12px;border-radius:16px;
    }
    .badge{
      font-size:11px;border:1px solid rgba(125,211,252,.4);
      padding:3px 8px;border-radius:999px;color:rgba(125,211,252,.95)
    }
    .tiktok-badge{
      display:inline-flex;align-items:center;gap:6px;
      border-color: rgba(148,163,184,.45);
      color: var(--muted);
    }
    .tiktok-badge::before{
      content:"";
      width:6px;height:6px;border-radius:999px;
      background: var(--muted);
      box-shadow: 0 0 6px rgba(148,163,184,.4);
    }
    .tiktok-badge.connected{
      border-color: rgba(52,211,153,.6);
      color: var(--good);
    }
    .tiktok-badge.connected::before{
      background: var(--good);
      box-shadow: 0 0 8px rgba(52,211,153,.6);
    }
    .tiktok-badge.needs{
      border-color: rgba(251,191,36,.6);
      color: var(--warn);
    }
    .tiktok-badge.needs::before{
      background: var(--warn);
      box-shadow: 0 0 8px rgba(251,191,36,.5);
    }
    .tiktok-badge.error{
      border-color: rgba(251,113,133,.6);
      color: var(--bad);
    }
    .tiktok-badge.error::before{
      background: var(--bad);
      box-shadow: 0 0 8px rgba(251,113,133,.5);
    }
    .social-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .social-item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:10px;border-radius:14px;font-size:12px;color:var(--muted);
    }
    .app-shell{display:flex;gap:104px;align-items:flex-start}
    .sidebar{
      position:sticky;top:18px;align-self:flex-start;
      width:74px;min-width:74px;
      flex:0 0 74px;
      padding:12px 8px;border-radius:22px;
      border:1px solid var(--glass-border);
      background:var(--glass-strong);
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;gap:14px;
      height:calc(100vh - 36px);
      transition: background .18s ease;
      z-index:4;
      overflow:visible;
    }
    .sidebar:hover{
      width:74px;min-width:74px;
    }
    .sidebar .sb-profile{display:flex;align-items:center;gap:10px;padding-left:4px}
    .sidebar .sb-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sidebar .sb-avatar{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--glass-border);
      background:var(--glass);
      overflow:hidden;display:grid;place-items:center;
    }
    .sidebar .sb-profile{
      justify-content:center;
      padding-left:0;
    }
    .sidebar:hover .sb-profile{
      justify-content:flex-start;
      padding-left:4px;
    }
    .sidebar .sb-avatar{
      width:40px;height:40px;
    }
    .sidebar .sb-avatar img{width:100%;height:100%;object-fit:cover}
    .sidebar .sb-title{font-size:12px;color:var(--muted)}
    .sidebar .sb-name{font-size:13px;font-weight:600}
    .sidebar .nav{display:flex;flex-direction:column;gap:8px;height:100%}
    .sidebar .nav-main{display:flex;flex-direction:column;gap:8px;align-items:center}
    .sidebar .nav-bottom{margin-top:auto;display:flex;flex-direction:column;gap:8px}
    .sidebar .nav button{
      width:42px;text-align:left;border-radius:14px;
      padding:0;font-size:12px;display:flex;align-items:center;gap:10px;
      position:relative;
      color: var(--muted);
      height:40px;
      overflow:hidden;
      justify-content:center;
      align-self:center;
      transition: background .15s ease, color .15s ease, border-color .15s ease, width .2s ease, padding .2s ease;
    }
    .sidebar:hover .nav-main{
      align-items:flex-start;
    }
    .sidebar:hover .nav button{
      width:186px;
      justify-content:flex-start;
      align-self:flex-start;
      padding:8px 10px;
      height:38px;
    }
    .sidebar .nav button.active{
      border-color: rgba(251,191,36,.55);
      color: var(--text);
      background: rgba(251,191,36,.08);
    }
    .sidebar .nav button:hover{
      color: var(--text);
      background: rgba(255,255,255,.05);
    }
    .nav svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-linecap:round;stroke-linejoin:round}
    .nav .icon{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center}
    .nav .icon{color:var(--text)}
    .nav .label{white-space:nowrap}
    .sidebar .sb-name,
    .sidebar .sb-title,
    .sidebar .nav .label,
    .sidebar .subhead{
      opacity:0;
      max-width:0;
      overflow:hidden;
      transform:none;
      transition: opacity .12s ease, max-width .14s ease;
      pointer-events:none;
    }
    .sidebar:hover .sb-name,
    .sidebar:hover .sb-title,
    .sidebar:hover .nav .label,
    .sidebar:hover .subhead{
      opacity:1;
      max-width:150px;
      pointer-events:auto;
    }
    .sidebar .sb-actions{
      opacity:0;
      max-height:0;
      overflow:hidden;
      pointer-events:none;
      transition: opacity .2s ease, max-height .24s ease;
    }
    .sidebar:hover .sb-actions{
      opacity:1;
      max-height:220px;
      pointer-events:auto;
    }
    .sidebar .nav button::after{display:none}
    .sidebar .nav .subhead{
      font-size:10px;text-transform:uppercase;letter-spacing:.14em;
      color:var(--muted);margin:8px 0 4px 6px;
    }
    .sidebar .sb-actions{display:flex;flex-direction:column;gap:8px;align-items:center}
    .sidebar .sb-actions button{width:42px}
    .sidebar:hover .sb-actions{align-items:flex-start}
    .sidebar:hover .sb-actions button{width:186px}
    .main{flex:1;min-width:0;min-height:calc(100vh - 36px)}
    .page{min-height:calc(100vh - 36px)}
    .page{display:none}
    .page.active{display:block}
    .page-header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--glass-border);border-radius:var(--radius);
      background:var(--glass-strong);backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
    }
    .page-header .title{font-size:16px;font-weight:600}
    .page-header .subtitle{font-size:12px;color:var(--muted)}
    .widget-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--widget-gap,16px);margin-top:16px;margin-bottom:18px}
    .widget{grid-column:span 6; padding:14px;border-radius:20px;
      border:1px solid var(--glass-border);background:var(--glass-strong);
      backdrop-filter: blur(var(--blur));box-shadow: var(--shadow);
      position:relative;
      content-visibility:auto;
      contain-intrinsic-size: 260px;
      contain: layout paint style;
    }
    .widget{cursor:grab}
    .widget:active{cursor:grabbing}
    .widget .resize-handle{
      position:absolute;right:8px;bottom:8px;
      width:18px;height:18px;border-radius:6px;
      border:1px solid var(--glass-border);
      background:var(--glass);
      cursor:nwse-resize;
      z-index:3;
    }
    .widget.drag-placeholder{
      border:1px dashed rgba(255,255,255,.12);
      border-radius:20px;
      background: rgba(255,255,255,.03);
    }
    .widget.dragging{
      opacity:.75;
      transform:scale(1.02);
      box-shadow: 0 26px 60px rgba(0,0,0,.45);
    }
    body.dragging-active .widget,
    body.dragging-active .settings-card,
    body.dragging-active .page-header{
      backdrop-filter:none !important;
      box-shadow:none !important;
    }
    .widget.small{grid-column:span 4}
    .widget.large{grid-column:span 8}
    .widget.full{grid-column:span 12}
    .widget h3{margin:0 0 6px 0;font-size:13px}
    .widget p{margin:0;color:var(--muted);font-size:12px}
    .widget-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .widget-item{
      border:1px solid var(--glass-border);background:var(--glass);
      padding:10px;border-radius:14px;font-size:12px;
    }
    .widget-row{display:flex;gap:10px;align-items:center}
    .widget-row .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--glass-border);font-size:11px}
    .calendar-mini-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin:0 0 8px 0;
    }
    .calendar-mini-head .month{
      font-size:12px;
      font-weight:600;
      color:var(--text);
    }
    .calendar-mini-head .pillrow button{
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
      min-width:30px;
    }
    .calendar-mini-weekdays{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
      margin-bottom:6px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .calendar-mini-weekdays span{
      text-align:center;
      opacity:.85;
    }
    .calendar-mini-month{
      border:1px solid var(--glass-border);
      background: var(--glass);
      border-radius:14px;
      padding:10px;
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    .calendar-mini-month .d{
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      border:1px solid transparent;
      cursor:pointer;
      transition: background .16s ease, border-color .16s ease, color .16s ease;
    }
    .calendar-mini-month .d:hover{
      background: rgba(255,255,255,.08);
      color:var(--text);
    }
    .calendar-mini-month .d.in-week{
      border:1px solid rgba(251,191,36,.45);
      color:var(--text);
      background: rgba(251,191,36,.12);
    }
    .calendar-mini-month .d.selected{
      border-color: color-mix(in srgb, var(--accent) 68%, #ffffff 32%);
      background: color-mix(in srgb, var(--accent) 26%, transparent);
      color:var(--text);
    }
    .calendar-filter-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .calendar-filter-chip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--glass-border);
      background:var(--glass);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
    }
    .calendar-filter-chip .left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .calendar-filter-chip .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.45);
      flex:0 0 auto;
    }
    .calendar-filter-chip label{
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
      cursor:pointer;
      min-width:0;
      color:var(--text);
    }
    .calendar-filter-chip .count{
      color:var(--muted);
      font-size:11px;
      flex:0 0 auto;
    }
    .calendar-quickstats{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    .calendar-quickstats .widget-item strong{
      display:block;
      font-size:16px;
      line-height:1.2;
      margin-bottom:2px;
      color:var(--text);
    }
    .calendar-board{
      margin-top:8px;
      border:1px solid var(--glass-border);
      border-radius:14px;
      background: var(--glass);
      display:grid;
      grid-template-columns:58px 1fr;
      overflow:hidden;
      min-height:520px;
    }
    .calendar-time-col{
      border-right:1px solid var(--glass-border);
      font-size:11px;
      color:var(--muted);
    }
    .calendar-time-col .t{
      height:60px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding-top:2px;
    }
    .calendar-week-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(120px,1fr));
      min-height:520px;
    }
    .calendar-week-grid.single-day{
      grid-template-columns:minmax(260px,1fr);
    }
    .calendar-day-col{
      position:relative;
      border-right:1px solid rgba(255,255,255,.08);
    }
    .calendar-day-col:last-child{border-right:none}
    .calendar-day-head{
      height:44px;
      border-bottom:1px solid var(--glass-border);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:var(--muted);
      gap:2px;
    }
    .calendar-day-head strong{font-size:18px;color:var(--text);line-height:1}
    .calendar-day-body{
      position:relative;
      height:calc(100% - 44px);
      min-height:476px;
      background-image:repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent 59px,
        rgba(255,255,255,.08) 59px,
        rgba(255,255,255,.08) 60px
      );
    }
    .cal-event{
      position:absolute;
      left:6px;
      right:6px;
      border-radius:10px;
      padding:6px 7px;
      border:1px solid rgba(255,255,255,.2);
      font-size:11px;
      color:#f8fafc;
      overflow:hidden;
      cursor:pointer;
      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
    }
    .cal-event:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 8px 16px rgba(15,23,42,.24);
    }
    .cal-event.status-done{
      opacity:.68;
      text-decoration:line-through;
    }
    .cal-event.status-canceled{
      opacity:.5;
    }
    .cal-event .title{
      font-weight:600;
      line-height:1.2;
      margin-bottom:4px;
    }
    .cal-event .time{
      opacity:.9;
      font-size:10px;
    }
    .cal-event .meta{
      margin-top:4px;
      font-size:10px;
      opacity:.92;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .event-queue-item .head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .event-queue-item .badges{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      margin-top:5px;
    }
    .event-queue-item .badges .pill{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--glass-border);
      background: var(--glass);
    }
    .event-queue-item .actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:9px;
    }
    .event-queue-item .actions button{
      font-size:11px;
      padding:6px 9px;
      border-radius:10px;
    }
    @media (max-width: 980px){
      .app-shell{flex-direction:column;gap:16px}
      .sidebar{width:100%;min-width:0;position:relative;padding:16px 12px}
      .sidebar:hover{width:100%;min-width:0}
      .sidebar .nav-main{align-items:flex-start}
      .sidebar .nav button{
        width:100%;
        justify-content:flex-start;
        align-self:stretch;
        padding:8px 10px;
        height:38px;
      }
      .sidebar .sb-actions{align-items:flex-start}
      .sidebar .sb-actions button{width:100%}
      .sidebar .sb-name,
      .sidebar .sb-title,
      .sidebar .nav .label,
      .sidebar .subhead{
        opacity:1;max-width:180px;transform:none;pointer-events:auto;
      }
      .sidebar .sb-actions{opacity:1;max-height:220px;pointer-events:auto}
      .sidebar:not(:hover) .nav button{justify-content:flex-start;padding:8px 10px}
    }
    @media (hover: none){
      .sidebar{width:230px;min-width:230px;flex:0 0 230px;padding:16px 12px}
      .sidebar .nav-main{align-items:flex-start}
      .sidebar .nav button{
        width:100%;
        justify-content:flex-start;
        align-self:stretch;
        padding:8px 10px;
        height:38px;
      }
      .sidebar .sb-actions{align-items:flex-start}
      .sidebar .sb-actions button{width:100%}
      .sidebar .sb-name,
      .sidebar .sb-title,
      .sidebar .nav .label,
      .sidebar .subhead{
        opacity:1;max-width:180px;transform:none;pointer-events:auto;
      }
      .sidebar .sb-actions{opacity:1;max-height:220px;pointer-events:auto}
    }
  </style>
</head>
<body>
  <!-- LOGIN GATE -->
  <div id="loginView" class="login">
    <div class="panel">
      <div class="login-logo" id="loginLogo">
        <img id="loginLogoImg" alt="Brand logo" class="hidden"/>
      </div>
      <h1>Private AI Marketing Assistant</h1>
      <p>Local-only dashboard for tracking, monitoring, and generating TikTok/Instagram content ideas for your business.</p>
      <div class="notice">
        Employee login is now account-based. Use your assigned username/password, or create an account if this is first setup.
      </div>
      <div class="hr"></div>
      <div class="field">
        <label>Username</label>
        <input id="loginUsername" type="text" placeholder="e.g. rosario"/>
      </div>
      <div class="field">
        <label>Enter password</label>
        <input id="pw" type="password" placeholder="Your password"/>
      </div>
      <button class="primary" onclick="login()">Unlock</button>
      <div class="hr"></div>
      <h2 style="margin-bottom:6px">Create Employee Account</h2>
      <div class="field">
        <label>Display Name</label>
        <input id="regDisplayName" type="text" placeholder="Rosario"/>
      </div>
      <div class="field">
        <label>Username</label>
        <input id="regUsername" type="text" placeholder="rosario"/>
      </div>
      <div class="field">
        <label>Password</label>
        <input id="regPassword" type="password" placeholder="At least 8 characters"/>
      </div>
      <button onclick="registerUser()">Create Account</button>
      <p class="sub" id="loginStatus" style="margin-top:12px">Use strong passwords and only share with approved employees.</p>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div class="wrap">
      <div class="app-shell">
        <aside class="sidebar" id="sidebar">
          <div class="sb-top">
            <div class="sb-profile">
            <div class="sb-avatar" id="sidebarLogo">
              <img id="sidebarLogoImg" alt="Brand logo" class="hidden"/>
            </div>
            <div>
              <div class="sb-name" id="sidebarTitle">AI Marketing Assistant</div>
              <div class="sb-title" id="sidebarTagline">Dashboard</div>
              <div class="sb-title" id="sidebarUser"></div>
            </div>
          </div>
          </div>
          <div class="nav">
            <div class="nav-main">
            <div class="subhead">Main</div>
            <button data-page="welcome" data-label="Daily Brief">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <path d="M12 3l3 6 6 .9-4.5 4.3 1 6-5.5-3-5.5 3 1-6L3 9.9 9 9z"/>
                </svg>
              </span>
              <span class="label">Daily Brief</span>
            </button>
            <button data-page="company" data-label="Operations" class="active">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <path d="M4 20h16"/>
                  <path d="M6 20V6l6-3 6 3v14"/>
                  <path d="M9 20v-6h6v6"/>
                </svg>
              </span>
              <span class="label">Operations</span>
            </button>
            <button data-page="calendar" data-label="Calendar">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <rect x="3" y="5" width="18" height="16" rx="2"/>
                  <path d="M8 3v4M16 3v4M3 10h18"/>
                </svg>
              </span>
              <span class="label">Calendar</span>
            </button>
            <button data-page="dashboard" data-label="Marketing">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <rect x="3" y="3" width="7" height="7" rx="2"/>
                  <rect x="14" y="3" width="7" height="7" rx="2"/>
                  <rect x="3" y="14" width="7" height="7" rx="2"/>
                  <rect x="14" y="14" width="7" height="7" rx="2"/>
                </svg>
              </span>
              <span class="label">Marketing</span>
            </button>
            <button data-page="email" data-label="Inbox">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <rect x="3" y="5" width="18" height="14" rx="2"/>
                  <path d="M3 7l9 6 9-6"/>
                </svg>
              </span>
              <span class="label">Inbox</span>
            </button>
            <button data-page="housecall" data-label="Jobs">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <path d="M4 12l8-7 8 7"/>
                  <path d="M6 10v9h12v-9"/>
                  <path d="M10 19v-5h4v5"/>
                </svg>
              </span>
              <span class="label">Jobs</span>
            </button>
            <button data-page="estimator" data-label="Estimator">
              <span class="icon">
                <svg viewBox="0 0 24 24" stroke-width="1.8">
                  <path d="M4 6h10a4 4 0 010 8H9l-5 4V6z"/>
                  <path d="M15 16h5v3"/>
                </svg>
              </span>
              <span class="label">Estimator</span>
            </button>
            <div class="subhead">Tools</div>
            <div class="sb-actions" id="pageTools"></div>
            </div>
            <div class="nav-bottom">
              <button data-label="Settings" onclick="openSettings()">
                <span class="icon">
                  <svg viewBox="0 0 24 24" stroke-width="1.8">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.8 1.8 0 000-6l2-1.2-2-3.5-2.2.6a6.2 6.2 0 00-3.4-2l-.4-2.3H10l-.4 2.3a6.2 6.2 0 00-3.4 2l-2.2-.6-2 3.5 2 1.2a1.8 1.8 0 000 6l-2 1.2 2 3.5 2.2-.6a6.2 6.2 0 003.4 2l.4 2.3h4l.4-2.3a6.2 6.2 0 003.4-2l2.2.6 2-3.5-2-1.2z"/>
                  </svg>
                </span>
                <span class="label">Settings</span>
              </button>
              <button class="danger" data-label="Lock" onclick="logout()">
                <span class="icon">
                  <svg viewBox="0 0 24 24" stroke-width="1.8">
                    <rect x="5" y="11" width="14" height="9" rx="2"/>
                    <path d="M8 11V8a4 4 0 018 0v3"/>
                  </svg>
                </span>
                <span class="label">Lock</span>
              </button>
            </div>
          </div>
        </aside>
        <div class="main">
          <div class="page" id="page-dashboard" data-page="dashboard">
      <div class="page-header">
        <div>
          <div class="title">Marketing</div>
          <div class="subtitle">Content planning, analytics, and ideas.</div>
          <div class="pillrow">
            <span class="badge" id="todayLine">Today</span>
            <span class="badge tiktok-badge" id="tiktokBadge">TikTok: Not connected</span>
          </div>
        </div>
      </div>

            <div class="widget-grid" id="widgets-dashboard">
        <!-- LEFT -->
        <section class="section widget" data-widget="inputs">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
          <h2>1) Inputs (what the assistant uses)</h2>
          <p class="sub">Fill these out once, then update weekly. The generator uses your niche, offers, voice, and current focus.</p>

          <div class="row">
            <div class="field">
              <label>Brand / Business</label>
              <input id="brandName" placeholder="Arizona Residential Private Contracting"/>
            </div>
            <div class="field">
              <label>Market (City/Area)</label>
              <input id="market" placeholder="Phoenix East Valley + (San Diego expansion)"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Platforms</label>
              <select id="platform">
                <option value="TikTok">TikTok</option>
                <option value="Instagram">Instagram</option>
                <option value="Both" selected>Both</option>
              </select>
            </div>
            <div class="field">
              <label>Content Style</label>
              <select id="style">
                <option value="Reality-style / behind-the-scenes" selected>Reality-style / behind-the-scenes</option>
                <option value="Educational (tips + how-to)">Educational (tips + how-to)</option>
                <option value="Storytelling (before/after + client wins)">Storytelling (before/after + client wins)</option>
                <option value="Luxury / high-end vibe">Luxury / high-end vibe</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Primary Services to Promote (comma-separated)</label>
              <input id="services" placeholder="Exterior painting, remodels, electrical, property management turnovers"/>
            </div>
            <div class="field">
              <label>Current Offer / CTA</label>
              <input id="cta" placeholder="DM me for a quote / walkthrough / connect with agent"/>
            </div>
          </div>

          <div class="field">
            <label>What are you trying to achieve this month?</label>
            <textarea id="goal" placeholder="Example: Get more high-end remodel leads + attract brand deals (tools, paint, home tech, etc.)."></textarea>
          </div>

          <div class="row">
            <div class="field">
              <label>Your Voice (pick one)</label>
              <select id="voice">
                <option value="Confident + friendly" selected>Confident + friendly</option>
                <option value="Luxury + professional">Luxury + professional</option>
                <option value="Funny + bold">Funny + bold</option>
                <option value="Straight shooter (no fluff)">Straight shooter (no fluff)</option>
              </select>
            </div>
            <div class="field">
              <label>Video Length Target</label>
              <select id="length">
                <option value="15–25 seconds">15–25 seconds</option>
                <option value="30–45 seconds">30–45 seconds</option>
                <option value="60–90 seconds" selected>60–90 seconds</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <h2>2) Tracking + Monitoring (manual metrics)</h2>
          <p class="sub">Log post performance. The assistant summarizes what’s working and what to repeat.</p>

          <div class="row3">
            <div class="field">
              <label>Date</label>
              <input id="mDate" type="date"/>
            </div>
            <div class="field">
              <label>Platform</label>
              <select id="mPlatform">
                <option>TikTok</option>
                <option>Instagram</option>
              </select>
            </div>
            <div class="field">
              <label>Post Type</label>
              <select id="mType">
                <option>Walkthrough</option>
                <option>Before/After</option>
                <option>Tip/How-to</option>
                <option>Client story</option>
                <option>Tool/Material</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div class="row3">
            <div class="field">
              <label>Views</label>
              <input id="mViews" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Likes</label>
              <input id="mLikes" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Comments</label>
              <input id="mComments" type="number" placeholder="0"/>
            </div>
          </div>

          <div class="row3">
            <div class="field">
              <label>Saves</label>
              <input id="mSaves" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Shares</label>
              <input id="mShares" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Profile Visits</label>
              <input id="mVisits" type="number" placeholder="0"/>
            </div>
          </div>

          <div class="field">
            <label>Hook used (first line)</label>
            <input id="mHook" placeholder="Example: This is why most paint jobs fail in year 2…"/>
          </div>
          <div class="field">
            <label>Notes (what happened / why it worked)</label>
            <textarea id="mNotes" placeholder="Example: Hook was strong, before/after was clean, used trending audio, asked a question."></textarea>
          </div>

          <div class="pillrow">
            <button class="primary" onclick="saveMetric()">Save Metric</button>
            <button onclick="summarizePerformance()">Summarize Performance</button>
            <button class="danger" onclick="clearMetrics()">Clear Metrics</button>
          </div>

          <div class="kpi" id="kpiRow"></div>
          <div class="out mono" id="perfOut">Performance summary will appear here.</div>

          <div class="list" id="metricList"></div>
          </div>
        </section>

        <!-- RIGHT -->
        <section class="section widget" data-widget="ideas">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
          <h2>Idea Generator</h2>
          <p class="sub">Generates hooks, scripts, captions, and hashtags based on your niche + goals.</p>

          <div class="field">
            <label>Pick a Content Pillar</label>
            <select id="pillar">
              <option value="Exterior Painting">Exterior Painting</option>
              <option value="Luxury Remodeling">Luxury Remodeling</option>
              <option value="Property Management / Turnovers">Property Management / Turnovers</option>
              <option value="Electrical / Safety">Electrical / Safety</option>
              <option value="Client Stories / Wins" selected>Client Stories / Wins</option>
              <option value="Tools / Materials / Behind-the-scenes">Tools / Materials / Behind-the-scenes</option>
            </select>
          </div>

          <div class="field">
            <label>Current Topic / Job (optional)</label>
            <input id="topic" placeholder="Example: exterior estimate walkthrough, stucco trim, black shingles, etc."/>
          </div>

          <div class="field">
            <label>Audience</label>
            <select id="audience">
              <option value="Homeowners">Homeowners</option>
              <option value="Luxury homeowners" selected>Luxury homeowners</option>
              <option value="Property managers / Realtors">Property managers / Realtors</option>
              <option value="Brands (tools, paint, home tech)">Brands (tools, paint, home tech)</option>
            </select>
          </div>

          <div class="split">
            <button class="primary" onclick="generateHooks()">Hooks</button>
            <button class="primary" onclick="generateScripts()">Scripts</button>
            <button class="primary" onclick="generateCaptions()">Captions</button>
            <button class="primary" onclick="generateHashtags()">Hashtags</button>
          </div>

          <div class="hr"></div>
          <h2>Output</h2>
          <div class="out mono" id="ideaOut">Click a generator button to create content ideas.</div>

          <div class="hr"></div>
          <h2>Saved Ideas</h2>
          <div class="pillrow">
            <button onclick="saveIdea()">Save Output</button>
            <button class="danger" onclick="clearIdeas()">Clear Saved</button>
          </div>
          <div class="list" id="ideaList"></div>
          </div>
        </section>

        <section class="section widget" data-widget="plan">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
        <h2>7-Day Posting Plan</h2>
        <p class="sub">Based on your current goals + performance. Copy/paste into notes or a scheduler.</p>
        <div class="pillrow">
          <button class="primary" onclick="build7DayPlan()">Generate Plan</button>
          <button onclick="copyPlan()">Copy Plan</button>
          <button class="danger" onclick="clearPlan()">Clear Plan</button>
        </div>
        <div class="out mono" id="planOut">Your plan will appear here.</div>
          </div>
        </section>

        <section class="section widget" data-widget="live">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
        <h2>Live Analytics (TikTok)</h2>
        <p class="sub">Connect TikTok to pull live stats + recommendations.</p>
        <div class="pillrow">
          <button class="primary" onclick="loadLiveAnalytics()">Refresh Live Data</button>
        </div>
        <div class="kpi" id="liveKpi"></div>
        <div class="out mono" id="liveOut">Connect TikTok to see live data.</div>
        <div class="hr"></div>
        <h2>Best Time To Post</h2>
        <p class="sub">Based on your recent TikTok performance.</p>
        <div class="list" id="bestTimes"></div>
        <div class="hr"></div>
        <h2>Daily Snapshots</h2>
        <p class="sub">Automatic daily rollups (stored locally).</p>
        <div class="list" id="snapshotList"></div>
        <div class="list" id="liveRecs"></div>
          </div>
        </section>
      </div>
      </div>
      <div class="page" id="page-welcome" data-page="welcome">
        <div class="page-header">
          <div>
            <div class="title" id="welcomeTitle">Welcome back</div>
            <div class="subtitle">Here’s what to focus on today.</div>
          </div>
          <div class="pillrow">
            <span class="badge" id="welcomeDate">Today</span>
          </div>
        </div>
        <div class="widget-grid" id="widgets-welcome">
          <div class="widget large">
            <h3>Today’s Priorities</h3>
            <div class="widget-list">
              <div class="widget-item">Reply to 3 open estimates</div>
              <div class="widget-item">Confirm tomorrow’s walkthroughs</div>
              <div class="widget-item">Post 1 TikTok walkthrough clip</div>
            </div>
          </div>
          <div class="widget small">
            <h3>Sales Snapshot</h3>
            <p>$18,400 projected this week</p>
          </div>
          <div class="widget small">
            <h3>Open Tasks</h3>
            <p>7 items • 2 overdue</p>
          </div>
          <div class="widget large">
            <h3>Team Schedule</h3>
            <div class="widget-list">
              <div class="widget-item">9:00 AM — Exterior estimate • Mesa</div>
              <div class="widget-item">1:30 PM — Remodel consult • Chandler</div>
              <div class="widget-item">3:00 PM — Follow‑up calls</div>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-company" data-page="company">
        <div class="page-header">
          <div>
            <div class="title">Operations Dashboard</div>
            <div class="subtitle">Sales, pipeline, and team overview.</div>
          </div>
          <div class="pillrow">
            <span class="badge">Today</span>
          </div>
        </div>
        <div class="widget-grid" id="widgets-company">
          <div class="widget small">
            <h3>Revenue</h3>
            <p>$128,400 • +6.2% MoM</p>
          </div>
          <div class="widget small">
            <h3>Jobs Won</h3>
            <p>27 this month • +3</p>
          </div>
          <div class="widget small">
            <h3>Active Leads</h3>
            <p>41 in pipeline</p>
          </div>
          <div class="widget full">
            <h3>Revenue Trend</h3>
            <div class="widget-item" style="padding:12px">
              <svg viewBox="0 0 600 220" style="width:100%;height:auto">
                <defs>
                  <linearGradient id="revGrad" x1="0" y1="0" x2="1" y2="0">
                    <stop offset="0%" stop-color="rgba(251,191,36,.9)"/>
                    <stop offset="100%" stop-color="rgba(253,186,116,.9)"/>
                  </linearGradient>
                </defs>
                <path d="M20 180 L 90 140 L 160 150 L 230 130 L 300 95 L 370 120 L 440 85 L 510 110 L 580 70"
                  stroke="url(#revGrad)" stroke-width="3" fill="none" stroke-linecap="round"/>
                <path d="M20 180 L 90 140 L 160 150 L 230 130 L 300 95 L 370 120 L 440 85 L 510 110 L 580 70 L 580 200 L 20 200 Z"
                  fill="rgba(251,191,36,.12)"/>
                <g stroke="rgba(255,255,255,.12)" stroke-width="1">
                  <line x1="20" y1="200" x2="580" y2="200"/>
                  <line x1="20" y1="160" x2="580" y2="160"/>
                  <line x1="20" y1="120" x2="580" y2="120"/>
                  <line x1="20" y1="80" x2="580" y2="80"/>
                </g>
              </svg>
            </div>
          </div>
          <div class="widget large">
            <h3>Pipeline</h3>
            <div class="widget-list">
              <div class="widget-item">Exterior repaint • $14,200 • Proposal sent</div>
              <div class="widget-item">Kitchen remodel • $28,900 • Site visit tomorrow</div>
              <div class="widget-item">Commercial roof • $62,000 • Awaiting approval</div>
            </div>
          </div>
          <div class="widget large">
            <h3>Team Schedule</h3>
            <div class="widget-list">
              <div class="widget-item">Maria — Walkthroughs • 9:00 AM</div>
              <div class="widget-item">Luis — Estimate prep • 1:00 PM</div>
              <div class="widget-item">Jason — Follow‑ups • 3:30 PM</div>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-calendar" data-page="calendar">
        <div class="page-header">
          <div>
            <div class="title">Company Calendar</div>
            <div class="subtitle" id="calendarRange">Calendar range</div>
          </div>
          <div class="pillrow">
            <button onclick="changeCalendarWeek(-1)">Prev</button>
            <button onclick="jumpCalendarToToday()">Today</button>
            <button onclick="changeCalendarWeek(1)">Next</button>
            <button class="primary" onclick="focusCalendarCreate()">Create Event</button>
          </div>
        </div>
        <div class="widget-grid" id="widgets-calendar">
          <div class="widget small">
            <div class="calendar-mini-head">
              <span class="month" id="calendarMonthLabel">Month</span>
              <div class="pillrow">
                <button onclick="changeCalendarMonth(-1)">&#8249;</button>
                <button onclick="changeCalendarMonth(1)">&#8250;</button>
              </div>
            </div>
            <div class="calendar-mini-weekdays">
              <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
            </div>
            <div id="calendarMiniMonth" class="calendar-mini-month"></div>
            <div class="mini" id="calendarSelectedHint" style="margin-top:8px">Selected date</div>
          </div>
          <div class="widget small">
            <h3>Filters & View</h3>
            <div class="field"><label>Search</label><input id="calSearch" placeholder="Search title, notes, location"/></div>
            <div class="row">
              <div class="field">
                <label>View</label>
                <select id="calViewMode">
                  <option value="week">Week</option>
                  <option value="day">Day</option>
                  <option value="agenda">Agenda</option>
                </select>
              </div>
              <div class="field">
                <label>Status</label>
                <select id="calFilterStatus">
                  <option value="all">All statuses</option>
                  <option value="planned">Planned</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="done">Done</option>
                  <option value="canceled">Canceled</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label>Assignee</label>
                <select id="calFilterAssignee"></select>
              </div>
              <div class="field">
                <label>Sort Queue</label>
                <select id="calSort">
                  <option value="soonest">Soonest first</option>
                  <option value="latest">Latest first</option>
                  <option value="priority">Highest priority</option>
                </select>
              </div>
            </div>
            <div class="calendar-filter-list" id="calendarCategories"></div>
            <div class="mini" id="calendarFilterSummary"></div>
          </div>
          <div class="widget small">
            <h3>Calendar Stats</h3>
            <div class="calendar-quickstats">
              <div class="widget-item"><strong id="calStatTodayCount">0</strong><span>Events today</span></div>
              <div class="widget-item"><strong id="calStatWeekHours">0h</strong><span>Scheduled this week</span></div>
              <div class="widget-item"><strong id="calStatOpenCount">0</strong><span>Open events</span></div>
            </div>
          </div>
          <div class="widget large">
            <h3 id="calFormTitle">Create Event</h3>
            <input id="calEditId" type="hidden"/>
            <div class="field"><label>Title</label><input id="calTitle" placeholder="Estimate walkthrough"/></div>
            <div class="row">
              <div class="field"><label>Date</label><input id="calDate" type="date"/></div>
              <div class="field"><label>Category</label>
                <select id="calCategory">
                  <option>Estimate</option>
                  <option>Job</option>
                  <option>Marketing</option>
                  <option>Meeting</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="field"><label>Start</label><input id="calStart" type="time" value="09:00"/></div>
              <div class="field"><label>End</label><input id="calEnd" type="time" value="10:00"/></div>
            </div>
            <div class="row">
              <div class="field">
                <label>Status</label>
                <select id="calStatus">
                  <option value="planned">Planned</option>
                  <option value="confirmed">Confirmed</option>
                  <option value="done">Done</option>
                  <option value="canceled">Canceled</option>
                </select>
              </div>
              <div class="field">
                <label>Priority</label>
                <select id="calPriority">
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="field"><label>Assignee</label><input id="calAssignee" placeholder="Rosario"/></div>
              <div class="field"><label>Location</label><input id="calLocation" placeholder="Client address / office"/></div>
            </div>
            <div class="row">
              <div class="field">
                <label>Repeat</label>
                <select id="calRepeat">
                  <option value="none">Does not repeat</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div class="field">
                <label>All Day</label>
                <label class="toggle"><input id="calAllDay" type="checkbox"/> Use full day (9:00-17:00)</label>
              </div>
            </div>
            <div class="field"><label>Notes</label><textarea id="calNotes" rows="3" placeholder="Scope, reminders, team notes"></textarea></div>
            <div class="pillrow">
              <button class="primary" id="calSaveBtn" onclick="addCalendarEvent()">Save Event</button>
              <button id="calCancelBtn" onclick="cancelCalendarEdit()" style="display:none">Cancel</button>
              <button id="calDuplicateBtn" onclick="duplicateEditingCalendarEvent()" style="display:none">Duplicate</button>
            </div>
          </div>
          <div class="widget full" id="calendarBoardWidget">
            <h3 id="calendarBoardTitle">Weekly Planner</h3>
            <div class="calendar-board" id="calendarBoard">
              <div class="calendar-time-col" id="calendarTimeCol"></div>
              <div class="calendar-week-grid" id="calendarWeekGrid"></div>
            </div>
            <div class="mini" id="calendarBoardHint" style="margin-top:8px"></div>
          </div>
          <div class="widget full">
            <h3>Event Queue</h3>
            <div class="widget-list" id="calendarEventList"></div>
          </div>
        </div>
      </div>

      <div class="page" id="page-email" data-page="email">
        <div class="page-header">
          <div>
            <div class="title">Inbox</div>
            <div class="subtitle">Draft, send, and track proposals.</div>
          </div>
        </div>
        <div class="widget-grid" id="widgets-email">
          <div class="widget large">
            <h3>Inbox</h3>
            <div class="widget-list">
              <div class="widget-item">Re: Exterior Estimate — John D. • 9:42 AM</div>
              <div class="widget-item">New lead — Sarah K. • 8:19 AM</div>
              <div class="widget-item">Follow up — Beacon Roofing • Yesterday</div>
            </div>
          </div>
          <div class="widget large">
            <h3>Compose</h3>
            <div class="field"><label>To</label><input placeholder="client@email.com"/></div>
            <div class="field"><label>Subject</label><input placeholder="Estimate for your project"/></div>
            <div class="field"><label>Message</label><textarea rows="6" placeholder="Hi ..."></textarea></div>
            <div class="pillrow" style="margin-top:10px">
              <button class="primary">Send</button>
              <button>Save Draft</button>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-housecall" data-page="housecall">
        <div class="page-header">
          <div>
            <div class="title">Jobs</div>
            <div class="subtitle">Jobs, estimates, and schedule.</div>
          </div>
        </div>
        <div class="widget-grid" id="widgets-housecall">
          <div class="widget large">
            <h3>Upcoming Jobs</h3>
            <div class="widget-list">
              <div class="widget-item">Feb 7 • Exterior paint • Mesa</div>
              <div class="widget-item">Feb 8 • Remodel walkthrough • Scottsdale</div>
              <div class="widget-item">Feb 9 • Commercial bid • Tempe</div>
            </div>
          </div>
          <div class="widget small">
            <h3>Open Estimates</h3>
            <p>12 active • 4 awaiting approval</p>
          </div>
          <div class="widget small">
            <h3>Jobs Completed</h3>
            <p>18 this month</p>
          </div>
          <div class="widget full">
            <h3>Schedule</h3>
            <div class="widget-list">
              <div class="widget-item">Mon • 8:00 AM — Site walk</div>
              <div class="widget-item">Wed • 2:00 PM — Estimate review</div>
              <div class="widget-item">Fri • 1:30 PM — Final walkthrough</div>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-estimator" data-page="estimator">
        <div class="page-header">
          <div>
            <div class="title">Estimator Studio</div>
            <div class="subtitle">Chat + structured estimate builder.</div>
          </div>
        </div>
        <div class="widget-grid" id="widgets-estimator">
          <div class="widget large">
            <h3>Estimator Chat</h3>
            <div class="widget-list">
              <div class="widget-item">AI: Upload photos and measurements to begin.</div>
              <div class="widget-item">You: 2,400 sq ft exterior, 2 stories.</div>
            </div>
            <div class="field"><input placeholder="Ask the estimator..."/></div>
            <div class="pillrow" style="margin-top:10px">
              <button class="primary">Send</button>
              <button>Attach Photos</button>
            </div>
          </div>
          <div class="widget large">
            <h3>Estimate Summary</h3>
            <div class="widget-list">
              <div class="widget-item">Labor: $4,600</div>
              <div class="widget-item">Materials: $1,900</div>
              <div class="widget-item">Prep: $850</div>
            </div>
            <div class="widget-row" style="margin-top:10px">
              <span class="pill">Total: $7,350</span>
              <span class="pill">Margin: 32%</span>
            </div>
          </div>
        </div>
      </div>
        </div>
      </div>

      <!-- SETTINGS MODAL -->
      <div class="modal" id="settingsModal">
        <div class="panel">
          <div class="settings-head">
            <div class="title-wrap">
              <p class="kicker">Workspace</p>
              <h2>Settings</h2>
              <p>Appearance, layout, brand, social connections, and security.</p>
            </div>
            <div class="settings-tools">
              <input class="settings-search" id="settingsSearch" type="text" placeholder="Search settings"/>
              <button onclick="closeSettings()">Done</button>
            </div>
          </div>

          <div class="settings-shell">
            <aside class="settings-nav">
              <div class="settings-account">
                <div class="avatar"><img id="settingsAvatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' fill='%231f2937'/%3E%3C/svg%3E" alt="profile"/></div>
                <div class="meta">
                  <strong id="settingsBrandTitle">AI Marketing Assistant</strong>
                  <span id="settingsProfileLabel">Owner • Private</span>
                </div>
              </div>
              <div class="sub">Sections</div>
              <a href="#sec-appearance" data-settings-link="sec-appearance">Appearance & Motion</a>
              <a href="#sec-layout" data-settings-link="sec-layout">Layout Controls</a>
              <a href="#sec-marketing" data-settings-link="sec-marketing" id="settingsNavMarketing">Marketing Page</a>
              <a href="#sec-brand" data-settings-link="sec-brand">Brand Studio</a>
              <a href="#sec-social" data-settings-link="sec-social">Social Accounts</a>
              <a href="#sec-security" data-settings-link="sec-security">Security</a>
            </aside>

            <div class="settings-main">
              <div class="settings-main-grid">
              <section class="settings-card" id="sec-appearance" data-settings-card="theme appearance motion transparency blur glass dark light">
                <h3>Appearance & Motion</h3>
                <div class="settings-grid-2">
                  <div>
                    <div class="field">
                      <label>Theme</label>
                      <div class="pillrow">
                        <button onclick="toggleTheme()" id="themeToggleBtnSettings">Light/Dark</button>
                      </div>
                    </div>
                    <div class="field">
                      <label>Motion</label>
                      <div class="pillrow">
                        <label class="toggle"><input type="checkbox" id="toggleMotion"/> Reduce Motion</label>
                      </div>
                    </div>
                  </div>
                  <div>
                    <div class="field">
                      <label>Glass transparency</label>
                      <input id="glassSlider" type="range" min="0.01" max="0.30" step="0.005"/>
                    </div>
                    <div class="field">
                      <label>Current transparency</label>
                      <input id="glassValue" type="text" readonly/>
                    </div>
                    <div class="field">
                      <label>Glass blur (px)</label>
                      <input id="blurSlider" type="range" min="6" max="28" step="1"/>
                    </div>
                    <div class="field">
                      <label>Current blur</label>
                      <input id="blurValue" type="text" readonly/>
                    </div>
                  </div>
                </div>
              </section>

              <section class="settings-card" id="sec-layout" data-settings-card="layout spacing widgets pages drag resize">
                <h3>Layout Controls</h3>
                <p class="sub">Global layout controls for all pages.</p>
                <div class="field">
                  <label>Widget spacing (all pages)</label>
                  <input id="pageGap" type="range" min="10" max="28" step="1"/>
                </div>
                <div class="mini">Drag and resize widgets directly on each page. Spacing updates everywhere.</div>
              </section>

              <section class="settings-card full" id="sec-marketing" data-settings-card="marketing dashboard ideas plan analytics visibility">
                <div id="dashboardSettings">
                  <h3>Marketing Page</h3>
                  <p class="sub">These controls apply to the Marketing page widgets and visibility only.</p>
                  <div class="pillrow">
                    <button onclick="applyPreset('analytics')">Analytics Focus</button>
                    <button onclick="applyPreset('two-column')">Two Column</button>
                    <button onclick="resetLayout()">Reset Layout</button>
                  </div>
                  <div class="hr"></div>
                  <div class="pillrow">
                    <label class="toggle"><input type="checkbox" id="toggleInputs"/> Inputs</label>
                    <label class="toggle"><input type="checkbox" id="toggleIdeas"/> Ideas</label>
                    <label class="toggle"><input type="checkbox" id="togglePlan"/> 7‑Day Plan</label>
                    <label class="toggle"><input type="checkbox" id="toggleLive"/> Live Analytics</label>
                  </div>
                </div>
              </section>

              <section class="settings-card full" id="sec-brand" data-settings-card="brand logo avatar title tagline accent color profile">
                <h3>Brand Studio</h3>
                <p class="sub">Update colors, logo, and profile without editing the file.</p>
                <div class="row">
                  <div class="field">
                    <label>Brand Title</label>
                    <input id="brandTitleInput" placeholder="Rosario’s AI Marketing Assistant"/>
                  </div>
                  <div class="field">
                    <label>Tagline / Status</label>
                    <input id="brandTaglineInput" placeholder="Marketing Command Center • Phoenix AZ"/>
                  </div>
                </div>
                <div class="field">
                  <label>Profile Label</label>
                  <input id="profileLabelInput" placeholder="Owner • Private"/>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Primary Accent</label>
                    <input id="accentColor" type="color"/>
                  </div>
                  <div class="field">
                    <label>Secondary Accent</label>
                    <input id="accent2Color" type="color"/>
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Background Color</label>
                    <input id="bgColor" type="color"/>
                  </div>
                  <div class="field">
                    <label>Card / Panel Color</label>
                    <input id="cardColor" type="color"/>
                  </div>
                </div>
                <div class="row">
                  <div class="field">
                    <label>Logo Image (square works best)</label>
                    <input id="logoUpload" type="file" accept="image/*"/>
                  </div>
                  <div class="field">
                    <label>Profile Avatar</label>
                    <input id="avatarUpload" type="file" accept="image/*"/>
                  </div>
                </div>
                <div class="pillrow">
                  <button onclick="resetBrand()">Reset Brand</button>
                </div>
              </section>

              <section class="settings-card" id="sec-social" data-settings-card="social accounts connect analytics tiktok oauth">
                <h3>Social Accounts (Live Data)</h3>
                <p class="sub">Connect accounts to pull analytics. Requires backend + API keys.</p>
                <div class="mini">Live analytics needs OAuth and platform approvals.</div>
                <div class="social-list" id="socialList"></div>
              </section>

              <section class="settings-card" id="sec-security" data-settings-card="security password login access">
                <h3>Security</h3>
                <div class="field">
                  <label>Change Password</label>
                  <input id="newPw" type="password" placeholder="New password"/>
                </div>
                <button onclick="setPassword()">Update Password</button>
              </section>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== Storage keys ======
  const KEY = {
    pw: "arm_ai_pw",
    inputs: "arm_ai_inputs",
    metrics: "arm_ai_metrics",
    ideas: "arm_ai_ideas",
    plan: "arm_ai_plan",
    brand: "arm_ai_brand",
    social: "arm_ai_social",
    socialProfile: "arm_ai_social_profile",
    calendar: "arm_company_calendar_events",
    calendarWeek: "arm_company_calendar_week",
    calendarPrefs: "arm_company_calendar_prefs",
    layout: "arm_ai_layout",
    theme: "arm_ai_theme",
    motion: "arm_ai_motion",
    glass: "arm_ai_glass",
    blur: "arm_ai_blur",
    session: "arm_ai_session"
  };

  // ====== Helpers ======
  const $ = (id) => document.getElementById(id);
  const now = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  const todayISO = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  let currentUser = null;

  function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch(e){
      return fallback;
    }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function setTodayLine(){
    const d = new Date();
    const pretty = d.toLocaleString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
    const line = $("todayLine");
    if(line) line.textContent = `Today: ${pretty}`;
    const welcome = $("welcomeDate");
    if(welcome) welcome.textContent = `Today: ${pretty}`;
    const mDate = $("mDate");
    if(mDate) mDate.value = todayISO;
  }

  // ====== Login ======
  function setLoginStatus(msg){
    const el = $("loginStatus");
    if(el) el.textContent = msg;
  }

  function applyCurrentUser(user){
    currentUser = user;
    const sidebarUser = $("sidebarUser");
    if(sidebarUser){
      sidebarUser.textContent = user ? `${user.displayName} (${user.role})` : "";
    }
    const welcomeTitle = $("welcomeTitle");
    if(welcomeTitle){
      welcomeTitle.textContent = user ? `Welcome back, ${user.displayName}` : "Welcome back";
    }
  }

  async function getCurrentSessionUser(){
    const res = await fetch("/api/auth/me", { cache: "no-store" }).catch(()=>null);
    if(!res || !res.ok) return null;
    const data = await res.json().catch(()=>null);
    return data?.user || null;
  }

  function showApp(){
    if($("appView").classList.contains("hidden")){
      $("loginView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      setTodayLine();
      hydrate();
    }
  }

  async function login(){
    const username = ($("loginUsername").value || "").trim();
    const password = $("pw").value || "";
    if(!username || !password){
      setLoginStatus("Enter username and password.");
      return;
    }
    const res = await fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    }).catch(()=>null);
    if(!res || !res.ok){
      const err = await res?.json().catch(()=>null);
      setLoginStatus(err?.message || "Login failed.");
      return;
    }
    const data = await res.json();
    applyCurrentUser(data.user);
    setLoginStatus("Login successful.");
    showApp();
  }

  async function registerUser(){
    const displayName = ($("regDisplayName").value || "").trim();
    const username = ($("regUsername").value || "").trim();
    const password = $("regPassword").value || "";
    const res = await fetch("/api/auth/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ displayName, username, password })
    }).catch(()=>null);
    if(!res || !res.ok){
      const err = await res?.json().catch(()=>null);
      setLoginStatus(err?.message || "Registration failed.");
      return;
    }
    const data = await res.json();
    applyCurrentUser(data.user);
    setLoginStatus("Account created.");
    showApp();
  }

  async function logout(){
    await fetch("/api/auth/logout", { method: "POST" }).catch(()=>{});
    $("pw").value = "";
    $("loginView").classList.remove("hidden");
    $("appView").classList.add("hidden");
    applyCurrentUser(null);
  }

  async function setPassword(){
    const np = $("newPw").value || "";
    if(np.length < 8){ alert("Use at least 8 characters."); return; }
    const res = await fetch("/api/auth/password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: np })
    }).catch(()=>null);
    if(!res || !res.ok){
      const err = await res?.json().catch(()=>null);
      alert(err?.message || "Failed to update password.");
      return;
    }
    $("newPw").value = "";
    alert("Password updated.");
  }

  // ====== Inputs ======
  function getInputs(){
    return {
      brandName: $("brandName").value.trim(),
      market: $("market").value.trim(),
      platform: $("platform").value,
      style: $("style").value,
      services: $("services").value.trim(),
      cta: $("cta").value.trim(),
      goal: $("goal").value.trim(),
      voice: $("voice").value,
      length: $("length").value
    };
  }

  function saveInputs(){
    saveJSON(KEY.inputs, getInputs());
  }

  function hydrateInputs(){
    const i = loadJSON(KEY.inputs, {});
    if(i.brandName) $("brandName").value = i.brandName;
    if(i.market) $("market").value = i.market;
    if(i.platform) $("platform").value = i.platform;
    if(i.style) $("style").value = i.style;
    if(i.services) $("services").value = i.services;
    if(i.cta) $("cta").value = i.cta;
    if(i.goal) $("goal").value = i.goal;
    if(i.voice) $("voice").value = i.voice;
    if(i.length) $("length").value = i.length;

    // Autosave on input
    ["brandName","market","platform","style","services","cta","goal","voice","length"].forEach(id=>{
      $(id).addEventListener("input", saveInputs);
      $(id).addEventListener("change", saveInputs);
    });
  }

  // ====== Brand Studio ======
  const DEFAULT_BRAND = {
    title: "Rosario’s AI Marketing Assistant",
    tagline: "Marketing Command Center",
    accent: "#7dd3fc",
    accent2: "#a78bfa",
    bg: "#0b0f14",
    card: "#121a27",
    logo: "",
    avatar: "",
    profileLabel: "Owner • Private"
  };

  function getBrand(){
    return { ...DEFAULT_BRAND, ...loadJSON(KEY.brand, {}) };
  }

  function hexToRgba(hex, alpha){
    const h = hex.replace("#","").trim();
    if(h.length !== 6) return `rgba(18, 26, 39, ${alpha})`;
    const r = parseInt(h.slice(0,2), 16);
    const g = parseInt(h.slice(2,4), 16);
    const b = parseInt(h.slice(4,6), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function applyBrand(b){
    document.documentElement.style.setProperty("--accent", b.accent);
    document.documentElement.style.setProperty("--accent2", b.accent2);
    document.documentElement.style.setProperty("--bg", b.bg);
    document.documentElement.style.setProperty("--card", b.card);
    document.documentElement.style.setProperty("--panel", hexToRgba(b.card, 0.78));
    const brandTitle = $("brandTitle");
    if(brandTitle) brandTitle.textContent = b.title || DEFAULT_BRAND.title;
    const brandTagline = $("brandTagline");
    if(brandTagline) brandTagline.textContent = b.tagline || DEFAULT_BRAND.tagline;
    const profileLabel = $("profileLabel");
    if(profileLabel) profileLabel.textContent = b.profileLabel || DEFAULT_BRAND.profileLabel;
    const sidebarTitle = $("sidebarTitle");
    if(sidebarTitle) sidebarTitle.textContent = b.title || DEFAULT_BRAND.title;
    const sidebarTagline = $("sidebarTagline");
    if(sidebarTagline) sidebarTagline.textContent = "Dashboard";

    if(b.logo){
      const brandLogoImg = $("brandLogoImg");
      if(brandLogoImg){
        brandLogoImg.src = b.logo;
        brandLogoImg.classList.remove("hidden");
      }
      const sidebarLogoImg = $("sidebarLogoImg");
      if(sidebarLogoImg){
        sidebarLogoImg.src = b.logo;
        sidebarLogoImg.classList.remove("hidden");
      }
    }else{
      const brandLogoImg = $("brandLogoImg");
      if(brandLogoImg) brandLogoImg.classList.add("hidden");
      const sidebarLogoImg = $("sidebarLogoImg");
      if(sidebarLogoImg) sidebarLogoImg.classList.add("hidden");
    }

    if(b.avatar){
      const brandAvatarImg = $("brandAvatarImg");
      if(brandAvatarImg){
        brandAvatarImg.src = b.avatar;
        brandAvatarImg.classList.remove("hidden");
      }
    }else{
      const brandAvatarImg = $("brandAvatarImg");
      if(brandAvatarImg) brandAvatarImg.classList.add("hidden");
    }
  }

  function saveBrand(partial){
    const next = { ...getBrand(), ...partial };
    saveJSON(KEY.brand, next);
    applyBrand(next);
    scheduleSettingsSync();
  }

  function resetBrand(){
    if(!confirm("Reset brand settings to default?")) return;
    saveJSON(KEY.brand, DEFAULT_BRAND);
    hydrateBrand();
    scheduleSettingsSync();
  }

  function readImageFile(input, cb){
    const file = input.files && input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => cb(String(reader.result || ""));
    reader.readAsDataURL(file);
  }

  function hydrateBrand(){
    const b = getBrand();
    $("brandTitleInput").value = b.title;
    $("brandTaglineInput").value = b.tagline;
    $("profileLabelInput").value = b.profileLabel;
    $("accentColor").value = b.accent;
    $("accent2Color").value = b.accent2;
    $("bgColor").value = b.bg;
    $("cardColor").value = b.card;
    applyBrand(b);

    $("brandTitleInput").addEventListener("input", (e)=> saveBrand({ title: e.target.value }));
    $("brandTaglineInput").addEventListener("input", (e)=> saveBrand({ tagline: e.target.value }));
    $("profileLabelInput").addEventListener("input", (e)=> saveBrand({ profileLabel: e.target.value }));
    $("accentColor").addEventListener("input", (e)=> saveBrand({ accent: e.target.value }));
    $("accent2Color").addEventListener("input", (e)=> saveBrand({ accent2: e.target.value }));
    $("bgColor").addEventListener("input", (e)=> saveBrand({ bg: e.target.value }));
    $("cardColor").addEventListener("input", (e)=> saveBrand({ card: e.target.value }));

    $("logoUpload").addEventListener("change", (e)=>{
      readImageFile(e.target, (data)=> saveBrand({ logo: data }));
    });
    $("avatarUpload").addEventListener("change", (e)=>{
      readImageFile(e.target, (data)=> saveBrand({ avatar: data }));
    });
  }

  function renderLoginBrand(){
    const b = getBrand();
    if(b.logo){
      $("loginLogoImg").src = b.logo;
      $("loginLogoImg").classList.remove("hidden");
    }else{
      $("loginLogoImg").classList.add("hidden");
    }
  }

  // ====== Social Connections (placeholder) ======
  const SOCIAL_PLATFORMS = ["Instagram", "Facebook", "TikTok", "LinkedIn", "YouTube", "X"];

  function getSocial(){
    return loadJSON(KEY.social, {});
  }

  function getSocialProfile(){
    return loadJSON(KEY.socialProfile, {});
  }

  function setSocialProfile(platform, profile){
    const next = { ...getSocialProfile(), [platform]: profile };
    saveJSON(KEY.socialProfile, next);
    updateTiktokBadge();
    renderSocial();
  }

  function setSocial(platform, status){
    const next = { ...getSocial(), [platform]: status };
    saveJSON(KEY.social, next);
    updateTiktokBadge();
    renderSocial();
  }

  function updateTiktokBadge(){
    const badge = $("tiktokBadge");
    if(!badge) return;
    const state = getSocial();
    const profiles = getSocialProfile();
    const status = state["TikTok"] || "Not connected";
    const name = profiles["TikTok"];
    badge.classList.remove("connected","needs","error");
    if(status === "Connected") badge.classList.add("connected");
    if(status === "Needs setup") badge.classList.add("needs");
    if(status === "Error") badge.classList.add("error");
    badge.textContent = name ? `TikTok: ${status} • ${name}` : `TikTok: ${status}`;
  }

  function connectSocial(platform){
    if(platform === "TikTok"){
      window.location.href = "/api/tiktok/connect";
      return;
    }
    alert(`${platform} connection requires a backend OAuth flow and API keys. I can wire it up once you’re ready.`);
    setSocial(platform, "Needs setup");
  }

  async function disconnectSocial(platform){
    if(!confirm(`Disconnect ${platform}?`)) return;
    if(platform === "TikTok"){
      await fetch("/api/tiktok/disconnect", { method: "POST" });
      setSocial(platform, "Not connected");
      setSocialProfile(platform, "");
      updateTiktokBadge();
      const liveOut = $("liveOut");
      if(liveOut) liveOut.textContent = "Connect TikTok to see live data.";
      const liveKpi = $("liveKpi");
      if(liveKpi) liveKpi.innerHTML = "";
      return;
    }
    setSocial(platform, "Not connected");
    setSocialProfile(platform, "");
  }

  async function switchSocial(platform){
    await disconnectSocial(platform);
    connectSocial(platform);
  }

  function isTikTokConnected(){
    const state = getSocial();
    return state["TikTok"] === "Connected";
  }

  let settingsSyncTimer = null;
  let lastSettingsSyncPayload = "";
  function scheduleSettingsSync(){
    if(settingsSyncTimer) clearTimeout(settingsSyncTimer);
    settingsSyncTimer = setTimeout(async ()=>{
      const payload = {
        brand: getBrand(),
        layout: getLayout(),
        theme: localStorage.getItem(KEY.theme) || "dark",
        motion: localStorage.getItem(KEY.motion) || "full",
        glass: localStorage.getItem(KEY.glass),
        blur: localStorage.getItem(KEY.blur),
        widgetGap: localStorage.getItem("widget_gap_global") || "16",
        calendarEvents: loadJSON(KEY.calendar, [])
      };
      const serialized = JSON.stringify(payload);
      if(serialized === lastSettingsSyncPayload) return;
      lastSettingsSyncPayload = serialized;
      if(isTikTokConnected()){
        await fetch("/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: serialized
        }).catch(()=>{});
      }
      await fetch("/api/public-settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: serialized
      }).catch(()=>{});
    }, 800);
  }

  const PAGE_TOOLS = {
    welcome: [
      { label: "Back to Marketing", action: "setActivePage('dashboard')" }
    ],
    company: [
      { label: "Back to Marketing", action: "setActivePage('dashboard')" },
      { label: "Add Report", action: "alert('Report builder coming next.')" }
    ],
    calendar: [
      { label: "Today", action: "jumpCalendarToToday()" },
      { label: "New Event", action: "focusCalendarCreate()", primary: true }
    ],
    dashboard: [
      { label: "Light/Dark", action: "toggleTheme()" },
      { label: "Generate Ideas", action: "generateAll()", primary: true },
      { label: "Build 7-Day Plan", action: "build7DayPlan()" },
      { label: "Export", action: "exportData()" }
    ],
    email: [
      { label: "Back to Dashboard", action: "setActivePage('dashboard')" },
      { label: "New Email", action: "alert('Compose flow coming next.')" }
    ],
    housecall: [
      { label: "Back to Dashboard", action: "setActivePage('dashboard')" },
      { label: "Sync Jobs", action: "alert('Housecall Pro sync coming next.')" }
    ],
    estimator: [
      { label: "Back to Dashboard", action: "setActivePage('dashboard')" },
      { label: "New Estimate", action: "alert('Estimator workflow coming next.')" }
    ]
  };

  function renderPageTools(page){
    const root = $("pageTools");
    if(!root) return;
    root.innerHTML = "";
    const items = PAGE_TOOLS[page] || [];
    items.forEach(item=>{
      const btn = document.createElement("button");
      btn.textContent = item.label;
      if(item.primary) btn.classList.add("primary");
      btn.setAttribute("onclick", item.action);
      root.appendChild(btn);
    });
  }

  const PAGE_LABELS = {
    welcome: "Daily Brief",
    company: "Operations",
    calendar: "Calendar",
    dashboard: "Marketing",
    email: "Inbox",
    housecall: "Jobs",
    estimator: "Estimator"
  };

  function setActivePage(page){
    const pages = document.querySelectorAll(".page");
    pages.forEach(p=>p.classList.remove("active"));
    const target = document.querySelector(`.page[data-page=\"${page}\"]`);
    if(target) target.classList.add("active");
    document.querySelectorAll(".nav button[data-page]").forEach(btn=>{
      btn.classList.toggle("active", btn.getAttribute("data-page") === page);
    });
    $("sidebarTagline").textContent = PAGE_LABELS[page] || "Dashboard";
    renderPageTools(page);
    const topbar = $("marketingTopbar");
    if(topbar) topbar.style.display = page === "dashboard" ? "flex" : "none";
    const gap = localStorage.getItem("widget_gap_global") || "16";
    document.documentElement.style.setProperty("--widget-gap", `${gap}px`);
    if(page === "calendar"){
      renderCalendar(true);
    }
    const url = new URL(window.location.href);
    url.searchParams.set("page", page);
    window.history.replaceState({}, "", url.toString());
  }

  function bindPageNav(){
    document.querySelectorAll(".nav button[data-page]").forEach(btn=>{
      btn.addEventListener("click", ()=> setActivePage(btn.getAttribute("data-page")));
    });
    const params = new URLSearchParams(window.location.search);
    setActivePage(params.get("page") || "company");
  }

  async function loadPublicSettings(){
    try{
      const res = await fetch("/api/public-settings", { cache: "no-store" });
      const data = await res.json();
      if(data.status !== "ok" || !data.data) return;
      if(data.data.brand){
        saveJSON(KEY.brand, { ...getBrand(), ...data.data.brand });
      }
      if(data.data.layout){
        saveJSON(KEY.layout, { ...getLayout(), ...data.data.layout });
      }
      if(data.data.theme){
        localStorage.setItem(KEY.theme, data.data.theme);
      }
      if(data.data.motion){
        localStorage.setItem(KEY.motion, data.data.motion);
      }
      if(data.data.glass){
        localStorage.setItem(KEY.glass, data.data.glass);
      }
      if(data.data.blur){
        localStorage.setItem(KEY.blur, data.data.blur);
      }
      if(data.data.widgetGap){
        localStorage.setItem("widget_gap_global", String(data.data.widgetGap));
      }
      if(Array.isArray(data.data.calendarEvents)){
        saveJSON(KEY.calendar, data.data.calendarEvents);
        if(!$("appView").classList.contains("hidden")) renderCalendar();
      }
    }catch(e){}
  }

  function applyTheme(theme){
    const shouldLight = theme === "light";
    const isLight = document.body.classList.contains("light");
    if(shouldLight && !isLight){
      document.body.classList.add("light");
    }else if(!shouldLight && isLight){
      document.body.classList.remove("light");
    }
    const t = $("themeToggleBtn");
    if(t) t.textContent = shouldLight ? "Dark Mode" : "Light Mode";
    const ts = $("themeToggleBtnSettings");
    if(ts) ts.textContent = shouldLight ? "Dark Mode" : "Light Mode";
    localStorage.setItem(KEY.theme, theme);
  }

  function toggleTheme(){
    const isLight = document.body.classList.contains("light");
    applyTheme(isLight ? "dark" : "light");
    scheduleSettingsSync();
  }

  function applyMotion(pref){
    if(pref === "reduce"){
      document.body.classList.add("reduce-motion");
      $("toggleMotion").checked = true;
    }else{
      document.body.classList.remove("reduce-motion");
      $("toggleMotion").checked = false;
    }
    localStorage.setItem(KEY.motion, pref);
  }

  function applyGlass(value){
    const v = Math.max(0.01, Math.min(0.3, Number(value)));
    const current = Number(localStorage.getItem(KEY.glass));
    if(Number.isFinite(current) && Math.abs(current - v) < 0.0005){
      const display = $("glassValue");
      const slider = $("glassSlider");
      if(display) display.value = v.toFixed(3);
      if(slider) slider.value = v.toFixed(3);
      return;
    }
    document.documentElement.style.setProperty("--glass-opacity", v.toFixed(3));
    document.documentElement.style.setProperty("--glass-strong-opacity", Math.min(0.6, v * 2.1).toFixed(3));
    document.documentElement.style.setProperty("--glass-border-opacity", Math.min(0.28, v * 7).toFixed(3));
    const highlight = Math.min(0.7, Math.max(0.18, v * 8));
    document.documentElement.style.setProperty("--glass-highlight-opacity", highlight.toFixed(3));
    localStorage.setItem(KEY.glass, String(v));
    const display = $("glassValue");
    const slider = $("glassSlider");
    if(display) display.value = v.toFixed(3);
    if(slider) slider.value = v.toFixed(3);
  }

  function applyBlur(value){
    const v = Math.max(6, Math.min(28, Number(value)));
    const current = Number(localStorage.getItem(KEY.blur));
    if(Number.isFinite(current) && Math.abs(current - v) < 0.5){
      const display = $("blurValue");
      const slider = $("blurSlider");
      if(display) display.value = `${v}`;
      if(slider) slider.value = `${v}`;
      return;
    }
    document.documentElement.style.setProperty("--blur", `${v}px`);
    localStorage.setItem(KEY.blur, String(v));
    const display = $("blurValue");
    const slider = $("blurSlider");
    if(display) display.value = `${v}`;
    if(slider) slider.value = `${v}`;
  }

  async function loadSettingsFromServer(){
    if(!isTikTokConnected()) return;
    const res = await fetch("/api/settings", { cache: "no-store" }).catch(()=>null);
    if(!res || !res.ok) return;
    const data = await res.json().catch(()=>null);
    if(!data || !data.data) return;

    if(data.data.brand){
      saveJSON(KEY.brand, data.data.brand);
      applyBrand(getBrand());
      renderLoginBrand();
    }
    if(data.data.layout){
      saveJSON(KEY.layout, data.data.layout);
      restoreLayout();
    }
    if(data.data.theme){
      applyTheme(data.data.theme);
    }
    if(data.data.motion){
      applyMotion(data.data.motion);
    }
    if(data.data.glass){
      applyGlass(data.data.glass);
    }
    if(data.data.blur){
      applyBlur(data.data.blur);
    }
    if(data.data.widgetGap){
      localStorage.setItem("widget_gap_global", String(data.data.widgetGap));
      document.documentElement.style.setProperty("--widget-gap", `${data.data.widgetGap}px`);
    }
    if(Array.isArray(data.data.calendarEvents)){
      saveJSON(KEY.calendar, data.data.calendarEvents);
      renderCalendar();
    }
  }

  function renderSocial(){
    const state = getSocial();
    const profiles = getSocialProfile();
    const root = $("socialList");
    root.innerHTML = "";
    SOCIAL_PLATFORMS.forEach(p=>{
      const status = state[p] || "Not connected";
      const profile = profiles[p] || "";
      const label = profile ? `${status} • ${profile}` : status;
      const row = document.createElement("div");
      row.className = "social-item";
      row.innerHTML = `
        <div>
          <b>${p}</b> • <span>${label}</span>
        </div>
        <div class="pillrow">
          <button onclick="connectSocial('${p}')">Connect</button>
          <button onclick="disconnectSocial('${p}')">Disconnect</button>
          <button onclick="switchSocial('${p}')">Switch</button>
        </div>
      `;
      root.appendChild(row);
    });
    updateTiktokBadge();
  }

  // ====== Layout (drag to reorder + snap resize) ======
  const DEFAULT_LAYOUT = {
    order: ["inputs", "ideas", "plan", "live"],
    spans: {
      inputs: { c: 6, r: 22 },
      ideas: { c: 6, r: 22 },
      plan: { c: 12, r: 10 },
      live: { c: 12, r: 22 }
    },
    hidden: {
      inputs: false,
      ideas: false,
      plan: false,
      live: false
    }
  };
  let draggedId = null;

  function getLayout(){
    const saved = loadJSON(KEY.layout, {});
    return {
      ...DEFAULT_LAYOUT,
      ...saved,
      spans: { ...DEFAULT_LAYOUT.spans, ...(saved.spans || {}) },
      hidden: { ...DEFAULT_LAYOUT.hidden, ...(saved.hidden || {}) }
    };
  }

  function applySectionSize(el, colSpan, rowSpan){
    el.style.gridColumn = `span ${colSpan}`;
    el.style.gridRow = `span ${rowSpan}`;
  }

  function getDashboardRoot(){
    return $("widgets-dashboard") || $("sections");
  }

  function saveLayout(){
    const root = getDashboardRoot();
    if(!root) return;
    const selector = ".widget";
    const ids = Array.from(root.querySelectorAll(selector)).map(el=>el.dataset.widget);
    const spans = {};
    const hidden = {};
    Array.from(root.querySelectorAll(selector)).forEach(el=>{
      spans[el.dataset.widget] = {
        c: Number(el.dataset.colSpan || 6),
        r: Number(el.dataset.rowSpan || 10)
      };
      hidden[el.dataset.widget] = el.classList.contains("hidden");
    });
    saveJSON(KEY.layout, { order: ids, spans, hidden });
    scheduleSettingsSync();
  }

  function restoreLayout(){
    const root = getDashboardRoot();
    if(!root) return;
    const layout = getLayout();
    const order = layout.order;
    if(order && Array.isArray(order)){
      order.forEach(id=>{
        const el = root.querySelector(`.widget[data-widget="${id}"]`);
        if(el) root.appendChild(el);
      });
    }
    const spans = layout.spans || {};
    const hidden = layout.hidden || {};
    Array.from(root.querySelectorAll(".widget")).forEach(el=>{
      const id = el.dataset.widget;
      const span = spans[id] || DEFAULT_LAYOUT.spans[id] || { c: 6, r: 10 };
      el.dataset.colSpan = span.c;
      el.dataset.rowSpan = span.r;
      applyWidgetSize(el, span.c, span.r);
      if(hidden[id]) el.classList.add("hidden");
      else el.classList.remove("hidden");
    });
  }

  function initDrag(){
    const root = $("widgets-dashboard");
    if(!root) return;
    initWidgetDrag("dashboard", root);
  }

  function initResize(){
    const root = $("widgets-dashboard");
    if(!root) return;
    initWidgetResize("dashboard", root);
  }

  function applyPreset(name){
    const root = getDashboardRoot();
    if(!root) return;
    if(name === "analytics"){
      const preset = {
        order: ["live", "plan", "ideas", "inputs"],
        spans: {
          live: { c: 12, r: 22 },
          plan: { c: 12, r: 10 },
          ideas: { c: 6, r: 16 },
          inputs: { c: 6, r: 16 }
        },
        hidden: {
          inputs: true,
          ideas: false,
          plan: false,
          live: false
        }
      };
      saveJSON(KEY.layout, preset);
    }
    if(name === "two-column"){
      const preset = {
        order: ["inputs", "ideas", "plan", "live"],
        spans: {
          inputs: { c: 6, r: 18 },
          ideas: { c: 6, r: 18 },
          plan: { c: 12, r: 10 },
          live: { c: 12, r: 20 }
        },
        hidden: {
          inputs: false,
          ideas: false,
          plan: false,
          live: false
        }
      };
      saveJSON(KEY.layout, preset);
    }
    restoreLayout();
    updateVisibilityToggles();
    saveLayout();
  }

  // ====== Widget Pages (all pages) ======
  const WIDGET_PAGES = [
    { page: "welcome", id: "widgets-welcome" },
    { page: "company", id: "widgets-company" },
    { page: "calendar", id: "widgets-calendar" },
    { page: "dashboard", id: "widgets-dashboard" },
    { page: "email", id: "widgets-email" },
    { page: "housecall", id: "widgets-housecall" },
    { page: "estimator", id: "widgets-estimator" }
  ];

  function widgetKey(page){ return `widget_layout_${page}`; }

  function applyWidgetSize(el, c, r){
    el.style.gridColumn = `span ${c}`;
    el.style.gridRow = `span ${r}`;
  }

  function saveWidgetLayout(page, root){
    const ids = Array.from(root.querySelectorAll(".widget")).map(el=>el.dataset.widget);
    const spans = {};
    Array.from(root.querySelectorAll(".widget")).forEach(el=>{
      spans[el.dataset.widget] = {
        c: Number(el.dataset.colSpan || 6),
        r: Number(el.dataset.rowSpan || 10)
      };
    });
    saveJSON(widgetKey(page), { order: ids, spans });
  }

  function restoreWidgetLayout(page, root){
    const layout = loadJSON(widgetKey(page), null);
    if(layout && Array.isArray(layout.order)){
      layout.order.forEach(id=>{
        const el = root.querySelector(`.widget[data-widget="${id}"]`);
        if(el) root.appendChild(el);
      });
    }
    const spans = (layout && layout.spans) || {};
    Array.from(root.querySelectorAll(".widget")).forEach(el=>{
      const id = el.dataset.widget;
      const span = spans[id] || { c: 6, r: 10 };
      el.dataset.colSpan = span.c;
      el.dataset.rowSpan = span.r;
      applyWidgetSize(el, span.c, span.r);
    });
  }

  function initWidgetDrag(page, root){
    const widgets = Array.from(root.querySelectorAll(".widget"));
    let dragged = null;
    let pointerId = null;
    let placeholder = null;
    let dragFrame = 0;
    let lastPoint = null;
    let lastDropKey = "";

    function processDragPoint(){
      dragFrame = 0;
      if(!dragged || !lastPoint) return;
      const el = document.elementFromPoint(lastPoint.x, lastPoint.y);
      const over = el && el.closest(".widget");
      if(!over || over === dragged || !root.contains(over)) return;
      const rect = over.getBoundingClientRect();
      const before = lastPoint.y < rect.top + rect.height / 2;
      const dropKey = `${over.dataset.widget || ""}:${before ? "b" : "a"}`;
      if(dropKey === lastDropKey) return;
      lastDropKey = dropKey;
      if(before){
        root.insertBefore(placeholder, over);
      }else{
        root.insertBefore(placeholder, over.nextSibling);
      }
    }

    function scheduleDragPoint(e){
      lastPoint = { x: e.clientX, y: e.clientY };
      if(dragFrame) return;
      dragFrame = requestAnimationFrame(processDragPoint);
    }

    function finishDrag(e){
      if(!dragged || e.pointerId !== pointerId) return;
      if(dragFrame){
        cancelAnimationFrame(dragFrame);
        dragFrame = 0;
      }
      if(placeholder){
        root.insertBefore(dragged, placeholder);
        placeholder.remove();
        placeholder = null;
      }
      dragged.classList.remove("dragging");
      if(dragged.hasPointerCapture(pointerId)){
        dragged.releasePointerCapture(pointerId);
      }
      dragged = null;
      pointerId = null;
      lastPoint = null;
      lastDropKey = "";
      document.body.classList.remove("dragging-active");
      saveWidgetLayout(page, root);
    }

    widgets.forEach(w=>{
      w.setAttribute("draggable", "false");
      w.addEventListener("pointerdown", (e)=>{
        if(e.button !== 0) return;
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if(["input","textarea","select","button","label"].includes(tag)) return;
        if(e.target.isContentEditable) return;
        if(e.target.closest(".resize-handle")) return;
        dragged = w;
        pointerId = e.pointerId;
        w.classList.add("dragging");
        w.setPointerCapture(pointerId);
        document.body.classList.add("dragging-active");
        lastDropKey = "";
        lastPoint = { x: e.clientX, y: e.clientY };
        placeholder = document.createElement("div");
        placeholder.className = "widget drag-placeholder";
        placeholder.style.gridColumn = w.style.gridColumn || "span 6";
        placeholder.style.gridRow = w.style.gridRow || "span 10";
        root.insertBefore(placeholder, w.nextSibling);
      });
      w.addEventListener("pointermove", (e)=>{
        if(!dragged || e.pointerId !== pointerId) return;
        scheduleDragPoint(e);
      });
      w.addEventListener("pointerup", finishDrag);
      w.addEventListener("pointercancel", finishDrag);
    });
  }

  function initWidgetResize(page, root){
    const cols = 12;
    const rowHeight = 24;
    const minCols = 3;
    const maxCols = 12;
    const minRows = 6;
    const maxRows = 30;
    let active = null;
    let activePointerId = null;
    let resizeFrame = 0;
    let pointerPos = null;
    let gridRect = null;
    let activeRect = null;
    let gap = 16;

    function getGridMetrics(){
      const styles = window.getComputedStyle(root);
      const parsed = Number.parseFloat(styles.columnGap || styles.gap || "16");
      gap = Number.isFinite(parsed) ? parsed : 16;
      gridRect = root.getBoundingClientRect();
      activeRect = active ? active.getBoundingClientRect() : null;
    }

    function applyResizeStep(){
      resizeFrame = 0;
      if(!active || !pointerPos || !gridRect || !activeRect) return;
      const colWidth = (gridRect.width - gap * (cols - 1)) / cols;
      const colSpan = Math.max(
        minCols,
        Math.min(
          maxCols,
          Math.round((pointerPos.x - activeRect.left + colWidth / 2) / (colWidth + gap))
        )
      );
      const rowSpan = Math.max(
        minRows,
        Math.min(
          maxRows,
          Math.round((pointerPos.y - activeRect.top + rowHeight / 2) / (rowHeight + gap))
        )
      );
      if(
        Number(active.dataset.colSpan || 0) !== colSpan ||
        Number(active.dataset.rowSpan || 0) !== rowSpan
      ){
        active.dataset.colSpan = colSpan;
        active.dataset.rowSpan = rowSpan;
        applyWidgetSize(active, colSpan, rowSpan);
      }
    }

    function scheduleResize(e){
      pointerPos = { x: e.clientX, y: e.clientY };
      if(resizeFrame) return;
      resizeFrame = requestAnimationFrame(applyResizeStep);
    }

    function finishResize(){
      if(resizeFrame){
        cancelAnimationFrame(resizeFrame);
        resizeFrame = 0;
      }
      if(active){
        saveWidgetLayout(page, root);
      }
      active = null;
      activePointerId = null;
      pointerPos = null;
      activeRect = null;
      gridRect = null;
      document.body.classList.remove("dragging-active");
    }

    root.querySelectorAll(".resize-handle").forEach(handle=>{
      handle.addEventListener("pointerdown", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const w = handle.closest(".widget");
        if(!w) return;
        active = w;
        activePointerId = e.pointerId;
        handle.setPointerCapture(e.pointerId);
        document.body.classList.add("dragging-active");
        getGridMetrics();
        pointerPos = { x: e.clientX, y: e.clientY };
      });
      handle.addEventListener("pointermove", (e)=>{
        if(!active || e.pointerId !== activePointerId) return;
        scheduleResize(e);
      });
      handle.addEventListener("pointerup", finishResize);
      handle.addEventListener("pointercancel", finishResize);
    });
  }

  function setupWidgetPages(){
    WIDGET_PAGES.forEach(({ page, id })=>{
      const root = $(id);
      if(!root) return;
      Array.from(root.querySelectorAll(".widget")).forEach((w, idx)=>{
        if(!w.dataset.widget) w.dataset.widget = `${page}-${idx + 1}`;
        if(!w.querySelector(".drag-handle")){
          const h = document.createElement("div");
          h.className = "drag-handle";
          w.appendChild(h);
        }
        if(!w.querySelector(".resize-handle")){
          const r = document.createElement("div");
          r.className = "resize-handle";
          w.appendChild(r);
        }
      });
      restoreWidgetLayout(page, root);
      initWidgetDrag(page, root);
      initWidgetResize(page, root);
    });
  }

  function resetLayout(){
    saveJSON(KEY.layout, DEFAULT_LAYOUT);
    restoreLayout();
    updateVisibilityToggles();
    saveLayout();
  }

  function updateVisibilityToggles(){
    const layout = getLayout();
    const hidden = layout.hidden || {};
    $("toggleInputs").checked = !hidden.inputs;
    $("toggleIdeas").checked = !hidden.ideas;
    $("togglePlan").checked = !hidden.plan;
    $("toggleLive").checked = !hidden.live;
  }

  function bindVisibilityToggles(){
    const map = {
      toggleInputs: "inputs",
      toggleIdeas: "ideas",
      togglePlan: "plan",
      toggleLive: "live"
    };
    Object.keys(map).forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener("change", ()=>{
        const sectionId = map[id];
        const section = document.querySelector(`.widget[data-widget="${sectionId}"]`);
        if(!section) return;
        section.classList.toggle("hidden", !el.checked);
        saveLayout();
      });
    });
  }

  function bindMotionToggle(){
    const el = $("toggleMotion");
    if(!el) return;
    el.addEventListener("change", ()=>{
      applyMotion(el.checked ? "reduce" : "full");
      scheduleSettingsSync();
    });
  }

  function bindGlassSlider(){
    const slider = $("glassSlider");
    if(!slider) return;
    slider.addEventListener("input", ()=>{
      applyGlass(slider.value);
      scheduleSettingsSync();
    });
  }

  function bindBlurSlider(){
    const slider = $("blurSlider");
    if(!slider) return;
    slider.addEventListener("input", ()=>{
      applyBlur(slider.value);
      scheduleSettingsSync();
    });
  }

  function bindPageGap(){
    const slider = $("pageGap");
    if(!slider) return;
    slider.addEventListener("input", ()=>{
      localStorage.setItem("widget_gap_global", slider.value);
      document.documentElement.style.setProperty("--widget-gap", `${slider.value}px`);
    });
  }

  function setActiveSettingsLink(targetId){
    const links = document.querySelectorAll("[data-settings-link]");
    links.forEach(link => {
      const isActive = link.getAttribute("data-settings-link") === targetId;
      link.classList.toggle("active", isActive);
    });
  }

  function scrollToSettingsSection(targetId){
    const sec = $(targetId);
    if(!sec || sec.style.display === "none") return;
    sec.scrollIntoView({ behavior: "smooth", block: "start" });
    setActiveSettingsLink(targetId);
  }

  function filterSettingsCards(rawQuery){
    const query = String(rawQuery || "").trim().toLowerCase();
    const cards = document.querySelectorAll(".settings-card[data-settings-card]");
    cards.forEach(card => {
      if(card.dataset.hiddenByPage === "1"){
        card.style.display = "none";
        return;
      }
      if(!query){
        card.style.display = "";
        return;
      }
      const haystack = `${card.dataset.settingsCard || ""} ${card.textContent || ""}`.toLowerCase();
      card.style.display = haystack.includes(query) ? "" : "none";
    });

    const links = document.querySelectorAll("[data-settings-link]");
    let firstVisible = null;
    links.forEach(link => {
      const targetId = link.getAttribute("data-settings-link");
      const sec = targetId ? $(targetId) : null;
      const visible = !!sec && sec.style.display !== "none";
      link.style.display = visible ? "" : "none";
      if(visible && !firstVisible) firstVisible = targetId;
    });
    const active = document.querySelector("[data-settings-link].active");
    if(active && active.style.display === "none" && firstVisible){
      setActiveSettingsLink(firstVisible);
    }
  }

  function bindSettingsHUD(){
    const search = $("settingsSearch");
    if(search && search.dataset.bound !== "1"){
      search.addEventListener("input", ()=> filterSettingsCards(search.value));
      search.dataset.bound = "1";
    }
    document.querySelectorAll("[data-settings-link]").forEach(link => {
      if(link.dataset.bound === "1") return;
      link.addEventListener("click", (e)=>{
        e.preventDefault();
        const targetId = link.getAttribute("data-settings-link");
        if(targetId) scrollToSettingsSection(targetId);
      });
      link.dataset.bound = "1";
    });
  }

  function openSettings(){
    $("settingsModal").classList.add("open");
    bindSettingsHUD();
    const gap = localStorage.getItem("widget_gap_global") || "16";
    $("pageGap").value = gap;
    const params = new URLSearchParams(window.location.search);
    const page = params.get("page") || "company";
    const isMarketing = page === "dashboard";
    $("dashboardSettings").style.display = isMarketing ? "block" : "none";
    const secMarketing = $("sec-marketing");
    if(secMarketing){
      secMarketing.style.display = isMarketing ? "" : "none";
      secMarketing.dataset.hiddenByPage = isMarketing ? "0" : "1";
    }
    const navMarketing = $("settingsNavMarketing");
    if(navMarketing) navMarketing.style.display = isMarketing ? "block" : "none";

    const search = $("settingsSearch");
    if(search) search.value = "";

    const title = $("brandTitle");
    const profile = $("profileLabel");
    const avatar = $("profilePic");
    const settingsTitle = $("settingsBrandTitle");
    const settingsProfile = $("settingsProfileLabel");
    const settingsAvatar = $("settingsAvatarPreview");
    if(settingsTitle && title) settingsTitle.textContent = title.textContent || "AI Marketing Assistant";
    if(settingsProfile && profile) settingsProfile.textContent = profile.textContent || "Owner • Private";
    if(settingsAvatar && avatar && avatar.getAttribute("src")){
      settingsAvatar.src = avatar.getAttribute("src");
    }

    filterSettingsCards("");
    setActiveSettingsLink(isMarketing ? "sec-marketing" : "sec-appearance");
  }
  function closeSettings(){
    $("settingsModal").classList.remove("open");
  }

  function toggleLayout(){ }

  // ====== Live Analytics (TikTok) ======
  async function loadLiveAnalytics(){
    const out = $("liveOut");
    const kpi = $("liveKpi");
    const list = $("liveRecs");
    const best = $("bestTimes");
    const snapshots = $("snapshotList");
    out.textContent = "Loading live analytics...";
    kpi.innerHTML = "";
    list.innerHTML = "";
    best.innerHTML = "";
    snapshots.innerHTML = "";

    try{
      await fetch("/api/tiktok/snapshot", { method: "POST" });
      const res = await fetch("/api/tiktok/analytics", { cache: "no-store" });
      const data = await res.json();

      if(data.status === "not_connected"){
        out.textContent = data.message || "Connect TikTok to retrieve live analytics.";
        return;
      }
      if(data.status === "error"){
        out.textContent = data.message || "Unable to load analytics.";
        return;
      }

      const metrics = data.metrics || {};
      kpi.innerHTML = `
        <div class="box">
          <div class="big">${(metrics.totalViews || 0).toLocaleString()}</div>
          <div class="small">Total Views (latest posts)</div>
        </div>
        <div class="box">
          <div class="big">${((metrics.engagementRate || 0) * 100).toFixed(1)}%</div>
          <div class="small">Engagement Rate</div>
        </div>
        <div class="box">
          <div class="big">${(metrics.views7d || 0).toLocaleString()}</div>
          <div class="small">Views (last 7 days)</div>
        </div>
      `;

      const top = data.topPost;
      const user = data.user || {};
      if(user.display_name){
        setSocial("TikTok", "Connected");
        setSocialProfile("TikTok", user.display_name);
        loadSettingsFromServer();
      }
      const topLine = top
        ? `Top post: ${top.title || "Untitled"} — ${top.view_count || 0} views`
        : "Top post: —";

      out.textContent =
`TikTok Live Snapshot
Creator: ${user.display_name || "—"}
${topLine}
Average Views: ${(metrics.avgViews || 0).toLocaleString()}
Total Posts: ${(metrics.totalVideos || 0).toLocaleString()}`;

      const recs = data.recommendations || [];
      if(recs.length){
        recs.forEach(r=>{
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = r;
          list.appendChild(div);
        });
      }

      const times = data.bestTimes || [];
      if(times.length){
        times.forEach(t=>{
          const div = document.createElement("div");
          div.className = "item";
          const hourLabel = String(t.hour).padStart(2,"0") + ":00";
          div.textContent = `${hourLabel} — ${(t.engagementRate * 100).toFixed(1)}% ER across ${t.posts} posts`;
          best.appendChild(div);
        });
      }else{
        best.innerHTML = `<div class="sub">Not enough data yet to recommend a time.</div>`;
      }

      const snap = data.snapshots || [];
      if(snap.length){
        snap.forEach(s=>{
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = `${s.snapshot_date}: ${Number(s.total_views).toLocaleString()} views • ${(Number(s.engagement_rate) * 100).toFixed(1)}% ER`;
          snapshots.appendChild(div);
        });
      }else{
        snapshots.innerHTML = `<div class="sub">No snapshots yet.</div>`;
      }
    }catch(e){
      out.textContent = "Failed to load analytics. Try again.";
    }
  }

  // ====== Metrics ======
  function getMetrics(){ return loadJSON(KEY.metrics, []); }

  function saveMetric(){
    const m = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      date: $("mDate").value || todayISO,
      platform: $("mPlatform").value,
      type: $("mType").value,
      views: safeNum($("mViews").value),
      likes: safeNum($("mLikes").value),
      comments: safeNum($("mComments").value),
      saves: safeNum($("mSaves").value),
      shares: safeNum($("mShares").value),
      visits: safeNum($("mVisits").value),
      hook: $("mHook").value.trim(),
      notes: $("mNotes").value.trim()
    };

    const list = getMetrics();
    list.unshift(m);
    saveJSON(KEY.metrics, list);

    // clear a few fields
    ["mViews","mLikes","mComments","mSaves","mShares","mVisits","mHook","mNotes"].forEach(id=>$(id).value="");
    renderMetrics();
    renderKPIs();
  }

  function clearMetrics(){
    if(!confirm("Clear all saved metrics?")) return;
    saveJSON(KEY.metrics, []);
    $("perfOut").textContent = "Performance summary will appear here.";
    renderMetrics();
    renderKPIs();
  }

  function deleteMetric(id){
    const list = getMetrics().filter(x=>x.id!==id);
    saveJSON(KEY.metrics, list);
    renderMetrics();
    renderKPIs();
  }

  function renderMetrics(){
    const list = getMetrics();
    const root = $("metricList");
    root.innerHTML = "";
    list.slice(0, 12).forEach(m=>{
      const div = document.createElement("div");
      div.className = "item";
      const er = engagementRate(m);
      div.innerHTML = `
        <div class="meta">
          <span class="tag2">${m.platform}</span>
          <span class="tag">${m.type}</span>
          <span>${m.date}</span>
          <span>ER: <b>${(er*100).toFixed(1)}%</b></span>
        </div>
        <div style="margin-top:8px; font-weight:800">${m.views.toLocaleString()} views</div>
        <div class="meta" style="margin-top:6px">
          <span>❤️ ${m.likes}</span>
          <span>💬 ${m.comments}</span>
          <span>🔖 ${m.saves}</span>
          <span>↗️ ${m.shares}</span>
          <span>👤 ${m.visits}</span>
        </div>
        <div style="margin-top:8px; color: var(--muted); font-size:12px">
          <div><span class="mono">Hook:</span> ${escapeHtml(m.hook || "—")}</div>
          <div><span class="mono">Notes:</span> ${escapeHtml(m.notes || "—")}</div>
        </div>
        <div class="pillrow" style="margin-top:10px">
          <button onclick="deleteMetric('${m.id}')">Delete</button>
        </div>
      `;
      root.appendChild(div);
    });

    if(list.length === 0){
      root.innerHTML = `<div class="sub">No metrics saved yet. Add your first post stats above.</div>`;
    }
  }

  function engagementRate(m){
    const interactions = (m.likes + m.comments + m.saves + m.shares);
    return m.views > 0 ? interactions / m.views : 0;
  }

  function renderKPIs(){
    const list = getMetrics();
    const last7 = list.filter(m=>{
      const dt = new Date(m.date + "T00:00:00");
      const diffDays = (new Date() - dt) / (1000*60*60*24);
      return diffDays <= 7.5;
    });

    const sum = (arr, key)=> arr.reduce((a,x)=> a + safeNum(x[key]), 0);
    const totalViews = sum(last7, "views");
    const totalLikes = sum(last7, "likes");
    const totalComments = sum(last7, "comments");
    const totalSaves = sum(last7, "saves");
    const totalShares = sum(last7, "shares");

    const er = totalViews ? (totalLikes+totalComments+totalSaves+totalShares)/totalViews : 0;

    const root = $("kpiRow");
    root.innerHTML = `
      <div class="box">
        <div class="big">${totalViews.toLocaleString()}</div>
        <div class="small">Views (last 7 days)</div>
      </div>
      <div class="box">
        <div class="big">${((er||0)*100).toFixed(1)}%</div>
        <div class="small">Engagement Rate</div>
      </div>
      <div class="box">
        <div class="big">${(totalSaves+totalShares).toLocaleString()}</div>
        <div class="small">Saves + Shares</div>
      </div>
    `;
  }

  function summarizePerformance(){
    const list = getMetrics();
    if(list.length === 0){
      $("perfOut").textContent = "Add at least 1 metric entry first.";
      return;
    }

    const top = [...list].sort((a,b)=> engagementRate(b)-engagementRate(a)).slice(0,3);
    const weak = [...list].sort((a,b)=> engagementRate(a)-engagementRate(b)).slice(0,2);

    const bestTypes = countBy(list, "type");
    const bestHooks = top.map(m=>m.hook).filter(Boolean).slice(0,3);

    const insight =
`WHAT’S WORKING (based on your logged posts)
• Best post types lately: ${topKeys(bestTypes).join(", ") || "—"}
• Top hooks to repeat:
${bestHooks.length ? bestHooks.map(h=>"  - "+h).join("\n") : "  - (add hooks in your metric logs)"}

WHAT TO IMPROVE
• Lowest ER examples:
${weak.map(m=>`  - ${m.platform} ${m.type} on ${m.date} (ER ${(engagementRate(m)*100).toFixed(1)}%)`).join("\n")}

NEXT ACTIONS (simple)
1) Re-post your top-performing structure with a new job/topic (same hook pattern).
2) Add a clear CTA in the last 3 seconds: "${($("cta").value || "DM me and I’ll send pricing / next steps").trim()}".
3) Turn 1 winning video into: 1 short clip (15s), 1 full (60–90s), 1 carousel (IG), 1 story (IG).`;

    $("perfOut").textContent = insight;
  }

  function countBy(arr, key){
    return arr.reduce((m,x)=>{
      const k = x[key] || "—";
      m[k] = (m[k]||0)+1;
      return m;
    },{});
  }
  function topKeys(map){
    return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
  }

  // ====== Ideas ======
  function getIdeaContext(){
    saveInputs();
    const i = getInputs();
    return {
      ...i,
      pillar: $("pillar").value,
      topic: $("topic").value.trim(),
      audience: $("audience").value
    };
  }

  function setOut(text){
    $("ideaOut").textContent = text;
  }

  function generateHooks(){
    const c = getIdeaContext();
    const topic = c.topic ? `Topic: ${c.topic}` : `Topic: (use your current job / walkthrough)`;
    const hooks = [
      `“If you’re buying a home, watch this BEFORE you close…”`,
      `“This is the #1 mistake I see on ${c.pillar.toLowerCase()} jobs…”`,
      `“Here’s what this would cost IF you did it the right way…”`,
      `“I’m about to show you what most contractors won’t point out…”`,
      `“This is why your paint/job fails in 12–24 months…”`,
      `“3 things I look for in the first 60 seconds of a walkthrough…”`,
      `“Stop doing this to your house — it’s costing you thousands.”`,
      `“I’m not trying to scare you… but this is a real problem.”`
    ];

    setOut(
`HOOKS (${c.platform} • ${c.voice} • ${c.length})
Brand: ${c.brandName || "—"} | Market: ${c.market || "—"}
Pillar: ${c.pillar} | Audience: ${c.audience}
${topic}

Pick 1 hook and deliver it in the first 2 seconds:
${hooks.map((h,i)=>`${i+1}) ${h}`).join("\n")}

Quick CTA add-on:
“${c.cta || "DM me and I’ll send the next steps."}”`
    );
  }

  function generateScripts(){
    const c = getIdeaContext();
    const jobLine = c.topic ? `Job/Topic: ${c.topic}` : `Job/Topic: (add your current job here)`;
    const script =
`SCRIPT TEMPLATE (60–90s • ${c.style})
1) Hook (0–2s): [pick a hook]
2) Context (2–8s): “We’re at a home in ${c.market || "your area"} and I’m doing a quick ${c.pillar.toLowerCase()} walkthrough.”
3) The Problem (8–25s): Show 1–2 issues. Explain risk in simple terms.
4) The Fix (25–55s): Explain your process:
   • Prep (protect + cover + repair)
   • Correct materials (primer / caulk / proper products)
   • Clean finish (2 coats, edges, details)
5) Proof (55–75s): Show close-ups, texture, before/after, or estimate checklist.
6) CTA (last 10s): “${c.cta || "DM me for a quote or walkthrough."}”

B-ROLL SHOT LIST
• Wide front elevation • Close-up texture • Problem area • Material/tool shot • You talking to camera • Detail finish

ON-CAMERA LINES (use 2–3)
• “I’m going to show you exactly what we’d do here.”
• “This is what makes the difference between average and high-end.”
• “If you like how this looks, DM me and I’ll send details.”

${jobLine}
Services to weave in: ${c.services || "—"}`
    ;
    setOut(script);
  }

  function generateCaptions(){
    const c = getIdeaContext();
    const caps = [
      `Walkthrough time 🔍 If you’re buying this home, here’s what I’d fix first. ${c.cta || "DM me for details."}`,
      `This is how we keep it looking new — not “good for now.” ${c.cta || "DM me."}`,
      `Quick estimate walkthrough in ${c.market || "your area"} — what would you change on this exterior?`,
      `Luxury finish is all in the prep. Here’s the checklist we follow every time.`,
      `If you like the way this home looks, message me — I can connect you with the agent + help with the work.`
    ];

    setOut(
`CAPTION OPTIONS (${c.platform})
1) ${caps[0]}
2) ${caps[1]}
3) ${caps[2]}
4) ${caps[3]}
5) ${caps[4]}

COMMENT PROMPT (boost engagement)
• “Want me to price this out on camera? Comment ‘QUOTE’.”`
    );
  }

  function generateHashtags(){
    const c = getIdeaContext();
    const base = [
      "#homeimprovement", "#contractor", "#remodel", "#realestate", "#beforeandafter",
      "#exteriordesign", "#homeowners", "#renovation", "#diyvspro", "#propertymanagement"
    ];
    const local = c.market?.toLowerCase().includes("san diego")
      ? ["#sandiego", "#northcountysd", "#carlsbad", "#encinitas"]
      : ["#phoenix", "#tempe", "#chandler", "#eastvalley"];
    const niche =
      c.pillar.includes("Painting") ? ["#exteriorpainting", "#housepainting", "#stucco"] :
      c.pillar.includes("Electrical") ? ["#electrician", "#homesafety"] :
      c.pillar.includes("Luxury") ? ["#luxuryhomes", "#highendhomes"] :
      ["#walkthrough", "#contractorlife"];

    setOut(
`HASHTAGS (mix 8–14 total)
Local: ${local.join(" ")}
Niche: ${niche.join(" ")}
Base: ${base.slice(0,8).join(" ")}

Tip: rotate 3–5 hashtags each post so you don’t look spammy.`
    );
  }

  function generateAll(){
    // bundle output
    generateHooks();
    const hooks = $("ideaOut").textContent;
    generateScripts();
    const script = $("ideaOut").textContent;
    generateCaptions();
    const caps = $("ideaOut").textContent;
    generateHashtags();
    const tags = $("ideaOut").textContent;

    setOut(`${hooks}\n\n---\n\n${script}\n\n---\n\n${caps}\n\n---\n\n${tags}`);
  }

  function getIdeas(){ return loadJSON(KEY.ideas, []); }

  function saveIdea(){
    const text = $("ideaOut").textContent.trim();
    if(!text || text.includes("Click a generator button")){ alert("Generate something first."); return; }
    const c = getIdeaContext();
    const item = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      created: new Date().toISOString(),
      pillar: c.pillar,
      platform: c.platform,
      audience: c.audience,
      topic: c.topic || "—",
      text
    };
    const list = getIdeas();
    list.unshift(item);
    saveJSON(KEY.ideas, list);
    renderIdeas();
  }

  function clearIdeas(){
    if(!confirm("Clear all saved ideas?")) return;
    saveJSON(KEY.ideas, []);
    renderIdeas();
  }

  function deleteIdea(id){
    const list = getIdeas().filter(x=>x.id!==id);
    saveJSON(KEY.ideas, list);
    renderIdeas();
  }

  function renderIdeas(){
    const list = getIdeas();
    const root = $("ideaList");
    root.innerHTML = "";
    list.slice(0, 10).forEach(i=>{
      const div = document.createElement("div");
      div.className = "item";
      const when = new Date(i.created).toLocaleString();
      div.innerHTML = `
        <div class="meta">
          <span class="tag2">${i.platform}</span>
          <span class="tag">${i.pillar}</span>
          <span>${when}</span>
        </div>
        <div style="margin-top:8px; color:var(--muted); font-size:12px">
          <b>Topic:</b> ${escapeHtml(i.topic)}
        </div>
        <div class="out mono" style="margin-top:10px; min-height:auto">${escapeHtml(i.text)}</div>
        <div class="pillrow" style="margin-top:10px">
          <button onclick="copyText(${JSON.stringify(i.text)})">Copy</button>
          <button onclick="deleteIdea('${i.id}')">Delete</button>
        </div>
      `;
      root.appendChild(div);
    });

    if(list.length === 0){
      root.innerHTML = `<div class="sub">No saved ideas yet. Generate output and click “Save Output”.</div>`;
    }
  }

  // ====== 7-day plan ======
  function build7DayPlan(){
    const i = getInputs();
    const metrics = getMetrics();
    const topType = topKeys(countBy(metrics, "type"))[0] || "Walkthrough";
    const plan =
`7-DAY POSTING PLAN (repeat what works + build demand)
Brand: ${i.brandName || "—"} | Market: ${i.market || "—"} | Platforms: ${i.platform}
Goal: ${i.goal || "—"}

DAY 1: ${topType} — “Problem → Fix”
• Hook: “If you’re buying a home, watch this before you close…”
• CTA: ${i.cta || "DM me for details."}

DAY 2: Tip video (15–25s)
• “3 things to check before hiring anyone”

DAY 3: Behind-the-scenes (tools + materials)
• Show prep, masking, products, why you choose them (luxury finish)

DAY 4: Walkthrough estimate (60–90s)
• “What this would cost if done right” (steps/ranges)

DAY 5: Client win / before-after
• Show transformation + quick story

DAY 6: Realtor / property manager angle
• “How we turn a unit/home fast without cutting corners”

DAY 7: Brand deal bait
• “Here’s what I’d improve about this product if I was using it daily…”

Daily rule:
• Ask 1 question in every caption to force comments.
• Pin your best comment reply as a mini sales pitch.
`;
    $("planOut").textContent = plan;
    saveJSON(KEY.plan, plan);
  }

  function copyPlan(){
    const t = $("planOut").textContent.trim();
    if(!t) return;
    navigator.clipboard.writeText(t);
    alert("Plan copied.");
  }

  function clearPlan(){
    $("planOut").textContent = "Your plan will appear here.";
    localStorage.removeItem(KEY.plan);
  }

  // ====== Export ======
  function exportData(){
    const blob = new Blob([JSON.stringify({
      inputs: loadJSON(KEY.inputs, {}),
      metrics: loadJSON(KEY.metrics, []),
      ideas: loadJSON(KEY.ideas, []),
      plan: loadJSON(KEY.plan, "")
    }, null, 2)], {type:"application/json"});

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "marketing-assistant-export.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ====== Company calendar ======
  const CAL_CATEGORIES = {
    Estimate: { color: "rgba(59,130,246,.78)" },
    Job: { color: "rgba(16,185,129,.78)" },
    Marketing: { color: "rgba(251,191,36,.78)" },
    Meeting: { color: "rgba(139,92,246,.78)" }
  };
  const CAL_STATUSES = ["planned", "confirmed", "done", "canceled"];
  const CAL_PRIORITIES = ["low", "medium", "high"];
  const CAL_PRIORITY_RANK = { high: 3, medium: 2, low: 1 };
  const CAL_DEFAULT_PREFS = {
    viewMode: "week",
    status: "all",
    assignee: "all",
    sort: "soonest",
    search: "",
    selectedDate: todayISO,
    categories: Object.keys(CAL_CATEGORIES)
  };

  function parseDateISO(iso){
    if(!/^\d{4}-\d{2}-\d{2}$/.test(String(iso || ""))) return null;
    const [y, m, d] = String(iso).split("-").map(Number);
    const dt = new Date(y, m - 1, d);
    if(Number.isNaN(dt.getTime())) return null;
    return dt;
  }

  function normalizeTime(v, fallback){
    const m = String(v || "").trim().match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return fallback;
    const h = Math.max(0, Math.min(23, Number(m[1])));
    const mm = Math.max(0, Math.min(59, Number(m[2])));
    return `${pad(h)}:${pad(mm)}`;
  }

  function normalizeCalendarEvent(raw, idx){
    const safe = (raw && typeof raw === "object") ? raw : {};
    const parsedDate = parseDateISO(safe.date);
    const category = CAL_CATEGORIES[safe.category] ? safe.category : "Estimate";
    const status = CAL_STATUSES.includes(safe.status) ? safe.status : "planned";
    const priority = CAL_PRIORITIES.includes(safe.priority) ? safe.priority : "medium";
    const repeat = ["none", "daily", "weekly", "monthly"].includes(safe.repeat) ? safe.repeat : "none";
    const allDay = !!safe.allDay;
    let start = normalizeTime(safe.start, "09:00");
    let end = normalizeTime(safe.end, "10:00");
    if(allDay){
      start = "09:00";
      end = "17:00";
    }
    if(end <= start){
      end = "10:00";
    }
    return {
      id: String(safe.id || `e_${Date.now()}_${idx}`),
      title: String(safe.title || "Untitled Event").trim(),
      date: parsedDate ? formatDateISO(parsedDate) : todayISO,
      start,
      end,
      category,
      status,
      priority,
      repeat,
      allDay,
      assignee: String(safe.assignee || "").trim(),
      location: String(safe.location || "").trim(),
      notes: String(safe.notes || "").trim(),
      createdAt: Number(safe.createdAt || Date.now())
    };
  }

  function getCalendarEvents(){
    const raw = loadJSON(KEY.calendar, []);
    if(!Array.isArray(raw)) return [];
    return raw.map((evt, idx) => normalizeCalendarEvent(evt, idx))
      .sort((a, b) => `${a.date} ${a.start}`.localeCompare(`${b.date} ${b.start}`));
  }

  function saveCalendarEvents(events){
    const safe = Array.isArray(events) ? events : [];
    saveJSON(KEY.calendar, safe.map((evt, idx) => normalizeCalendarEvent(evt, idx)));
    scheduleSettingsSync();
  }

  function getCalendarPrefs(){
    const raw = loadJSON(KEY.calendarPrefs, {});
    const categories = Array.isArray(raw.categories)
      ? raw.categories.filter(cat => !!CAL_CATEGORIES[cat])
      : [];
    return {
      viewMode: ["week", "day", "agenda"].includes(raw.viewMode) ? raw.viewMode : CAL_DEFAULT_PREFS.viewMode,
      status: ["all", ...CAL_STATUSES].includes(raw.status) ? raw.status : CAL_DEFAULT_PREFS.status,
      assignee: typeof raw.assignee === "string" && raw.assignee ? raw.assignee : CAL_DEFAULT_PREFS.assignee,
      sort: ["soonest", "latest", "priority"].includes(raw.sort) ? raw.sort : CAL_DEFAULT_PREFS.sort,
      search: typeof raw.search === "string" ? raw.search : CAL_DEFAULT_PREFS.search,
      selectedDate: parseDateISO(raw.selectedDate) ? raw.selectedDate : CAL_DEFAULT_PREFS.selectedDate,
      categories: categories.length ? categories : [...CAL_DEFAULT_PREFS.categories]
    };
  }

  function saveCalendarPrefs(next){
    const prefs = getCalendarPrefs();
    const merged = { ...prefs, ...next };
    saveJSON(KEY.calendarPrefs, merged);
    return merged;
  }

  function toWeekStart(date){
    const d = new Date(date);
    const day = d.getDay();
    const diff = day === 0 ? -6 : 1 - day;
    d.setDate(d.getDate() + diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function formatDateISO(date){
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
  }

  function addDays(dateISO, days){
    const dt = parseDateISO(dateISO) || new Date();
    dt.setDate(dt.getDate() + days);
    return formatDateISO(dt);
  }

  function getCurrentWeekStart(){
    const raw = localStorage.getItem(KEY.calendarWeek);
    if(raw){
      const d = new Date(raw);
      if(!Number.isNaN(d.getTime())) return toWeekStart(d);
    }
    return toWeekStart(new Date());
  }

  function setCurrentWeekStart(date){
    localStorage.setItem(KEY.calendarWeek, formatDateISO(date));
  }

  function changeCalendarWeek(delta){
    const start = getCurrentWeekStart();
    start.setDate(start.getDate() + delta * 7);
    setCurrentWeekStart(start);
    saveCalendarPrefs({ selectedDate: formatDateISO(start) });
    renderCalendar();
  }

  function jumpCalendarToToday(){
    setCurrentWeekStart(toWeekStart(new Date()));
    saveCalendarPrefs({ selectedDate: todayISO });
    renderCalendar();
    setActivePage("calendar");
  }

  function changeCalendarMonth(delta){
    const prefs = getCalendarPrefs();
    const selected = parseDateISO(prefs.selectedDate) || new Date();
    selected.setMonth(selected.getMonth() + delta);
    const nextDate = formatDateISO(selected);
    setCurrentWeekStart(toWeekStart(selected));
    saveCalendarPrefs({ selectedDate: nextDate });
    renderCalendar();
  }

  function setCalendarSelectedDate(dateISO){
    const parsed = parseDateISO(dateISO);
    if(!parsed) return;
    saveCalendarPrefs({ selectedDate: formatDateISO(parsed) });
    setCurrentWeekStart(toWeekStart(parsed));
    renderCalendar();
  }

  function focusCalendarCreate(){
    setActivePage("calendar");
    const prefs = getCalendarPrefs();
    if($("calDate")) $("calDate").value = prefs.selectedDate;
    const title = $("calTitle");
    if(title) title.focus();
  }

  function timeToMins(t){
    const [h, m] = String(t || "00:00").split(":").map(Number);
    return (h * 60) + m;
  }

  function hasTimeOverlap(aStart, aEnd, bStart, bEnd){
    return timeToMins(aStart) < timeToMins(bEnd) && timeToMins(bStart) < timeToMins(aEnd);
  }

  function expandEventInRange(evt, startISO, endISO){
    const out = [];
    const startDate = parseDateISO(startISO);
    const endDate = parseDateISO(endISO);
    if(!startDate || !endDate) return out;
    if(evt.repeat === "none"){
      if(evt.date >= startISO && evt.date <= endISO){
        out.push({ ...evt, sourceId: evt.id, occurrenceDate: evt.date });
      }
      return out;
    }
    let occ = parseDateISO(evt.date);
    if(!occ) return out;
    let guard = 0;
    while(formatDateISO(occ) < startISO && guard < 2400){
      guard++;
      if(evt.repeat === "daily") occ.setDate(occ.getDate() + 1);
      else if(evt.repeat === "weekly") occ.setDate(occ.getDate() + 7);
      else occ.setMonth(occ.getMonth() + 1);
    }
    while(formatDateISO(occ) <= endISO && guard < 2600){
      guard++;
      const iso = formatDateISO(occ);
      out.push({ ...evt, sourceId: evt.id, occurrenceDate: iso, date: iso });
      if(evt.repeat === "daily") occ.setDate(occ.getDate() + 1);
      else if(evt.repeat === "weekly") occ.setDate(occ.getDate() + 7);
      else occ.setMonth(occ.getMonth() + 1);
    }
    return out;
  }

  function matchesCalendarFilters(evt, prefs){
    if(!prefs.categories.includes(evt.category)) return false;
    if(prefs.status !== "all" && evt.status !== prefs.status) return false;
    if(prefs.assignee !== "all" && (evt.assignee || "") !== prefs.assignee) return false;
    const q = String(prefs.search || "").trim().toLowerCase();
    if(!q) return true;
    const hay = `${evt.title} ${evt.notes} ${evt.location} ${evt.assignee}`.toLowerCase();
    return hay.includes(q);
  }

  function getCalendarOccurrences(startISO, endISO){
    const prefs = getCalendarPrefs();
    const events = getCalendarEvents();
    const occurrences = [];
    events.forEach(evt => {
      expandEventInRange(evt, startISO, endISO).forEach(occ => {
        if(matchesCalendarFilters(occ, prefs)){
          occurrences.push(occ);
        }
      });
    });
    occurrences.sort((a, b) => `${a.date} ${a.start}`.localeCompare(`${b.date} ${b.start}`));
    return occurrences;
  }

  function syncCalendarFilters(events){
    const prefs = getCalendarPrefs();
    if($("calSearch")) $("calSearch").value = prefs.search;
    if($("calViewMode")) $("calViewMode").value = prefs.viewMode;
    if($("calFilterStatus")) $("calFilterStatus").value = prefs.status;
    if($("calSort")) $("calSort").value = prefs.sort;

    const assignees = [...new Set(events.map(e => e.assignee).filter(Boolean))].sort((a, b) => a.localeCompare(b));
    const assigneeSel = $("calFilterAssignee");
    if(assigneeSel){
      const keep = prefs.assignee;
      assigneeSel.innerHTML = `<option value="all">All assignees</option>${assignees.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join("")}`;
      assigneeSel.value = assignees.includes(keep) ? keep : "all";
      if(assigneeSel.value !== keep){
        saveCalendarPrefs({ assignee: assigneeSel.value });
      }
    }

    const categoryRoot = $("calendarCategories");
    if(categoryRoot){
      const counts = events.reduce((acc, e) => {
        acc[e.category] = (acc[e.category] || 0) + 1;
        return acc;
      }, {});
      categoryRoot.innerHTML = Object.keys(CAL_CATEGORIES).map(cat => {
        const checked = prefs.categories.includes(cat) ? "checked" : "";
        const color = CAL_CATEGORIES[cat].color;
        return `
          <div class="calendar-filter-chip">
            <label class="left">
              <input type="checkbox" ${checked} onchange="toggleCalendarCategory('${cat}')"/>
              <span class="dot" style="background:${color}"></span>
              <span>${cat}</span>
            </label>
            <span class="count">${counts[cat] || 0}</span>
          </div>
        `;
      }).join("");
    }
  }

  function toggleCalendarCategory(category){
    const prefs = getCalendarPrefs();
    const next = new Set(prefs.categories);
    if(next.has(category)) next.delete(category);
    else next.add(category);
    const safe = [...next].filter(cat => !!CAL_CATEGORIES[cat]);
    saveCalendarPrefs({ categories: safe.length ? safe : Object.keys(CAL_CATEGORIES) });
    renderCalendar();
  }

  function setCalendarForm(evt){
    const safe = evt ? normalizeCalendarEvent(evt, 0) : null;
    $("calEditId").value = safe ? safe.id : "";
    $("calTitle").value = safe ? safe.title : "";
    $("calDate").value = safe ? safe.date : (getCalendarPrefs().selectedDate || todayISO);
    $("calCategory").value = safe ? safe.category : "Estimate";
    $("calStart").value = safe ? safe.start : "09:00";
    $("calEnd").value = safe ? safe.end : "10:00";
    $("calStatus").value = safe ? safe.status : "planned";
    $("calPriority").value = safe ? safe.priority : "medium";
    $("calAssignee").value = safe ? safe.assignee : "";
    $("calLocation").value = safe ? safe.location : "";
    $("calRepeat").value = safe ? safe.repeat : "none";
    $("calAllDay").checked = safe ? !!safe.allDay : false;
    $("calNotes").value = safe ? safe.notes : "";
    const isAllDay = $("calAllDay").checked;
    $("calStart").disabled = isAllDay;
    $("calEnd").disabled = isAllDay;

    const editing = !!safe;
    $("calFormTitle").textContent = editing ? "Edit Event" : "Create Event";
    $("calSaveBtn").textContent = editing ? "Update Event" : "Save Event";
    $("calCancelBtn").style.display = editing ? "inline-flex" : "none";
    $("calDuplicateBtn").style.display = editing ? "inline-flex" : "none";
  }

  function cancelCalendarEdit(){
    setCalendarForm(null);
  }

  function duplicateEditingCalendarEvent(){
    const editId = $("calEditId").value;
    if(!editId) return;
    const current = getCalendarEvents().find(e => e.id === editId);
    if(!current) return;
    const dup = {
      ...current,
      id: `e_${Date.now()}`,
      date: $("calDate").value || current.date,
      title: `${current.title} (Copy)`,
      createdAt: Date.now()
    };
    const events = getCalendarEvents();
    events.push(dup);
    saveCalendarEvents(events);
    setCalendarForm(dup);
    renderCalendar();
  }

  function readCalendarFormEvent(){
    const editId = $("calEditId").value || "";
    const allDay = $("calAllDay").checked;
    const payload = normalizeCalendarEvent({
      id: editId || `e_${Date.now()}`,
      title: $("calTitle").value,
      date: $("calDate").value,
      category: $("calCategory").value,
      start: allDay ? "09:00" : $("calStart").value,
      end: allDay ? "17:00" : $("calEnd").value,
      status: $("calStatus").value,
      priority: $("calPriority").value,
      assignee: $("calAssignee").value,
      location: $("calLocation").value,
      repeat: $("calRepeat").value,
      allDay,
      notes: $("calNotes").value,
      createdAt: Date.now()
    }, 0);
    return payload;
  }

  function findCalendarConflict(events, payload){
    return events.find(evt => {
      if(evt.id === payload.id) return false;
      if(evt.status === "canceled" || payload.status === "canceled") return false;
      if(evt.date !== payload.date) return false;
      return hasTimeOverlap(evt.start, evt.end, payload.start, payload.end);
    });
  }

  function addCalendarEvent(){
    const payload = readCalendarFormEvent();
    if(!payload.title || !payload.date || !payload.start || !payload.end){
      alert("Enter title, date, start time, and end time.");
      return;
    }
    if(payload.end <= payload.start){
      alert("End time must be after start time.");
      return;
    }
    const events = getCalendarEvents();
    const conflict = findCalendarConflict(events, payload);
    if(conflict){
      const proceed = confirm(`Time conflict with "${conflict.title}" (${conflict.start}-${conflict.end}). Save anyway?`);
      if(!proceed) return;
    }
    const idx = events.findIndex(e => e.id === payload.id);
    if(idx >= 0) events[idx] = payload;
    else events.push(payload);
    saveCalendarEvents(events);
    setCalendarForm(null);
    renderCalendar();
  }

  function removeCalendarEvent(id){
    const events = getCalendarEvents().filter(e => e.id !== id);
    saveCalendarEvents(events);
    renderCalendar();
  }

  function toggleCalendarEventStatus(id){
    const events = getCalendarEvents();
    const idx = events.findIndex(e => e.id === id);
    if(idx < 0) return;
    events[idx].status = events[idx].status === "done" ? "planned" : "done";
    saveCalendarEvents(events);
    renderCalendar();
  }

  function editCalendarEvent(id, occurrenceDate){
    const evt = getCalendarEvents().find(e => e.id === id);
    if(!evt) return;
    const next = { ...evt };
    if(occurrenceDate && parseDateISO(occurrenceDate)){
      next.date = occurrenceDate;
    }
    setCalendarForm(next);
    focusCalendarCreate();
  }

  function sortCalendarQueue(events, sort){
    const copy = [...events];
    if(sort === "latest"){
      copy.sort((a, b) => `${b.date} ${b.start}`.localeCompare(`${a.date} ${a.start}`));
      return copy;
    }
    if(sort === "priority"){
      copy.sort((a, b) => {
        const p = (CAL_PRIORITY_RANK[b.priority] || 0) - (CAL_PRIORITY_RANK[a.priority] || 0);
        if(p) return p;
        return `${a.date} ${a.start}`.localeCompare(`${b.date} ${b.start}`);
      });
      return copy;
    }
    copy.sort((a, b) => `${a.date} ${a.start}`.localeCompare(`${b.date} ${b.start}`));
    return copy;
  }

  function bindCalendarControls(){
    const bind = (id, event, fn) => {
      const el = $(id);
      if(!el || el.dataset.bound === "1") return;
      el.addEventListener(event, fn);
      el.dataset.bound = "1";
    };
    bind("calSearch", "input", () => {
      saveCalendarPrefs({ search: $("calSearch").value });
      renderCalendar();
    });
    bind("calViewMode", "change", () => {
      saveCalendarPrefs({ viewMode: $("calViewMode").value });
      renderCalendar();
    });
    bind("calFilterStatus", "change", () => {
      saveCalendarPrefs({ status: $("calFilterStatus").value });
      renderCalendar();
    });
    bind("calFilterAssignee", "change", () => {
      saveCalendarPrefs({ assignee: $("calFilterAssignee").value });
      renderCalendar();
    });
    bind("calSort", "change", () => {
      saveCalendarPrefs({ sort: $("calSort").value });
      renderCalendar();
    });
    bind("calAllDay", "change", () => {
      const locked = $("calAllDay").checked;
      $("calStart").disabled = locked;
      $("calEnd").disabled = locked;
      if(locked){
        $("calStart").value = "09:00";
        $("calEnd").value = "17:00";
      }
    });
  }

  let calendarRenderFrame = 0;
  let calendarRenderForce = false;
  function renderCalendar(force = false){
    calendarRenderForce = calendarRenderForce || !!force;
    if(calendarRenderFrame) return;
    calendarRenderFrame = requestAnimationFrame(()=>{
      const shouldForce = calendarRenderForce;
      calendarRenderForce = false;
      calendarRenderFrame = 0;
      const activePage = document.querySelector('.page[data-page="calendar"]');
      const isActive = !!(activePage && activePage.classList.contains("active"));
      if(!shouldForce && !isActive) return;
      renderCalendarNow();
    });
  }

  function renderCalendarNow(){
    const events = getCalendarEvents();
    const prefs = getCalendarPrefs();
    syncCalendarFilters(events);

    const selectedDate = parseDateISO(prefs.selectedDate) ? prefs.selectedDate : todayISO;
    const selected = parseDateISO(selectedDate) || new Date();
    const weekStart = toWeekStart(selected);
    setCurrentWeekStart(weekStart);
    const weekStartISO = formatDateISO(weekStart);
    const weekEndISO = addDays(weekStartISO, 6);

    let boardStartISO = weekStartISO;
    let boardEndISO = weekEndISO;
    let boardTitle = "Weekly Planner";
    if(prefs.viewMode === "day"){
      boardStartISO = selectedDate;
      boardEndISO = selectedDate;
      boardTitle = "Daily Planner";
    } else if(prefs.viewMode === "agenda"){
      boardStartISO = selectedDate;
      boardEndISO = addDays(selectedDate, 45);
      boardTitle = "Agenda";
    }
    const rangeEl = $("calendarRange");
    if(rangeEl){
      if(prefs.viewMode === "day"){
        rangeEl.textContent = selected.toLocaleDateString(undefined, { weekday: "long", month: "short", day: "numeric", year: "numeric" });
      } else if(prefs.viewMode === "week"){
        const weekStartDate = parseDateISO(weekStartISO) || selected;
        const weekEndDate = parseDateISO(weekEndISO) || selected;
        rangeEl.textContent = `${weekStartDate.toLocaleDateString(undefined, { month: "short", day: "numeric" })} - ${weekEndDate.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" })}`;
      } else {
        const endView = parseDateISO(boardEndISO) || selected;
        rangeEl.textContent = `${selected.toLocaleDateString(undefined, { month: "short", day: "numeric" })} - ${endView.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" })}`;
      }
    }
    const title = $("calendarBoardTitle");
    if(title) title.textContent = boardTitle;
    const monthLabel = $("calendarMonthLabel");
    if(monthLabel) monthLabel.textContent = selected.toLocaleDateString(undefined, { month: "long", year: "numeric" });
    const selectedHint = $("calendarSelectedHint");
    if(selectedHint){
      selectedHint.textContent = `Selected: ${selected.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" })}`;
    }
    const boardHint = $("calendarBoardHint");
    if(boardHint){
      boardHint.textContent = prefs.viewMode === "agenda"
        ? "Agenda mode hides the planner grid and focuses on the event queue below."
        : "Click any event block to edit quickly.";
    }

    const timeCol = $("calendarTimeCol");
    if(timeCol){
      timeCol.innerHTML = "";
      for(let h = 6; h <= 20; h++){
        const div = document.createElement("div");
        div.className = "t";
        div.textContent = `${pad(h)}:00`;
        timeCol.appendChild(div);
      }
    }

    const board = $("calendarBoard");
    const weekGrid = $("calendarWeekGrid");
    if(board && weekGrid){
      board.style.display = prefs.viewMode === "agenda" ? "none" : "grid";
      if(prefs.viewMode === "day") weekGrid.classList.add("single-day");
      else weekGrid.classList.remove("single-day");
      weekGrid.innerHTML = "";
      const dayCount = prefs.viewMode === "day" ? 1 : 7;
      const occurrences = getCalendarOccurrences(boardStartISO, boardEndISO);
      for(let i = 0; i < dayCount; i++){
        const day = parseDateISO(boardStartISO) || new Date();
        day.setDate(day.getDate() + i);
        const iso = formatDateISO(day);
        const col = document.createElement("div");
        col.className = "calendar-day-col";
        col.innerHTML = `
          <div class="calendar-day-head">
            <span>${day.toLocaleDateString(undefined, { weekday: "short" })}</span>
            <strong>${day.getDate()}</strong>
          </div>
          <div class="calendar-day-body" data-day="${iso}"></div>
        `;
        const body = col.querySelector(".calendar-day-body");
        occurrences.filter(e => e.date === iso).forEach(evt => {
          const startM = Math.max(6 * 60, timeToMins(evt.start));
          const endM = Math.min(21 * 60, timeToMins(evt.end));
          const top = ((startM - (6 * 60)) / 60) * 60;
          const height = Math.max(28, ((endM - startM) / 60) * 60);
          const block = document.createElement("div");
          const c = CAL_CATEGORIES[evt.category]?.color || "rgba(125,211,252,.7)";
          block.className = "cal-event";
          if(evt.status === "done") block.classList.add("status-done");
          if(evt.status === "canceled") block.classList.add("status-canceled");
          block.style.top = `${top + 4}px`;
          block.style.height = `${height - 8}px`;
          block.style.background = c;
          block.title = evt.notes || evt.title;
          block.innerHTML = `
            <div class="title">${escapeHtml(evt.title)}</div>
            <div class="time">${escapeHtml(evt.start)} - ${escapeHtml(evt.end)}</div>
            <div class="meta">${escapeHtml(evt.assignee || evt.location || evt.category)}</div>
          `;
          block.addEventListener("click", () => editCalendarEvent(evt.sourceId || evt.id, evt.date));
          body.appendChild(block);
        });
        weekGrid.appendChild(col);
      }
    }

    const visibleInWindow = getCalendarOccurrences(boardStartISO, boardEndISO);
    const filterSummary = $("calendarFilterSummary");
    if(filterSummary){
      filterSummary.textContent = `Showing ${visibleInWindow.length} event${visibleInWindow.length === 1 ? "" : "s"} in ${prefs.viewMode} view`;
    }

    const todayEvents = getCalendarOccurrences(todayISO, todayISO).filter(e => e.status !== "canceled");
    const weekEvents = getCalendarOccurrences(weekStartISO, weekEndISO).filter(e => e.status !== "canceled");
    const weekHours = weekEvents.reduce((sum, e) => sum + Math.max(0, (timeToMins(e.end) - timeToMins(e.start)) / 60), 0);
    const openCount = events.filter(e => !["done", "canceled"].includes(e.status)).length;
    if($("calStatTodayCount")) $("calStatTodayCount").textContent = String(todayEvents.length);
    if($("calStatWeekHours")) $("calStatWeekHours").textContent = `${weekHours.toFixed(1)}h`;
    if($("calStatOpenCount")) $("calStatOpenCount").textContent = String(openCount);

    const list = $("calendarEventList");
    if(list){
      const queueStart = prefs.selectedDate || todayISO;
      const queueEnd = addDays(queueStart, 60);
      const upcoming = sortCalendarQueue(getCalendarOccurrences(queueStart, queueEnd), prefs.sort);
      list.innerHTML = upcoming.map(e => `
        <div class="widget-item event-queue-item">
          <div class="head">
            <div>
              <strong>${escapeHtml(e.title)}</strong>
              <div class="sub">${escapeHtml(e.date)} • ${escapeHtml(e.start)}-${escapeHtml(e.end)}</div>
            </div>
            <span class="pill">${escapeHtml(e.category)}</span>
          </div>
          <div class="badges">
            <span class="pill">Status: ${escapeHtml(e.status)}</span>
            <span class="pill">Priority: ${escapeHtml(e.priority)}</span>
            ${e.assignee ? `<span class="pill">Assignee: ${escapeHtml(e.assignee)}</span>` : ""}
            ${e.location ? `<span class="pill">Location: ${escapeHtml(e.location)}</span>` : ""}
            ${e.repeat !== "none" ? `<span class="pill">Repeats: ${escapeHtml(e.repeat)}</span>` : ""}
          </div>
          ${e.notes ? `<div class="sub" style="margin-top:6px">${escapeHtml(e.notes)}</div>` : ""}
          <div class="actions">
            <button onclick="editCalendarEvent('${e.sourceId || e.id}', '${e.date}')">Edit</button>
            <button onclick="toggleCalendarEventStatus('${e.sourceId || e.id}')">${e.status === "done" ? "Mark Open" : "Mark Done"}</button>
            <button onclick="editCalendarEvent('${e.sourceId || e.id}', '${e.date}'); duplicateEditingCalendarEvent()">Duplicate</button>
            <button class="danger" onclick="removeCalendarEvent('${e.sourceId || e.id}')">Delete</button>
          </div>
        </div>
      `).join("") || `<div class="sub">No events yet.</div>`;
    }

    const mini = $("calendarMiniMonth");
    if(mini){
      mini.innerHTML = "";
      const monthStart = new Date(selected.getFullYear(), selected.getMonth(), 1);
      const firstDay = monthStart.getDay();
      const padCount = firstDay === 0 ? 6 : firstDay - 1;
      for(let i = 0; i < padCount; i++){
        const blank = document.createElement("div");
        blank.className = "d";
        mini.appendChild(blank);
      }
      const monthEnd = new Date(selected.getFullYear(), selected.getMonth() + 1, 0).getDate();
      for(let d = 1; d <= monthEnd; d++){
        const date = new Date(selected.getFullYear(), selected.getMonth(), d);
        const iso = formatDateISO(date);
        const cell = document.createElement("div");
        cell.className = "d";
        cell.textContent = String(d);
        if(iso >= boardStartISO && iso <= boardEndISO){
          cell.classList.add("in-week");
        }
        if(iso === selectedDate) cell.classList.add("selected");
        const count = events.filter(e => e.date === iso).length;
        cell.title = `${iso}${count ? ` • ${count} event${count === 1 ? "" : "s"}` : ""}`;
        cell.addEventListener("click", () => setCalendarSelectedDate(iso));
        mini.appendChild(cell);
      }
    }
  }

  function initCalendar(){
    if($("calDate") && !$("calDate").value){
      $("calDate").value = formatDateISO(new Date());
    }
    bindCalendarControls();
    setCalendarForm(null);
    renderCalendar();
  }

  // ====== Utilities ======
  function copyText(t){
    navigator.clipboard.writeText(t);
    alert("Copied.");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function hydrate(){
    renderLoginBrand();
    hydrateInputs();
    hydrateBrand();
    bindPageNav();
    setupWidgetPages();
    restoreLayout();
    initDrag();
    initResize();
    bindVisibilityToggles();
    updateVisibilityToggles();
    bindMotionToggle();
    bindGlassSlider();
    bindBlurSlider();
    bindPageGap();
    initCalendar();
    renderMetrics();
    renderKPIs();
    renderIdeas();
    renderSocial();
    applyTheme(localStorage.getItem(KEY.theme) || "dark");
    applyMotion(localStorage.getItem(KEY.motion) || "full");
    applyGlass(localStorage.getItem(KEY.glass) || (document.body.classList.contains("light") ? "0.22" : "0.022"));
    applyBlur(localStorage.getItem(KEY.blur) || "18");

    const savedPlan = loadJSON(KEY.plan, "");
    if(savedPlan) $("planOut").textContent = savedPlan;

    const params = new URLSearchParams(window.location.search);
    const tiktok = params.get("tiktok");
    const message = params.get("message");
    if(tiktok === "connected"){
      setSocial("TikTok", "Connected");
      loadSettingsFromServer();
      loadLiveAnalytics();
    }else if(tiktok === "missing-config"){
      setSocial("TikTok", "Needs setup");
      if(message) $("liveOut").textContent = decodeURIComponent(message);
    }else if(tiktok === "error"){
      setSocial("TikTok", "Error");
      if(message) $("liveOut").textContent = decodeURIComponent(message);
    }
    if(tiktok){
      const url = new URL(window.location.href);
      url.searchParams.delete("tiktok");
      url.searchParams.delete("message");
      window.history.replaceState({}, "", url.toString());
    }
  }

  // Auto-set date on load
  window.addEventListener("load", async ()=>{
    $("mDate").value = todayISO;
    document.body.classList.remove("layout-locked");
    await loadPublicSettings().catch(()=>{});
    const gap = localStorage.getItem("widget_gap_global") || "16";
    document.documentElement.style.setProperty("--widget-gap", `${gap}px`);
    renderLoginBrand();
    applyTheme(localStorage.getItem(KEY.theme) || "dark");
    applyMotion(localStorage.getItem(KEY.motion) || "full");
    applyGlass(localStorage.getItem(KEY.glass) || (document.body.classList.contains("light") ? "0.22" : "0.022"));
    applyBlur(localStorage.getItem(KEY.blur) || "18");
    const user = await getCurrentSessionUser();
    if(user){
      applyCurrentUser(user);
      showApp();
    }
  });
</script>
</body>
</html>
