<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Private AI Marketing Assistant — Rosario</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
    :root{
      --bg:#0b0f12;
      --bg2:#15171a;
      --card:#121a27;
      --muted:#9aa4b2;
      --text:#e8eef7;
      --line:#1d2a3b;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: "SF Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "San Francisco", system-ui, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --panel: rgba(14, 20, 30, .78);
      --glass-opacity: .022;
      --glass-strong-opacity: .045;
      --glass-border-opacity: .16;
      --glass-highlight-opacity: .35;
      --glass: rgba(255,255,255,var(--glass-opacity));
      --glass-strong: rgba(255,255,255,var(--glass-strong-opacity));
      --blur: 18px;
      --glow: 0 24px 60px rgba(0,0,0,.45);
      --bg-spot: rgba(255,170,102,.16);
      --bg-spot2: rgba(255,214,170,.14);
      --bg-ambient: rgba(255,255,255,.04);
      --noise-opacity:.04;
      --blob1: rgba(255,170,102,.20);
      --blob2: rgba(255,214,170,.18);
      --blob3: rgba(214,123,90,.14);
      --bg-sheen: rgba(255,220,180,.08);
      --glass-border: rgba(255,255,255,var(--glass-border-opacity));
      --glass-border-light: rgba(15,23,42,.12);
      --glass-highlight: rgba(255,255,255,var(--glass-highlight-opacity));
      --section-title: 14px;
      --section-text: 12px;
    }
    body.light{
      --bg:#f2ebe3;
      --bg2:#e9ddd1;
      --card:#ffffff;
      --muted:#4a5565;
      --text:#0b1220;
      --line:#cfd7e3;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --panel: rgba(255,255,255,.90);
      --glass-opacity: .22;
      --glass-strong-opacity: .38;
      --glass-border-opacity: .12;
      --glass-highlight-opacity: .65;
      --glass: rgba(255,255,255,var(--glass-opacity));
      --glass-strong: rgba(255,255,255,var(--glass-strong-opacity));
      --bg-spot: rgba(255,170,102,.14);
      --bg-spot2: rgba(255,214,170,.12);
      --bg-ambient: rgba(120,95,70,.06);
      --shadow: 0 12px 30px rgba(15,23,42,.10);
      --glow: 0 20px 50px rgba(15,23,42,.10);
      --noise-opacity:.05;
      --blob1: rgba(255,170,102,.20);
      --blob2: rgba(255,214,170,.18);
      --blob3: rgba(214,123,90,.16);
      --bg-sheen: rgba(255,220,180,.35);
      --glass-border: rgba(15,23,42,var(--glass-border-opacity));
      --glass-highlight: rgba(255,255,255,.65);
    }
    @media (max-width: 720px){
      body{ --blur: 10px; }
      :root{
        --glow: 0 16px 40px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--bg-spot), transparent 55%),
        radial-gradient(900px 500px at 80% -20%, var(--bg-spot2), transparent 55%),
        radial-gradient(700px 500px at 40% 80%, var(--bg-ambient), transparent 60%),
        radial-gradient(900px 700px at 10% 90%, var(--bg-sheen), transparent 65%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color:var(--text);
    }
    body::before{
      content:"";
      position:fixed; inset:-10%;
      background:
        radial-gradient(420px 320px at 18% 12%, var(--blob1), transparent 60%),
        radial-gradient(520px 360px at 78% 18%, var(--blob2), transparent 60%),
        radial-gradient(560px 420px at 30% 80%, var(--blob3), transparent 60%);
      filter: blur(30px);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.6'/%3E%3C/svg%3E");
      opacity: var(--noise-opacity, .04);
      mix-blend-mode: soft-light;
      pointer-events:none;
      z-index:-1;
    }
    a{color:var(--accent)}
    .wrap{max-width:1180px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--glass-border);border-radius:var(--radius);
      background:var(--glass-strong);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--glow);
      position:sticky; top:14px; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 80%, #fff 20%), color-mix(in srgb, var(--accent2) 80%, #fff 20%));
      box-shadow: 0 10px 24px rgba(125,211,252,.12);
      display:grid;place-items:center;overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand p{margin:2px 0 0 0;color:var(--muted);font-size:12px}
    .topbar-actions{display:flex;align-items:center;gap:12px}
    .profile{
      display:flex;align-items:center;gap:10px;border:1px solid var(--line);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:6px 10px;border-radius:999px;
    }
    .avatar{
      width:28px;height:28px;border-radius:50%;
      background: linear-gradient(135deg, rgba(125,211,252,.4), rgba(167,139,250,.4));
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .profile .meta{font-size:12px;color:var(--muted)}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      cursor:pointer;
      border:1px solid var(--glass-border);
      background: rgba(255,255,255,.02);
      backdrop-filter: blur(var(--blur));
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      transition:.2s transform, .2s opacity, .2s border-color, .2s box-shadow;
    }
    button:hover{
      transform:translateY(-1px);
      border-color: rgba(255,255,255,.45);
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    button.primary{
      border-color: rgba(255,255,255,.45);
      background: rgba(255,255,255,.04);
    }
    button.danger{border-color: rgba(251,113,133,.55)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .topbar{position:relative; top:0}
    }
    .card{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:var(--radius);
      box-shadow: var(--glow);
      padding:16px;
      position:relative;
      height:100%;
      overflow:auto;
      min-height:0;
      will-change: transform;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      border-radius:inherit;
      pointer-events:none;
      background: linear-gradient(140deg, var(--glass-highlight), rgba(255,255,255,0) 45%);
      opacity:.6;
    }
    .card::after{
      content:"";
      position:absolute;
      left:14px; right:14px; top:10px;
      height:26px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0));
      opacity:.35;
      pointer-events:none;
    }
    .card h2{font-size:var(--section-title)}
    .card .sub, .card label, .card input, .card select, .card textarea, .card .item, .card .pill, .card .mini{
      font-size:var(--section-text);
    }
    .sections{
      display:grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap:16px;
      grid-auto-rows: 24px;
      grid-auto-flow: row dense;
      margin-top:16px;
    }
    @media (max-width: 980px){
      .sections{grid-template-columns:1fr}
    }
    @media (max-width: 720px){
      .wrap{padding:14px}
      .topbar{flex-direction:column;align-items:flex-start;gap:10px}
      .topbar-actions{width:100%;justify-content:space-between;flex-wrap:wrap}
      .btnrow{justify-content:flex-start}
      .profile{order:2}
      .brand h1{font-size:14px}
      .brand p{font-size:11px}
      .row, .row3, .split{grid-template-columns:1fr}
      .sections{gap:12px}
      .card{padding:14px}
      .drag-handle, .resize-handle{display:none}
      .modal .panel{width:94vw;max-height:90vh}
      body::after{opacity:.025}
    }
    @media (max-width: 480px){
      .topbar{padding:12px}
      button{padding:9px 10px}
      .kpi{grid-template-columns:1fr}
    }
    .section{
      position:relative;
      min-height:0;
    }
    .section.drag-over .card{
      outline:2px dashed rgba(125,211,252,.6);
      outline-offset:4px;
    }
    .section.drag-placeholder{
      border:2px dashed rgba(125,211,252,.5);
      border-radius:var(--radius);
      min-height:140px;
      background: rgba(125,211,252,.06);
    }
    .section.hover-top::before,
    .section.hover-bottom::after{
      content:"";
      position:absolute;
      left:0; right:0;
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(125,211,252,.9), transparent);
    }
    .section.hover-top::before{top:-6px}
    .section.hover-bottom::after{bottom:-6px}
    .drag-handle{
      position:absolute;
      top:10px; right:10px;
      border:1px solid var(--line);
      background: rgba(9,14,22,.6);
      color: var(--muted);
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      cursor:grab;
      user-select:none;
      z-index:2;
    }
    .drag-handle:active{cursor:grabbing}
    .resize-handle{
      position:absolute;
      width:18px;height:18px;
      right:10px;bottom:10px;
      border:1px solid var(--line);
      border-radius:6px;
      background: rgba(9,14,22,.6);
      cursor:se-resize;
      z-index:2;
    }
    .layout-locked .drag-handle,
    .layout-locked .resize-handle{display:none}
    .section.hidden{display:none}
    .modal{
      position:fixed; inset:0;
      background: rgba(4,6,10,.65);
      display:none; align-items:center; justify-content:center;
      z-index:50;
    }
    .modal.open{display:flex}
    .modal .panel{
      width:min(920px, 94vw);
      max-height:86vh;
      overflow:auto;
      border:1px solid var(--glass-border);
      background: var(--glass-strong);
      backdrop-filter: blur(var(--blur));
      border-radius:20px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal .panel h2{margin-top:0}
    .toggle{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:8px 10px;border-radius:12px;
      font-size:12px;color:var(--muted);
    }
    .toggle input{margin:0}
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .sub{color:var(--muted);font-size:12px;margin:0 0 14px 0;line-height:1.4}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;flex-direction:column;gap:8px;margin-bottom:12px;
    }
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      border:1px solid var(--glass-border);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(var(--blur));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
    }
    .reduce-motion *{
      transition:none !important;
      animation:none !important;
      scroll-behavior:auto !important;
    }
    textarea{min-height:86px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color: rgba(125,211,252,.55)}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      color: var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--muted)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .kpi{
      display:grid;grid-template-columns: repeat(3, 1fr);
      gap:14px;margin-top:12px;
    }
    .kpi + .out{margin-top:14px}
    @media (max-width: 520px){
      .kpi{grid-template-columns:1fr}
      .row, .row3{grid-template-columns:1fr}
    }
    .kpi .box{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:16px;
      padding:14px;
    }
    .kpi .big{font-size:20px;font-weight:800;letter-spacing:.2px}
    .kpi .small{font-size:12px;color:var(--muted);margin-top:2px}
    .split{
      display:grid;grid-template-columns: 1fr 1fr; gap:10px;
    }
    .mono{font-family:var(--mono)}
    .out{
      white-space:pre-wrap;
      border:1px dashed rgba(125,211,252,.35);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:14px;border-radius:16px;
      min-height:120px;
      line-height:1.45;
      font-size:var(--section-text);
    }
    .mini{
      font-size:12px;color:var(--muted);line-height:1.5;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:10px 12px;border-radius:16px;
    }
    .list{
      display:flex;flex-direction:column;gap:12px;margin-top:14px;
    }
    .item{
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      border-radius:16px;
      padding:14px;
    }
    .item .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:12px}
    .tag{
      font-size:12px;
      border:1px solid rgba(167,139,250,.35);
      padding:4px 8px;border-radius:999px;color:rgba(167,139,250,.95)
    }
    .tag2{
      font-size:12px;
      border:1px solid rgba(125,211,252,.35);
      padding:4px 8px;border-radius:999px;color:rgba(125,211,252,.95)
    }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none !important}
    .login{
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:22px;
    }
    .login .panel{
      max-width:520px;width:100%;
      border:1px solid var(--glass-border);
      background: var(--glass-strong);
      backdrop-filter: blur(var(--blur));
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .login-logo{
      width:96px;height:96px;border-radius:999px;
      margin:0 auto 12px auto;
      background: linear-gradient(135deg, rgba(125,211,252,.35), rgba(167,139,250,.35));
      display:grid;place-items:center;overflow:hidden;
      border:1px solid rgba(125,211,252,.3);
    }
    .login-logo img{width:100%;height:100%;object-fit:cover}
    .login h1{margin:0 0 6px 0;font-size:18px}
    .login p{margin:0 0 14px 0;color:var(--muted);font-size:12px;line-height:1.5}
    .notice{
      font-size:12px;color:var(--muted);line-height:1.5;
      border:1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.08);
      padding:10px 12px;border-radius:16px;
    }
    .badge{
      font-size:11px;border:1px solid rgba(125,211,252,.4);
      padding:3px 8px;border-radius:999px;color:rgba(125,211,252,.95)
    }
    .tiktok-badge{
      display:inline-flex;align-items:center;gap:6px;
      border-color: rgba(148,163,184,.45);
      color: var(--muted);
    }
    .tiktok-badge::before{
      content:"";
      width:6px;height:6px;border-radius:999px;
      background: var(--muted);
      box-shadow: 0 0 6px rgba(148,163,184,.4);
    }
    .tiktok-badge.connected{
      border-color: rgba(52,211,153,.6);
      color: var(--good);
    }
    .tiktok-badge.connected::before{
      background: var(--good);
      box-shadow: 0 0 8px rgba(52,211,153,.6);
    }
    .tiktok-badge.needs{
      border-color: rgba(251,191,36,.6);
      color: var(--warn);
    }
    .tiktok-badge.needs::before{
      background: var(--warn);
      box-shadow: 0 0 8px rgba(251,191,36,.5);
    }
    .tiktok-badge.error{
      border-color: rgba(251,113,133,.6);
      color: var(--bad);
    }
    .tiktok-badge.error::before{
      background: var(--bad);
      box-shadow: 0 0 8px rgba(251,113,133,.5);
    }
    .social-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .social-item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      padding:10px;border-radius:14px;font-size:12px;color:var(--muted);
    }
  </style>
</head>
<body>
  <!-- LOGIN GATE -->
  <div id="loginView" class="login">
    <div class="panel">
      <div class="login-logo" id="loginLogo">
        <img id="loginLogoImg" alt="Brand logo" class="hidden"/>
      </div>
      <h1>Private AI Marketing Assistant</h1>
      <p>Local-only dashboard for tracking, monitoring, and generating TikTok/Instagram content ideas for your business.</p>
      <div class="notice">
        This is a simple privacy gate for a static site. If you need true private login, we can upgrade it later.
      </div>
      <div class="hr"></div>
      <div class="field">
        <label>Enter password</label>
        <input id="pw" type="password" placeholder="Click 'First time? Set password' on first run"/>
      </div>
      <button class="primary" onclick="login()">Unlock</button>
      <button onclick="firstTimeSet()">First time? Set password</button>
      <p class="sub" style="margin-top:12px">Tip: Keep this link private. Use a strong password.</p>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" id="brandLogo">
            <img id="brandLogoImg" alt="Brand logo" class="hidden"/>
          </div>
          <div>
            <h1 id="brandTitle">Rosario’s AI Marketing Assistant</h1>
            <p id="brandTagline">Private dashboard</p>
            <div class="pillrow">
              <span class="badge" id="todayLine">Today</span>
              <span class="badge tiktok-badge" id="tiktokBadge">TikTok: Not connected</span>
            </div>
          </div>
        </div>
        <div class="topbar-actions">
          <div class="profile">
            <div class="avatar" id="brandAvatar">
              <img id="brandAvatarImg" alt="Profile avatar" class="hidden"/>
            </div>
            <div class="meta" id="profileLabel">Owner • Private</div>
          </div>
          <div class="btnrow">
            <button onclick="openSettings()">Settings</button>
            <button onclick="toggleLayout()" id="layoutToggleBtn">Customize Layout</button>
            <button onclick="toggleTheme()" id="themeToggleBtn">Light Mode</button>
            <button class="primary" onclick="generateAll()">Generate Ideas</button>
            <button onclick="build7DayPlan()">Build 7-Day Plan</button>
            <button onclick="exportData()">Export</button>
            <button class="danger" onclick="logout()">Lock</button>
          </div>
        </div>
      </div>

      <div class="sections" id="sections">
        <!-- LEFT -->
        <section class="section" data-section="inputs">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
          <h2>1) Inputs (what the assistant uses)</h2>
          <p class="sub">Fill these out once, then update weekly. The generator uses your niche, offers, voice, and current focus.</p>

          <div class="row">
            <div class="field">
              <label>Brand / Business</label>
              <input id="brandName" placeholder="Arizona Residential Private Contracting"/>
            </div>
            <div class="field">
              <label>Market (City/Area)</label>
              <input id="market" placeholder="Phoenix East Valley + (San Diego expansion)"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Platforms</label>
              <select id="platform">
                <option value="TikTok">TikTok</option>
                <option value="Instagram">Instagram</option>
                <option value="Both" selected>Both</option>
              </select>
            </div>
            <div class="field">
              <label>Content Style</label>
              <select id="style">
                <option value="Reality-style / behind-the-scenes" selected>Reality-style / behind-the-scenes</option>
                <option value="Educational (tips + how-to)">Educational (tips + how-to)</option>
                <option value="Storytelling (before/after + client wins)">Storytelling (before/after + client wins)</option>
                <option value="Luxury / high-end vibe">Luxury / high-end vibe</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Primary Services to Promote (comma-separated)</label>
              <input id="services" placeholder="Exterior painting, remodels, electrical, property management turnovers"/>
            </div>
            <div class="field">
              <label>Current Offer / CTA</label>
              <input id="cta" placeholder="DM me for a quote / walkthrough / connect with agent"/>
            </div>
          </div>

          <div class="field">
            <label>What are you trying to achieve this month?</label>
            <textarea id="goal" placeholder="Example: Get more high-end remodel leads + attract brand deals (tools, paint, home tech, etc.)."></textarea>
          </div>

          <div class="row">
            <div class="field">
              <label>Your Voice (pick one)</label>
              <select id="voice">
                <option value="Confident + friendly" selected>Confident + friendly</option>
                <option value="Luxury + professional">Luxury + professional</option>
                <option value="Funny + bold">Funny + bold</option>
                <option value="Straight shooter (no fluff)">Straight shooter (no fluff)</option>
              </select>
            </div>
            <div class="field">
              <label>Video Length Target</label>
              <select id="length">
                <option value="15–25 seconds">15–25 seconds</option>
                <option value="30–45 seconds">30–45 seconds</option>
                <option value="60–90 seconds" selected>60–90 seconds</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <h2>2) Tracking + Monitoring (manual metrics)</h2>
          <p class="sub">Log post performance. The assistant summarizes what’s working and what to repeat.</p>

          <div class="row3">
            <div class="field">
              <label>Date</label>
              <input id="mDate" type="date"/>
            </div>
            <div class="field">
              <label>Platform</label>
              <select id="mPlatform">
                <option>TikTok</option>
                <option>Instagram</option>
              </select>
            </div>
            <div class="field">
              <label>Post Type</label>
              <select id="mType">
                <option>Walkthrough</option>
                <option>Before/After</option>
                <option>Tip/How-to</option>
                <option>Client story</option>
                <option>Tool/Material</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div class="row3">
            <div class="field">
              <label>Views</label>
              <input id="mViews" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Likes</label>
              <input id="mLikes" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Comments</label>
              <input id="mComments" type="number" placeholder="0"/>
            </div>
          </div>

          <div class="row3">
            <div class="field">
              <label>Saves</label>
              <input id="mSaves" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Shares</label>
              <input id="mShares" type="number" placeholder="0"/>
            </div>
            <div class="field">
              <label>Profile Visits</label>
              <input id="mVisits" type="number" placeholder="0"/>
            </div>
          </div>

          <div class="field">
            <label>Hook used (first line)</label>
            <input id="mHook" placeholder="Example: This is why most paint jobs fail in year 2…"/>
          </div>
          <div class="field">
            <label>Notes (what happened / why it worked)</label>
            <textarea id="mNotes" placeholder="Example: Hook was strong, before/after was clean, used trending audio, asked a question."></textarea>
          </div>

          <div class="pillrow">
            <button class="primary" onclick="saveMetric()">Save Metric</button>
            <button onclick="summarizePerformance()">Summarize Performance</button>
            <button class="danger" onclick="clearMetrics()">Clear Metrics</button>
          </div>

          <div class="kpi" id="kpiRow"></div>
          <div class="out mono" id="perfOut">Performance summary will appear here.</div>

          <div class="list" id="metricList"></div>
          </div>
        </section>

        <!-- RIGHT -->
        <section class="section" data-section="ideas">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
          <h2>Idea Generator</h2>
          <p class="sub">Generates hooks, scripts, captions, and hashtags based on your niche + goals.</p>

          <div class="field">
            <label>Pick a Content Pillar</label>
            <select id="pillar">
              <option value="Exterior Painting">Exterior Painting</option>
              <option value="Luxury Remodeling">Luxury Remodeling</option>
              <option value="Property Management / Turnovers">Property Management / Turnovers</option>
              <option value="Electrical / Safety">Electrical / Safety</option>
              <option value="Client Stories / Wins" selected>Client Stories / Wins</option>
              <option value="Tools / Materials / Behind-the-scenes">Tools / Materials / Behind-the-scenes</option>
            </select>
          </div>

          <div class="field">
            <label>Current Topic / Job (optional)</label>
            <input id="topic" placeholder="Example: exterior estimate walkthrough, stucco trim, black shingles, etc."/>
          </div>

          <div class="field">
            <label>Audience</label>
            <select id="audience">
              <option value="Homeowners">Homeowners</option>
              <option value="Luxury homeowners" selected>Luxury homeowners</option>
              <option value="Property managers / Realtors">Property managers / Realtors</option>
              <option value="Brands (tools, paint, home tech)">Brands (tools, paint, home tech)</option>
            </select>
          </div>

          <div class="split">
            <button class="primary" onclick="generateHooks()">Hooks</button>
            <button class="primary" onclick="generateScripts()">Scripts</button>
            <button class="primary" onclick="generateCaptions()">Captions</button>
            <button class="primary" onclick="generateHashtags()">Hashtags</button>
          </div>

          <div class="hr"></div>
          <h2>Output</h2>
          <div class="out mono" id="ideaOut">Click a generator button to create content ideas.</div>

          <div class="hr"></div>
          <h2>Saved Ideas</h2>
          <div class="pillrow">
            <button onclick="saveIdea()">Save Output</button>
            <button class="danger" onclick="clearIdeas()">Clear Saved</button>
          </div>
          <div class="list" id="ideaList"></div>
          </div>
        </section>

        <section class="section" data-section="plan">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
        <h2>7-Day Posting Plan</h2>
        <p class="sub">Based on your current goals + performance. Copy/paste into notes or a scheduler.</p>
        <div class="pillrow">
          <button class="primary" onclick="build7DayPlan()">Generate Plan</button>
          <button onclick="copyPlan()">Copy Plan</button>
          <button class="danger" onclick="clearPlan()">Clear Plan</button>
        </div>
        <div class="out mono" id="planOut">Your plan will appear here.</div>
          </div>
        </section>

        <section class="section" data-section="live">
          <div class="drag-handle" draggable="true">Move</div>
          <div class="resize-handle"></div>
          <div class="card">
        <h2>Live Analytics (TikTok)</h2>
        <p class="sub">Connect TikTok to pull live stats + recommendations.</p>
        <div class="pillrow">
          <button class="primary" onclick="loadLiveAnalytics()">Refresh Live Data</button>
        </div>
        <div class="kpi" id="liveKpi"></div>
        <div class="out mono" id="liveOut">Connect TikTok to see live data.</div>
        <div class="hr"></div>
        <h2>Best Time To Post</h2>
        <p class="sub">Based on your recent TikTok performance.</p>
        <div class="list" id="bestTimes"></div>
        <div class="hr"></div>
        <h2>Daily Snapshots</h2>
        <p class="sub">Automatic daily rollups (stored locally).</p>
        <div class="list" id="snapshotList"></div>
        <div class="list" id="liveRecs"></div>
          </div>
        </section>
      </div>

      <!-- SETTINGS MODAL -->
      <div class="modal" id="settingsModal">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <h2>Settings</h2>
            <button onclick="closeSettings()">Close</button>
          </div>

          <h2>Layout Presets</h2>
          <div class="pillrow">
            <button onclick="applyPreset('analytics')">Analytics Focus</button>
            <button onclick="applyPreset('two-column')">Two Column</button>
            <button onclick="resetLayout()">Reset Layout</button>
          </div>

          <div class="hr"></div>
          <h2>Section Visibility</h2>
          <div class="pillrow">
            <label class="toggle"><input type="checkbox" id="toggleInputs"/> Inputs</label>
            <label class="toggle"><input type="checkbox" id="toggleIdeas"/> Ideas</label>
            <label class="toggle"><input type="checkbox" id="togglePlan"/> 7‑Day Plan</label>
            <label class="toggle"><input type="checkbox" id="toggleLive"/> Live Analytics</label>
          </div>

          <div class="hr"></div>
          <h2>Motion</h2>
          <div class="pillrow">
            <label class="toggle"><input type="checkbox" id="toggleMotion"/> Reduce Motion</label>
          </div>

          <div class="hr"></div>
          <h2>Glass Transparency</h2>
          <div class="row">
            <div class="field">
              <label>Opacity (lower = clearer glass)</label>
              <input id="glassSlider" type="range" min="0.01" max="0.30" step="0.005"/>
            </div>
            <div class="field">
              <label>Current</label>
              <input id="glassValue" type="text" readonly/>
            </div>
          </div>

          <div class="hr"></div>
          <h2>Glass Blur</h2>
          <div class="row">
            <div class="field">
              <label>Blur (px)</label>
              <input id="blurSlider" type="range" min="6" max="28" step="1"/>
            </div>
            <div class="field">
              <label>Current</label>
              <input id="blurValue" type="text" readonly/>
            </div>
          </div>

          <div class="hr"></div>
          <h2>Brand Studio</h2>
          <p class="sub">Update colors, logo, and profile without editing the file.</p>

          <div class="row">
            <div class="field">
              <label>Brand Title</label>
              <input id="brandTitleInput" placeholder="Rosario’s AI Marketing Assistant"/>
            </div>
            <div class="field">
              <label>Tagline / Status</label>
              <input id="brandTaglineInput" placeholder="Private dashboard • Phoenix AZ"/>
            </div>
          </div>

          <div class="field">
            <label>Profile Label</label>
            <input id="profileLabelInput" placeholder="Owner • Private"/>
          </div>

          <div class="row">
            <div class="field">
              <label>Primary Accent</label>
              <input id="accentColor" type="color"/>
            </div>
            <div class="field">
              <label>Secondary Accent</label>
              <input id="accent2Color" type="color"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Background Color</label>
              <input id="bgColor" type="color"/>
            </div>
            <div class="field">
              <label>Card / Panel Color</label>
              <input id="cardColor" type="color"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Logo Image (square works best)</label>
              <input id="logoUpload" type="file" accept="image/*"/>
            </div>
            <div class="field">
              <label>Profile Avatar</label>
              <input id="avatarUpload" type="file" accept="image/*"/>
            </div>
          </div>

          <div class="pillrow">
            <button onclick="resetBrand()">Reset Brand</button>
          </div>

          <div class="hr"></div>
          <h2>Social Accounts (Live Data)</h2>
          <p class="sub">Connect accounts to pull analytics. Requires a backend + API keys.</p>
          <div class="mini">
            Live analytics needs OAuth and platform approvals. I can wire this up once you’re ready.
          </div>
          <div class="social-list" id="socialList"></div>

          <div class="hr"></div>
          <div class="field">
            <label>Change Password</label>
            <input id="newPw" type="password" placeholder="New password"/>
          </div>
          <button onclick="setPassword()">Update Password</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== Storage keys ======
  const KEY = {
    pw: "arm_ai_pw",
    inputs: "arm_ai_inputs",
    metrics: "arm_ai_metrics",
    ideas: "arm_ai_ideas",
    plan: "arm_ai_plan",
    brand: "arm_ai_brand",
    social: "arm_ai_social",
    socialProfile: "arm_ai_social_profile",
    layout: "arm_ai_layout",
    theme: "arm_ai_theme",
    motion: "arm_ai_motion",
    glass: "arm_ai_glass",
    blur: "arm_ai_blur",
    session: "arm_ai_session"
  };

  // ====== Helpers ======
  const $ = (id) => document.getElementById(id);
  const now = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  const todayISO = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;

  function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch(e){
      return fallback;
    }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function setTodayLine(){
    const d = new Date();
    const pretty = d.toLocaleString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
    const line = $("todayLine");
    if(line) line.textContent = `Today: ${pretty}`;
    $("mDate").value = todayISO;
  }

  // ====== Login ======
  function firstTimeSet(){
    const existing = localStorage.getItem(KEY.pw);
    if(existing){
      alert("Password already set. If you forgot it, clear localStorage for this site in your browser settings.");
      return;
    }
    const p1 = prompt("Set a password for this dashboard (store somewhere safe):");
    if(!p1 || p1.length < 6){ alert("Password too short. Use 6+ characters."); return; }
    localStorage.setItem(KEY.pw, hash(p1));
    alert("Password set. Now log in.");
  }

  function login(){
    const stored = localStorage.getItem(KEY.pw);
    if(!stored){
      alert("No password set yet. Click 'First time? Set password'.");
      return;
    }
    const entered = $("pw").value || "";
    if(hash(entered) === stored){
      $("loginView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      localStorage.setItem(KEY.session, "1");
      setTodayLine();
      hydrate();
    }else{
      alert("Wrong password.");
    }
  }

  function logout(){
    $("pw").value = "";
    localStorage.removeItem(KEY.session);
    $("loginView").classList.remove("hidden");
    $("appView").classList.add("hidden");
  }

  // Simple hash (privacy gate only — not secure auth)
  function hash(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0).toString(16);
  }

  function setPassword(){
    const np = $("newPw").value || "";
    if(np.length < 6){ alert("Use at least 6 characters."); return; }
    localStorage.setItem(KEY.pw, hash(np));
    $("newPw").value = "";
    alert("Password updated.");
  }

  // ====== Inputs ======
  function getInputs(){
    return {
      brandName: $("brandName").value.trim(),
      market: $("market").value.trim(),
      platform: $("platform").value,
      style: $("style").value,
      services: $("services").value.trim(),
      cta: $("cta").value.trim(),
      goal: $("goal").value.trim(),
      voice: $("voice").value,
      length: $("length").value
    };
  }

  function saveInputs(){
    saveJSON(KEY.inputs, getInputs());
  }

  function hydrateInputs(){
    const i = loadJSON(KEY.inputs, {});
    if(i.brandName) $("brandName").value = i.brandName;
    if(i.market) $("market").value = i.market;
    if(i.platform) $("platform").value = i.platform;
    if(i.style) $("style").value = i.style;
    if(i.services) $("services").value = i.services;
    if(i.cta) $("cta").value = i.cta;
    if(i.goal) $("goal").value = i.goal;
    if(i.voice) $("voice").value = i.voice;
    if(i.length) $("length").value = i.length;

    // Autosave on input
    ["brandName","market","platform","style","services","cta","goal","voice","length"].forEach(id=>{
      $(id).addEventListener("input", saveInputs);
      $(id).addEventListener("change", saveInputs);
    });
  }

  // ====== Brand Studio ======
  const DEFAULT_BRAND = {
    title: "Rosario’s AI Marketing Assistant",
    tagline: "Private dashboard",
    accent: "#7dd3fc",
    accent2: "#a78bfa",
    bg: "#0b0f14",
    card: "#121a27",
    logo: "",
    avatar: "",
    profileLabel: "Owner • Private"
  };

  function getBrand(){
    return { ...DEFAULT_BRAND, ...loadJSON(KEY.brand, {}) };
  }

  function hexToRgba(hex, alpha){
    const h = hex.replace("#","").trim();
    if(h.length !== 6) return `rgba(18, 26, 39, ${alpha})`;
    const r = parseInt(h.slice(0,2), 16);
    const g = parseInt(h.slice(2,4), 16);
    const b = parseInt(h.slice(4,6), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function applyBrand(b){
    document.documentElement.style.setProperty("--accent", b.accent);
    document.documentElement.style.setProperty("--accent2", b.accent2);
    document.documentElement.style.setProperty("--bg", b.bg);
    document.documentElement.style.setProperty("--card", b.card);
    document.documentElement.style.setProperty("--panel", hexToRgba(b.card, 0.78));
    $("brandTitle").textContent = b.title || DEFAULT_BRAND.title;
    $("brandTagline").textContent = b.tagline || DEFAULT_BRAND.tagline;
    $("profileLabel").textContent = b.profileLabel || DEFAULT_BRAND.profileLabel;

    if(b.logo){
      $("brandLogoImg").src = b.logo;
      $("brandLogoImg").classList.remove("hidden");
    }else{
      $("brandLogoImg").classList.add("hidden");
    }

    if(b.avatar){
      $("brandAvatarImg").src = b.avatar;
      $("brandAvatarImg").classList.remove("hidden");
    }else{
      $("brandAvatarImg").classList.add("hidden");
    }
  }

  function saveBrand(partial){
    const next = { ...getBrand(), ...partial };
    saveJSON(KEY.brand, next);
    applyBrand(next);
    scheduleSettingsSync();
  }

  function resetBrand(){
    if(!confirm("Reset brand settings to default?")) return;
    saveJSON(KEY.brand, DEFAULT_BRAND);
    hydrateBrand();
    scheduleSettingsSync();
  }

  function readImageFile(input, cb){
    const file = input.files && input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => cb(String(reader.result || ""));
    reader.readAsDataURL(file);
  }

  function hydrateBrand(){
    const b = getBrand();
    $("brandTitleInput").value = b.title;
    $("brandTaglineInput").value = b.tagline;
    $("profileLabelInput").value = b.profileLabel;
    $("accentColor").value = b.accent;
    $("accent2Color").value = b.accent2;
    $("bgColor").value = b.bg;
    $("cardColor").value = b.card;
    applyBrand(b);

    $("brandTitleInput").addEventListener("input", (e)=> saveBrand({ title: e.target.value }));
    $("brandTaglineInput").addEventListener("input", (e)=> saveBrand({ tagline: e.target.value }));
    $("profileLabelInput").addEventListener("input", (e)=> saveBrand({ profileLabel: e.target.value }));
    $("accentColor").addEventListener("input", (e)=> saveBrand({ accent: e.target.value }));
    $("accent2Color").addEventListener("input", (e)=> saveBrand({ accent2: e.target.value }));
    $("bgColor").addEventListener("input", (e)=> saveBrand({ bg: e.target.value }));
    $("cardColor").addEventListener("input", (e)=> saveBrand({ card: e.target.value }));

    $("logoUpload").addEventListener("change", (e)=>{
      readImageFile(e.target, (data)=> saveBrand({ logo: data }));
    });
    $("avatarUpload").addEventListener("change", (e)=>{
      readImageFile(e.target, (data)=> saveBrand({ avatar: data }));
    });
  }

  function renderLoginBrand(){
    const b = getBrand();
    if(b.logo){
      $("loginLogoImg").src = b.logo;
      $("loginLogoImg").classList.remove("hidden");
    }else{
      $("loginLogoImg").classList.add("hidden");
    }
  }

  // ====== Social Connections (placeholder) ======
  const SOCIAL_PLATFORMS = ["Instagram", "Facebook", "TikTok", "LinkedIn", "YouTube", "X"];

  function getSocial(){
    return loadJSON(KEY.social, {});
  }

  function getSocialProfile(){
    return loadJSON(KEY.socialProfile, {});
  }

  function setSocialProfile(platform, profile){
    const next = { ...getSocialProfile(), [platform]: profile };
    saveJSON(KEY.socialProfile, next);
    updateTiktokBadge();
    renderSocial();
  }

  function setSocial(platform, status){
    const next = { ...getSocial(), [platform]: status };
    saveJSON(KEY.social, next);
    updateTiktokBadge();
    renderSocial();
  }

  function updateTiktokBadge(){
    const badge = $("tiktokBadge");
    if(!badge) return;
    const state = getSocial();
    const profiles = getSocialProfile();
    const status = state["TikTok"] || "Not connected";
    const name = profiles["TikTok"];
    badge.classList.remove("connected","needs","error");
    if(status === "Connected") badge.classList.add("connected");
    if(status === "Needs setup") badge.classList.add("needs");
    if(status === "Error") badge.classList.add("error");
    badge.textContent = name ? `TikTok: ${status} • ${name}` : `TikTok: ${status}`;
  }

  function connectSocial(platform){
    if(platform === "TikTok"){
      window.location.href = "/api/tiktok/connect";
      return;
    }
    alert(`${platform} connection requires a backend OAuth flow and API keys. I can wire it up once you’re ready.`);
    setSocial(platform, "Needs setup");
  }

  async function disconnectSocial(platform){
    if(!confirm(`Disconnect ${platform}?`)) return;
    if(platform === "TikTok"){
      await fetch("/api/tiktok/disconnect", { method: "POST" });
      setSocial(platform, "Not connected");
      setSocialProfile(platform, "");
      updateTiktokBadge();
      const liveOut = $("liveOut");
      if(liveOut) liveOut.textContent = "Connect TikTok to see live data.";
      const liveKpi = $("liveKpi");
      if(liveKpi) liveKpi.innerHTML = "";
      return;
    }
    setSocial(platform, "Not connected");
    setSocialProfile(platform, "");
  }

  async function switchSocial(platform){
    await disconnectSocial(platform);
    connectSocial(platform);
  }

  function isTikTokConnected(){
    const state = getSocial();
    return state["TikTok"] === "Connected";
  }

  let settingsSyncTimer = null;
  function scheduleSettingsSync(){
    if(!isTikTokConnected()) return;
    if(settingsSyncTimer) clearTimeout(settingsSyncTimer);
    settingsSyncTimer = setTimeout(async ()=>{
      const payload = {
        brand: getBrand(),
        layout: getLayout(),
        theme: localStorage.getItem(KEY.theme) || "dark",
        motion: localStorage.getItem(KEY.motion) || "full",
        glass: localStorage.getItem(KEY.glass),
        blur: localStorage.getItem(KEY.blur)
      };
      await fetch("/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }, 500);
  }

  function applyTheme(theme){
    if(theme === "light"){
      document.body.classList.add("light");
      $("themeToggleBtn").textContent = "Dark Mode";
    }else{
      document.body.classList.remove("light");
      $("themeToggleBtn").textContent = "Light Mode";
    }
    localStorage.setItem(KEY.theme, theme);
  }

  function toggleTheme(){
    const isLight = document.body.classList.contains("light");
    applyTheme(isLight ? "dark" : "light");
    scheduleSettingsSync();
  }

  function applyMotion(pref){
    if(pref === "reduce"){
      document.body.classList.add("reduce-motion");
      $("toggleMotion").checked = true;
    }else{
      document.body.classList.remove("reduce-motion");
      $("toggleMotion").checked = false;
    }
    localStorage.setItem(KEY.motion, pref);
  }

  function applyGlass(value){
    const v = Math.max(0.01, Math.min(0.3, Number(value)));
    document.documentElement.style.setProperty("--glass-opacity", v.toFixed(3));
    document.documentElement.style.setProperty("--glass-strong-opacity", Math.min(0.6, v * 2.1).toFixed(3));
    document.documentElement.style.setProperty("--glass-border-opacity", Math.min(0.28, v * 7).toFixed(3));
    const highlight = Math.min(0.7, Math.max(0.18, v * 8));
    document.documentElement.style.setProperty("--glass-highlight-opacity", highlight.toFixed(3));
    localStorage.setItem(KEY.glass, String(v));
    const display = $("glassValue");
    const slider = $("glassSlider");
    if(display) display.value = v.toFixed(3);
    if(slider) slider.value = v.toFixed(3);
  }

  function applyBlur(value){
    const v = Math.max(6, Math.min(28, Number(value)));
    document.documentElement.style.setProperty("--blur", `${v}px`);
    localStorage.setItem(KEY.blur, String(v));
    const display = $("blurValue");
    const slider = $("blurSlider");
    if(display) display.value = `${v}`;
    if(slider) slider.value = `${v}`;
  }

  async function loadSettingsFromServer(){
    if(!isTikTokConnected()) return;
    const res = await fetch("/api/settings", { cache: "no-store" }).catch(()=>null);
    if(!res || !res.ok) return;
    const data = await res.json().catch(()=>null);
    if(!data || !data.data) return;

    if(data.data.brand){
      saveJSON(KEY.brand, data.data.brand);
      applyBrand(getBrand());
      renderLoginBrand();
    }
    if(data.data.layout){
      saveJSON(KEY.layout, data.data.layout);
      restoreLayout();
    }
    if(data.data.theme){
      applyTheme(data.data.theme);
    }
    if(data.data.motion){
      applyMotion(data.data.motion);
    }
    if(data.data.glass){
      applyGlass(data.data.glass);
    }
    if(data.data.blur){
      applyBlur(data.data.blur);
    }
  }

  function renderSocial(){
    const state = getSocial();
    const profiles = getSocialProfile();
    const root = $("socialList");
    root.innerHTML = "";
    renderConnectedBadge();
    SOCIAL_PLATFORMS.forEach(p=>{
      const status = state[p] || "Not connected";
      const profile = profiles[p] || "";
      const label = profile ? `${status} • ${profile}` : status;
      const row = document.createElement("div");
      row.className = "social-item";
      row.innerHTML = `
        <div>
          <b>${p}</b> • <span>${label}</span>
        </div>
        <div class="pillrow">
          <button onclick="connectSocial('${p}')">Connect</button>
          <button onclick="disconnectSocial('${p}')">Disconnect</button>
          <button onclick="switchSocial('${p}')">Switch</button>
        </div>
      `;
      root.appendChild(row);
    });
    updateTiktokBadge();
  }

  // ====== Layout (drag to reorder + snap resize) ======
  const DEFAULT_LAYOUT = {
    order: ["inputs", "ideas", "plan", "live"],
    spans: {
      inputs: { c: 6, r: 22 },
      ideas: { c: 6, r: 22 },
      plan: { c: 12, r: 10 },
      live: { c: 12, r: 22 }
    },
    hidden: {
      inputs: false,
      ideas: false,
      plan: false,
      live: false
    }
  };
  let draggedId = null;

  function getLayout(){
    const saved = loadJSON(KEY.layout, {});
    return {
      ...DEFAULT_LAYOUT,
      ...saved,
      spans: { ...DEFAULT_LAYOUT.spans, ...(saved.spans || {}) },
      hidden: { ...DEFAULT_LAYOUT.hidden, ...(saved.hidden || {}) }
    };
  }

  function applySectionSize(el, colSpan, rowSpan){
    el.style.gridColumn = `span ${colSpan}`;
    el.style.gridRow = `span ${rowSpan}`;
  }

  function saveLayout(){
    const root = $("sections");
    if(!root) return;
    const ids = Array.from(root.querySelectorAll(".section")).map(el=>el.dataset.section);
    const spans = {};
    const hidden = {};
    Array.from(root.querySelectorAll(".section")).forEach(el=>{
      spans[el.dataset.section] = {
        c: Number(el.dataset.colSpan || 12),
        r: Number(el.dataset.rowSpan || 12)
      };
      hidden[el.dataset.section] = el.classList.contains("hidden");
    });
    saveJSON(KEY.layout, { order: ids, spans, hidden });
    scheduleSettingsSync();
  }

  function restoreLayout(){
    const root = $("sections");
    if(!root) return;
    const layout = getLayout();
    const order = layout.order;
    if(order && Array.isArray(order)){
      order.forEach(id=>{
        const el = root.querySelector(`.section[data-section="${id}"]`);
        if(el) root.appendChild(el);
      });
    }
    const spans = layout.spans || {};
    const hidden = layout.hidden || {};
    Array.from(root.querySelectorAll(".section")).forEach(el=>{
      const id = el.dataset.section;
      const span = spans[id] || DEFAULT_LAYOUT.spans[id] || { c: 12, r: 12 };
      el.dataset.colSpan = span.c;
      el.dataset.rowSpan = span.r;
      applySectionSize(el, span.c, span.r);
      if(hidden[id]) el.classList.add("hidden");
      else el.classList.remove("hidden");
    });
  }

  function initDrag(){
    const root = $("sections");
    if(!root) return;
    const sections = Array.from(root.querySelectorAll(".section"));
    const handles = Array.from(root.querySelectorAll(".drag-handle"));
    const scrollThreshold = 80;
    const scrollSpeed = 18;
    let placeholder = null;

    handles.forEach(h=>{
      h.addEventListener("dragstart", (e)=>{
        const section = h.closest(".section");
        if(!section) return;
        draggedId = section.dataset.section || null;
        e.dataTransfer?.setData("text/plain", draggedId || "");
        e.dataTransfer?.setDragImage(section, 20, 20);
        section.classList.add("dragging");
        placeholder = document.createElement("div");
        placeholder.className = "section drag-placeholder";
        placeholder.style.gridColumn = section.style.gridColumn || "span 12";
        placeholder.style.gridRow = section.style.gridRow || "span 10";
        section.parentElement?.insertBefore(placeholder, section.nextSibling);
      });
    });

    sections.forEach(sec=>{
      sec.addEventListener("dragover", (e)=>{
        e.preventDefault();
        sec.classList.add("drag-over");
        if(!draggedId) return;
        const dragged = root.querySelector(`.section[data-section="${draggedId}"]`);
        if(!dragged || dragged === sec) return;
        const rect = sec.getBoundingClientRect();
        const before = e.clientY < rect.top + rect.height / 2;
        sec.classList.toggle("hover-top", before);
        sec.classList.toggle("hover-bottom", !before);
        if(before){
          root.insertBefore(dragged, sec);
        }else{
          root.insertBefore(dragged, sec.nextSibling);
        }
        saveLayout();
      });
      sec.addEventListener("dragleave", ()=>{
        sec.classList.remove("drag-over");
        sec.classList.remove("hover-top");
        sec.classList.remove("hover-bottom");
      });
      sec.addEventListener("drop", (e)=>{
        e.preventDefault();
        sec.classList.remove("drag-over");
        sec.classList.remove("hover-top");
        sec.classList.remove("hover-bottom");
        draggedId = null;
      });
    });

    root.addEventListener("dragend", ()=>{
      const dragged = root.querySelector(".section.dragging");
      if(dragged) dragged.classList.remove("dragging");
      if(placeholder){
        placeholder.remove();
        placeholder = null;
      }
      draggedId = null;
      root.querySelectorAll(".section").forEach(sec=>{
        sec.classList.remove("hover-top","hover-bottom","drag-over");
      });
    });

    window.addEventListener("dragover", (e)=>{
      const y = e.clientY;
      if(y < scrollThreshold){
        window.scrollBy({ top: -scrollSpeed, behavior: "auto" });
      }else if(window.innerHeight - y < scrollThreshold){
        window.scrollBy({ top: scrollSpeed, behavior: "auto" });
      }
    });
  }

  function initResize(){
    const root = $("sections");
    if(!root) return;
    const cols = 12;
    const gap = 16;
    const rowHeight = 24;
    const minCols = 3;
    const maxCols = 12;
    const minRows = 8;
    const maxRows = 40;

    let active = null;

    root.querySelectorAll(".resize-handle").forEach(handle=>{
      handle.addEventListener("pointerdown", (e)=>{
        e.preventDefault();
        const section = handle.closest(".section");
        if(!section) return;
        active = section;
        handle.setPointerCapture(e.pointerId);
      });

      handle.addEventListener("pointermove", (e)=>{
        if(!active) return;
        const gridRect = root.getBoundingClientRect();
        const rect = active.getBoundingClientRect();
        const colWidth = (gridRect.width - gap * (cols - 1)) / cols;
        const colSpan = Math.max(
          minCols,
          Math.min(
            maxCols,
            Math.round((e.clientX - rect.left + colWidth / 2) / (colWidth + gap))
          )
        );
        const rowSpan = Math.max(
          minRows,
          Math.min(
            maxRows,
            Math.round((e.clientY - rect.top + rowHeight / 2) / (rowHeight + gap))
          )
        );
        active.dataset.colSpan = colSpan;
        active.dataset.rowSpan = rowSpan;
        applySectionSize(active, colSpan, rowSpan);
      });

      handle.addEventListener("pointerup", ()=>{
        if(active){
          saveLayout();
          active = null;
        }
      });
    });
  }

  function applyPreset(name){
    const root = $("sections");
    if(!root) return;
    if(name === "analytics"){
      const preset = {
        order: ["live", "plan", "ideas", "inputs"],
        spans: {
          live: { c: 12, r: 26 },
          plan: { c: 12, r: 10 },
          ideas: { c: 6, r: 18 },
          inputs: { c: 6, r: 18 }
        },
        hidden: {
          inputs: true,
          ideas: false,
          plan: false,
          live: false
        }
      };
      saveJSON(KEY.layout, preset);
    }
    if(name === "two-column"){
      const preset = {
        order: ["inputs", "ideas", "plan", "live"],
        spans: {
          inputs: { c: 6, r: 22 },
          ideas: { c: 6, r: 22 },
          plan: { c: 12, r: 10 },
          live: { c: 12, r: 22 }
        },
        hidden: {
          inputs: false,
          ideas: false,
          plan: false,
          live: false
        }
      };
      saveJSON(KEY.layout, preset);
    }
    restoreLayout();
    updateVisibilityToggles();
    saveLayout();
  }

  function resetLayout(){
    saveJSON(KEY.layout, DEFAULT_LAYOUT);
    restoreLayout();
    updateVisibilityToggles();
    saveLayout();
  }

  function updateVisibilityToggles(){
    const layout = getLayout();
    const hidden = layout.hidden || {};
    $("toggleInputs").checked = !hidden.inputs;
    $("toggleIdeas").checked = !hidden.ideas;
    $("togglePlan").checked = !hidden.plan;
    $("toggleLive").checked = !hidden.live;
  }

  function bindVisibilityToggles(){
    const map = {
      toggleInputs: "inputs",
      toggleIdeas: "ideas",
      togglePlan: "plan",
      toggleLive: "live"
    };
    Object.keys(map).forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener("change", ()=>{
        const sectionId = map[id];
        const section = document.querySelector(`.section[data-section="${sectionId}"]`);
        if(!section) return;
        section.classList.toggle("hidden", !el.checked);
        saveLayout();
      });
    });
  }

  function bindMotionToggle(){
    const el = $("toggleMotion");
    if(!el) return;
    el.addEventListener("change", ()=>{
      applyMotion(el.checked ? "reduce" : "full");
      scheduleSettingsSync();
    });
  }

  function bindGlassSlider(){
    const slider = $("glassSlider");
    if(!slider) return;
    slider.addEventListener("input", ()=>{
      applyGlass(slider.value);
      scheduleSettingsSync();
    });
  }

  function bindBlurSlider(){
    const slider = $("blurSlider");
    if(!slider) return;
    slider.addEventListener("input", ()=>{
      applyBlur(slider.value);
      scheduleSettingsSync();
    });
  }

  function openSettings(){
    $("settingsModal").classList.add("open");
  }
  function closeSettings(){
    $("settingsModal").classList.remove("open");
  }

  function toggleLayout(){
    document.body.classList.toggle("layout-locked");
    const locked = document.body.classList.contains("layout-locked");
    $("layoutToggleBtn").textContent = locked ? "Customize Layout" : "Lock Layout";
  }

  // ====== Live Analytics (TikTok) ======
  async function loadLiveAnalytics(){
    const out = $("liveOut");
    const kpi = $("liveKpi");
    const list = $("liveRecs");
    const best = $("bestTimes");
    const snapshots = $("snapshotList");
    out.textContent = "Loading live analytics...";
    kpi.innerHTML = "";
    list.innerHTML = "";
    best.innerHTML = "";
    snapshots.innerHTML = "";

    try{
      await fetch("/api/tiktok/snapshot", { method: "POST" });
      const res = await fetch("/api/tiktok/analytics", { cache: "no-store" });
      const data = await res.json();

      if(data.status === "not_connected"){
        out.textContent = data.message || "Connect TikTok to retrieve live analytics.";
        return;
      }
      if(data.status === "error"){
        out.textContent = data.message || "Unable to load analytics.";
        return;
      }

      const metrics = data.metrics || {};
      kpi.innerHTML = `
        <div class="box">
          <div class="big">${(metrics.totalViews || 0).toLocaleString()}</div>
          <div class="small">Total Views (latest posts)</div>
        </div>
        <div class="box">
          <div class="big">${((metrics.engagementRate || 0) * 100).toFixed(1)}%</div>
          <div class="small">Engagement Rate</div>
        </div>
        <div class="box">
          <div class="big">${(metrics.views7d || 0).toLocaleString()}</div>
          <div class="small">Views (last 7 days)</div>
        </div>
      `;

      const top = data.topPost;
      const user = data.user || {};
      if(user.display_name){
        setSocial("TikTok", "Connected");
        setSocialProfile("TikTok", user.display_name);
        renderConnectedBadge();
        loadSettingsFromServer();
      }
      const topLine = top
        ? `Top post: ${top.title || "Untitled"} — ${top.view_count || 0} views`
        : "Top post: —";

      out.textContent =
`TikTok Live Snapshot
Creator: ${user.display_name || "—"}
${topLine}
Average Views: ${(metrics.avgViews || 0).toLocaleString()}
Total Posts: ${(metrics.totalVideos || 0).toLocaleString()}`;

      const recs = data.recommendations || [];
      if(recs.length){
        recs.forEach(r=>{
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = r;
          list.appendChild(div);
        });
      }

      const times = data.bestTimes || [];
      if(times.length){
        times.forEach(t=>{
          const div = document.createElement("div");
          div.className = "item";
          const hourLabel = String(t.hour).padStart(2,"0") + ":00";
          div.textContent = `${hourLabel} — ${(t.engagementRate * 100).toFixed(1)}% ER across ${t.posts} posts`;
          best.appendChild(div);
        });
      }else{
        best.innerHTML = `<div class="sub">Not enough data yet to recommend a time.</div>`;
      }

      const snap = data.snapshots || [];
      if(snap.length){
        snap.forEach(s=>{
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = `${s.snapshot_date}: ${Number(s.total_views).toLocaleString()} views • ${(Number(s.engagement_rate) * 100).toFixed(1)}% ER`;
          snapshots.appendChild(div);
        });
      }else{
        snapshots.innerHTML = `<div class="sub">No snapshots yet.</div>`;
      }
    }catch(e){
      out.textContent = "Failed to load analytics. Try again.";
    }
  }

  // ====== Metrics ======
  function getMetrics(){ return loadJSON(KEY.metrics, []); }

  function saveMetric(){
    const m = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      date: $("mDate").value || todayISO,
      platform: $("mPlatform").value,
      type: $("mType").value,
      views: safeNum($("mViews").value),
      likes: safeNum($("mLikes").value),
      comments: safeNum($("mComments").value),
      saves: safeNum($("mSaves").value),
      shares: safeNum($("mShares").value),
      visits: safeNum($("mVisits").value),
      hook: $("mHook").value.trim(),
      notes: $("mNotes").value.trim()
    };

    const list = getMetrics();
    list.unshift(m);
    saveJSON(KEY.metrics, list);

    // clear a few fields
    ["mViews","mLikes","mComments","mSaves","mShares","mVisits","mHook","mNotes"].forEach(id=>$(id).value="");
    renderMetrics();
    renderKPIs();
  }

  function clearMetrics(){
    if(!confirm("Clear all saved metrics?")) return;
    saveJSON(KEY.metrics, []);
    $("perfOut").textContent = "Performance summary will appear here.";
    renderMetrics();
    renderKPIs();
  }

  function deleteMetric(id){
    const list = getMetrics().filter(x=>x.id!==id);
    saveJSON(KEY.metrics, list);
    renderMetrics();
    renderKPIs();
  }

  function renderMetrics(){
    const list = getMetrics();
    const root = $("metricList");
    root.innerHTML = "";
    list.slice(0, 12).forEach(m=>{
      const div = document.createElement("div");
      div.className = "item";
      const er = engagementRate(m);
      div.innerHTML = `
        <div class="meta">
          <span class="tag2">${m.platform}</span>
          <span class="tag">${m.type}</span>
          <span>${m.date}</span>
          <span>ER: <b>${(er*100).toFixed(1)}%</b></span>
        </div>
        <div style="margin-top:8px; font-weight:800">${m.views.toLocaleString()} views</div>
        <div class="meta" style="margin-top:6px">
          <span>❤️ ${m.likes}</span>
          <span>💬 ${m.comments}</span>
          <span>🔖 ${m.saves}</span>
          <span>↗️ ${m.shares}</span>
          <span>👤 ${m.visits}</span>
        </div>
        <div style="margin-top:8px; color: var(--muted); font-size:12px">
          <div><span class="mono">Hook:</span> ${escapeHtml(m.hook || "—")}</div>
          <div><span class="mono">Notes:</span> ${escapeHtml(m.notes || "—")}</div>
        </div>
        <div class="pillrow" style="margin-top:10px">
          <button onclick="deleteMetric('${m.id}')">Delete</button>
        </div>
      `;
      root.appendChild(div);
    });

    if(list.length === 0){
      root.innerHTML = `<div class="sub">No metrics saved yet. Add your first post stats above.</div>`;
    }
  }

  function engagementRate(m){
    const interactions = (m.likes + m.comments + m.saves + m.shares);
    return m.views > 0 ? interactions / m.views : 0;
  }

  function renderKPIs(){
    const list = getMetrics();
    const last7 = list.filter(m=>{
      const dt = new Date(m.date + "T00:00:00");
      const diffDays = (new Date() - dt) / (1000*60*60*24);
      return diffDays <= 7.5;
    });

    const sum = (arr, key)=> arr.reduce((a,x)=> a + safeNum(x[key]), 0);
    const totalViews = sum(last7, "views");
    const totalLikes = sum(last7, "likes");
    const totalComments = sum(last7, "comments");
    const totalSaves = sum(last7, "saves");
    const totalShares = sum(last7, "shares");

    const er = totalViews ? (totalLikes+totalComments+totalSaves+totalShares)/totalViews : 0;

    const root = $("kpiRow");
    root.innerHTML = `
      <div class="box">
        <div class="big">${totalViews.toLocaleString()}</div>
        <div class="small">Views (last 7 days)</div>
      </div>
      <div class="box">
        <div class="big">${((er||0)*100).toFixed(1)}%</div>
        <div class="small">Engagement Rate</div>
      </div>
      <div class="box">
        <div class="big">${(totalSaves+totalShares).toLocaleString()}</div>
        <div class="small">Saves + Shares</div>
      </div>
    `;
  }

  function summarizePerformance(){
    const list = getMetrics();
    if(list.length === 0){
      $("perfOut").textContent = "Add at least 1 metric entry first.";
      return;
    }

    const top = [...list].sort((a,b)=> engagementRate(b)-engagementRate(a)).slice(0,3);
    const weak = [...list].sort((a,b)=> engagementRate(a)-engagementRate(b)).slice(0,2);

    const bestTypes = countBy(list, "type");
    const bestHooks = top.map(m=>m.hook).filter(Boolean).slice(0,3);

    const insight =
`WHAT’S WORKING (based on your logged posts)
• Best post types lately: ${topKeys(bestTypes).join(", ") || "—"}
• Top hooks to repeat:
${bestHooks.length ? bestHooks.map(h=>"  - "+h).join("\n") : "  - (add hooks in your metric logs)"}

WHAT TO IMPROVE
• Lowest ER examples:
${weak.map(m=>`  - ${m.platform} ${m.type} on ${m.date} (ER ${(engagementRate(m)*100).toFixed(1)}%)`).join("\n")}

NEXT ACTIONS (simple)
1) Re-post your top-performing structure with a new job/topic (same hook pattern).
2) Add a clear CTA in the last 3 seconds: "${($("cta").value || "DM me and I’ll send pricing / next steps").trim()}".
3) Turn 1 winning video into: 1 short clip (15s), 1 full (60–90s), 1 carousel (IG), 1 story (IG).`;

    $("perfOut").textContent = insight;
  }

  function countBy(arr, key){
    return arr.reduce((m,x)=>{
      const k = x[key] || "—";
      m[k] = (m[k]||0)+1;
      return m;
    },{});
  }
  function topKeys(map){
    return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]);
  }

  // ====== Ideas ======
  function getIdeaContext(){
    saveInputs();
    const i = getInputs();
    return {
      ...i,
      pillar: $("pillar").value,
      topic: $("topic").value.trim(),
      audience: $("audience").value
    };
  }

  function setOut(text){
    $("ideaOut").textContent = text;
  }

  function generateHooks(){
    const c = getIdeaContext();
    const topic = c.topic ? `Topic: ${c.topic}` : `Topic: (use your current job / walkthrough)`;
    const hooks = [
      `“If you’re buying a home, watch this BEFORE you close…”`,
      `“This is the #1 mistake I see on ${c.pillar.toLowerCase()} jobs…”`,
      `“Here’s what this would cost IF you did it the right way…”`,
      `“I’m about to show you what most contractors won’t point out…”`,
      `“This is why your paint/job fails in 12–24 months…”`,
      `“3 things I look for in the first 60 seconds of a walkthrough…”`,
      `“Stop doing this to your house — it’s costing you thousands.”`,
      `“I’m not trying to scare you… but this is a real problem.”`
    ];

    setOut(
`HOOKS (${c.platform} • ${c.voice} • ${c.length})
Brand: ${c.brandName || "—"} | Market: ${c.market || "—"}
Pillar: ${c.pillar} | Audience: ${c.audience}
${topic}

Pick 1 hook and deliver it in the first 2 seconds:
${hooks.map((h,i)=>`${i+1}) ${h}`).join("\n")}

Quick CTA add-on:
“${c.cta || "DM me and I’ll send the next steps."}”`
    );
  }

  function generateScripts(){
    const c = getIdeaContext();
    const jobLine = c.topic ? `Job/Topic: ${c.topic}` : `Job/Topic: (add your current job here)`;
    const script =
`SCRIPT TEMPLATE (60–90s • ${c.style})
1) Hook (0–2s): [pick a hook]
2) Context (2–8s): “We’re at a home in ${c.market || "your area"} and I’m doing a quick ${c.pillar.toLowerCase()} walkthrough.”
3) The Problem (8–25s): Show 1–2 issues. Explain risk in simple terms.
4) The Fix (25–55s): Explain your process:
   • Prep (protect + cover + repair)
   • Correct materials (primer / caulk / proper products)
   • Clean finish (2 coats, edges, details)
5) Proof (55–75s): Show close-ups, texture, before/after, or estimate checklist.
6) CTA (last 10s): “${c.cta || "DM me for a quote or walkthrough."}”

B-ROLL SHOT LIST
• Wide front elevation • Close-up texture • Problem area • Material/tool shot • You talking to camera • Detail finish

ON-CAMERA LINES (use 2–3)
• “I’m going to show you exactly what we’d do here.”
• “This is what makes the difference between average and high-end.”
• “If you like how this looks, DM me and I’ll send details.”

${jobLine}
Services to weave in: ${c.services || "—"}`
    ;
    setOut(script);
  }

  function generateCaptions(){
    const c = getIdeaContext();
    const caps = [
      `Walkthrough time 🔍 If you’re buying this home, here’s what I’d fix first. ${c.cta || "DM me for details."}`,
      `This is how we keep it looking new — not “good for now.” ${c.cta || "DM me."}`,
      `Quick estimate walkthrough in ${c.market || "your area"} — what would you change on this exterior?`,
      `Luxury finish is all in the prep. Here’s the checklist we follow every time.`,
      `If you like the way this home looks, message me — I can connect you with the agent + help with the work.`
    ];

    setOut(
`CAPTION OPTIONS (${c.platform})
1) ${caps[0]}
2) ${caps[1]}
3) ${caps[2]}
4) ${caps[3]}
5) ${caps[4]}

COMMENT PROMPT (boost engagement)
• “Want me to price this out on camera? Comment ‘QUOTE’.”`
    );
  }

  function generateHashtags(){
    const c = getIdeaContext();
    const base = [
      "#homeimprovement", "#contractor", "#remodel", "#realestate", "#beforeandafter",
      "#exteriordesign", "#homeowners", "#renovation", "#diyvspro", "#propertymanagement"
    ];
    const local = c.market?.toLowerCase().includes("san diego")
      ? ["#sandiego", "#northcountysd", "#carlsbad", "#encinitas"]
      : ["#phoenix", "#tempe", "#chandler", "#eastvalley"];
    const niche =
      c.pillar.includes("Painting") ? ["#exteriorpainting", "#housepainting", "#stucco"] :
      c.pillar.includes("Electrical") ? ["#electrician", "#homesafety"] :
      c.pillar.includes("Luxury") ? ["#luxuryhomes", "#highendhomes"] :
      ["#walkthrough", "#contractorlife"];

    setOut(
`HASHTAGS (mix 8–14 total)
Local: ${local.join(" ")}
Niche: ${niche.join(" ")}
Base: ${base.slice(0,8).join(" ")}

Tip: rotate 3–5 hashtags each post so you don’t look spammy.`
    );
  }

  function generateAll(){
    // bundle output
    generateHooks();
    const hooks = $("ideaOut").textContent;
    generateScripts();
    const script = $("ideaOut").textContent;
    generateCaptions();
    const caps = $("ideaOut").textContent;
    generateHashtags();
    const tags = $("ideaOut").textContent;

    setOut(`${hooks}\n\n---\n\n${script}\n\n---\n\n${caps}\n\n---\n\n${tags}`);
  }

  function getIdeas(){ return loadJSON(KEY.ideas, []); }

  function saveIdea(){
    const text = $("ideaOut").textContent.trim();
    if(!text || text.includes("Click a generator button")){ alert("Generate something first."); return; }
    const c = getIdeaContext();
    const item = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
      created: new Date().toISOString(),
      pillar: c.pillar,
      platform: c.platform,
      audience: c.audience,
      topic: c.topic || "—",
      text
    };
    const list = getIdeas();
    list.unshift(item);
    saveJSON(KEY.ideas, list);
    renderIdeas();
  }

  function clearIdeas(){
    if(!confirm("Clear all saved ideas?")) return;
    saveJSON(KEY.ideas, []);
    renderIdeas();
  }

  function deleteIdea(id){
    const list = getIdeas().filter(x=>x.id!==id);
    saveJSON(KEY.ideas, list);
    renderIdeas();
  }

  function renderIdeas(){
    const list = getIdeas();
    const root = $("ideaList");
    root.innerHTML = "";
    list.slice(0, 10).forEach(i=>{
      const div = document.createElement("div");
      div.className = "item";
      const when = new Date(i.created).toLocaleString();
      div.innerHTML = `
        <div class="meta">
          <span class="tag2">${i.platform}</span>
          <span class="tag">${i.pillar}</span>
          <span>${when}</span>
        </div>
        <div style="margin-top:8px; color:var(--muted); font-size:12px">
          <b>Topic:</b> ${escapeHtml(i.topic)}
        </div>
        <div class="out mono" style="margin-top:10px; min-height:auto">${escapeHtml(i.text)}</div>
        <div class="pillrow" style="margin-top:10px">
          <button onclick="copyText(${JSON.stringify(i.text)})">Copy</button>
          <button onclick="deleteIdea('${i.id}')">Delete</button>
        </div>
      `;
      root.appendChild(div);
    });

    if(list.length === 0){
      root.innerHTML = `<div class="sub">No saved ideas yet. Generate output and click “Save Output”.</div>`;
    }
  }

  // ====== 7-day plan ======
  function build7DayPlan(){
    const i = getInputs();
    const metrics = getMetrics();
    const topType = topKeys(countBy(metrics, "type"))[0] || "Walkthrough";
    const plan =
`7-DAY POSTING PLAN (repeat what works + build demand)
Brand: ${i.brandName || "—"} | Market: ${i.market || "—"} | Platforms: ${i.platform}
Goal: ${i.goal || "—"}

DAY 1: ${topType} — “Problem → Fix”
• Hook: “If you’re buying a home, watch this before you close…”
• CTA: ${i.cta || "DM me for details."}

DAY 2: Tip video (15–25s)
• “3 things to check before hiring anyone”

DAY 3: Behind-the-scenes (tools + materials)
• Show prep, masking, products, why you choose them (luxury finish)

DAY 4: Walkthrough estimate (60–90s)
• “What this would cost if done right” (steps/ranges)

DAY 5: Client win / before-after
• Show transformation + quick story

DAY 6: Realtor / property manager angle
• “How we turn a unit/home fast without cutting corners”

DAY 7: Brand deal bait
• “Here’s what I’d improve about this product if I was using it daily…”

Daily rule:
• Ask 1 question in every caption to force comments.
• Pin your best comment reply as a mini sales pitch.
`;
    $("planOut").textContent = plan;
    saveJSON(KEY.plan, plan);
  }

  function copyPlan(){
    const t = $("planOut").textContent.trim();
    if(!t) return;
    navigator.clipboard.writeText(t);
    alert("Plan copied.");
  }

  function clearPlan(){
    $("planOut").textContent = "Your plan will appear here.";
    localStorage.removeItem(KEY.plan);
  }

  // ====== Export ======
  function exportData(){
    const blob = new Blob([JSON.stringify({
      inputs: loadJSON(KEY.inputs, {}),
      metrics: loadJSON(KEY.metrics, []),
      ideas: loadJSON(KEY.ideas, []),
      plan: loadJSON(KEY.plan, "")
    }, null, 2)], {type:"application/json"});

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "marketing-assistant-export.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ====== Utilities ======
  function copyText(t){
    navigator.clipboard.writeText(t);
    alert("Copied.");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function hydrate(){
    renderLoginBrand();
    hydrateInputs();
    hydrateBrand();
    restoreLayout();
    initDrag();
    initResize();
    bindVisibilityToggles();
    updateVisibilityToggles();
    bindMotionToggle();
    bindGlassSlider();
    bindBlurSlider();
    renderMetrics();
    renderKPIs();
    renderIdeas();
    renderSocial();
    applyTheme(localStorage.getItem(KEY.theme) || "dark");
    applyMotion(localStorage.getItem(KEY.motion) || "full");
    applyGlass(localStorage.getItem(KEY.glass) || (document.body.classList.contains("light") ? "0.22" : "0.022"));
    applyBlur(localStorage.getItem(KEY.blur) || "18");

    const savedPlan = loadJSON(KEY.plan, "");
    if(savedPlan) $("planOut").textContent = savedPlan;

    const params = new URLSearchParams(window.location.search);
    const tiktok = params.get("tiktok");
    const message = params.get("message");
    if(tiktok === "connected"){
      setSocial("TikTok", "Connected");
      renderConnectedBadge();
      loadSettingsFromServer();
      loadLiveAnalytics();
    }else if(tiktok === "missing-config"){
      setSocial("TikTok", "Needs setup");
      if(message) $("liveOut").textContent = decodeURIComponent(message);
    }else if(tiktok === "error"){
      setSocial("TikTok", "Error");
      if(message) $("liveOut").textContent = decodeURIComponent(message);
    }
    if(tiktok){
      const url = new URL(window.location.href);
      url.searchParams.delete("tiktok");
      url.searchParams.delete("message");
      window.history.replaceState({}, "", url.toString());
    }
  }

  // Auto-set date on load
  window.addEventListener("load", ()=>{
    $("mDate").value = todayISO;
    document.body.classList.add("layout-locked");
    $("layoutToggleBtn").textContent = "Customize Layout";
    renderLoginBrand();
    applyTheme(localStorage.getItem(KEY.theme) || "dark");
    applyMotion(localStorage.getItem(KEY.motion) || "full");
    applyGlass(localStorage.getItem(KEY.glass) || (document.body.classList.contains("light") ? "0.22" : "0.022"));
    applyBlur(localStorage.getItem(KEY.blur) || "18");
    if(localStorage.getItem(KEY.session) === "1"){
      $("loginView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      setTodayLine();
      hydrate();
    }
  });
</script>
</body>
</html>
